import{u as se,a as D,j as t,b as ae,f as E,c as i,i as T,s as le,w as ne}from"./index-CREAv5lR.js";import{u as re,r as a}from"./vendor-react-DWtYaMjq.js";import{aa as $,aq as ce,s as ie,P as w,N as oe,S as de,X as me,am as xe,a7 as ue,z as he,ai as pe,q as ge,ar as be,as as fe,W as je,ad as Ne,at as ve}from"./vendor-icons-BFVyu274.js";const C=["Panier","En attente","Commandée","Reçu","En réparation","Donné au client","Clôturé"],F=["Donné au client","Clôturé"],we={Panier:{bg:"bg-gray-50",text:"text-gray-700",border:"border-gray-300",color:"#6b7280",icon:ve},"En attente":{bg:"bg-amber-50",text:"text-amber-700",border:"border-amber-300",color:"#d97706",icon:Ne},Commandée:{bg:"bg-blue-50",text:"text-blue-700",border:"border-blue-300",color:"#2563eb",icon:w},Reçu:{bg:"bg-green-50",text:"text-green-700",border:"border-green-300",color:"#059669",icon:$},"En réparation":{bg:"bg-violet-50",text:"text-violet-700",border:"border-violet-300",color:"#7c3aed",icon:je},"Donné au client":{bg:"bg-teal-50",text:"text-teal-700",border:"border-teal-300",color:"#0d9488",icon:fe},Clôturé:{bg:"bg-slate-100",text:"text-slate-500",border:"border-slate-300",color:"#64748b",icon:be}},Ce=[{label:"Tous",value:"all"},...C.map(b=>({label:b,value:b}))];function Se(){const b=re(),{user:y}=se(),I=(y==null?void 0:y.target)==="tech"?"/tech":"/accueil",[k,B]=a.useState(""),[u,z]=a.useState(""),[o,L]=a.useState("all"),f=a.useRef(null),[U,_]=a.useState(!1),[j,A]=a.useState(null),[h,d]=a.useState(null),[q,N]=a.useState(!1),[l,v]=a.useState(null),[r,c]=a.useState({description:"",fournisseur:"",reference:"",prix:"",ticket_code:"",statut:"En attente",notes:""});a.useEffect(()=>(f.current&&clearTimeout(f.current),f.current=setTimeout(()=>z(k),300),()=>clearTimeout(f.current)),[k]),a.useEffect(()=>{if(!h)return;const e=setTimeout(()=>d(null),3e3);return()=>clearTimeout(e)},[h]);const W=a.useMemo(()=>{const e=["commandes"];return u&&e.push(`s:${u}`),e.push(`tab:${o}`),e.join(":")},[u,o]),{data:K,loading:O}=D(W,async()=>{const e={};return u&&(e.search=u),o!=="all"&&(e.statut=o),i.getParts(e)},{tags:["commandes"],ttl:6e4}),M=K??[],{data:G}=D("commandes:all:counts",()=>i.getParts({}),{tags:["commandes"],ttl:6e4}),p=G??[],X=a.useMemo(()=>{const e={all:p.length};return C.forEach(s=>{e[s]=0}),p.forEach(s=>{e[s.statut]!==void 0&&e[s.statut]++}),e},[p]),S=()=>{c({description:"",fournisseur:"",reference:"",prix:"",ticket_code:"",statut:"En attente",notes:""}),A(null),_(!1)},H=async()=>{try{const e={...r,prix:r.prix?parseFloat(r.prix):null};j?(await i.updatePart(j.id,e),d({type:"success",msg:"Commande mise à jour"})):(await i.createPart(e),d({type:"success",msg:"Commande créée"})),S(),T("commandes")}catch(e){console.error(e),d({type:"error",msg:"Erreur lors de la sauvegarde"})}},V=e=>{A(e),c({description:e.description||"",fournisseur:e.fournisseur||"",reference:e.reference||"",prix:e.prix||"",ticket_code:e.ticket_code||"",statut:e.statut||"En attente",notes:e.notes||""}),_(!0)},J=async e=>{if(confirm("Supprimer cette commande ?"))try{await i.deletePart(e),T("commandes"),d({type:"success",msg:"Commande supprimée"})}catch(s){console.error(s)}},Q=async(e,s)=>{try{await i.updatePart(e.id,{statut:s}),T("commandes"),d({type:"success",msg:`Statut → ${s}`}),s==="Reçu"&&e.client_tel&&(v(e),N(!0))}catch(n){console.error(n),d({type:"error",msg:"Erreur changement statut"})}},Y=async e=>{try{const s=await i.getTicketByCode(e);s!=null&&s.id&&b(`${I}/ticket/${s.id}`)}catch{}},P=e=>{const s=[e.client_prenom,e.client_nom].filter(Boolean).join(" ")||"client",n=[e.marque,e.modele||e.modele_autre].filter(Boolean).join(" ")||"appareil";return`Bonjour ${s}, la pièce pour votre ${n} est arrivée ! Merci de prendre rendez-vous pour la réparation. KLIKPHONE - 04 79 60 89 22`},Z=async()=>{if(!l)return;const e=P(l),s=le(l.client_tel,e);if(window.open(s,"_blank"),l.ticket_id)try{await i.addNote(l.ticket_id,"[PIÈCE] Pièce reçue — Client notifié par SMS")}catch(n){console.error("Erreur ajout note:",n)}N(!1),v(null)},ee=async()=>{if(!l)return;const e=P(l),s=ne(l.client_tel,e);if(window.open(s,"_blank"),l.ticket_id)try{await i.addNote(l.ticket_id,"[PIÈCE] Pièce reçue — Client notifié par WhatsApp")}catch(n){console.error("Erreur ajout note:",n)}N(!1),v(null)},te=()=>{N(!1),v(null)},R=e=>we[e]||{bg:"bg-slate-100",text:"text-slate-500",border:"border-slate-300",color:"#64748b",icon:w};return t.jsxs("div",{className:"p-4 sm:p-6 lg:p-8",children:[h&&t.jsx("div",{className:`fixed top-4 right-4 z-[100] px-4 py-2.5 rounded-xl shadow-lg text-sm font-medium animate-in
          ${h.type==="success"?"bg-emerald-600 text-white":"bg-red-600 text-white"}`,children:h.msg}),q&&l&&t.jsx("div",{className:"fixed inset-0 z-[110] flex items-center justify-center bg-black/40 backdrop-blur-sm",children:t.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-md mx-4 p-6 animate-in",children:[t.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[t.jsx("div",{className:"w-10 h-10 rounded-xl bg-green-100 flex items-center justify-center",children:t.jsx($,{className:"w-5 h-5 text-green-600"})}),t.jsxs("div",{children:[t.jsx("h3",{className:"text-lg font-bold text-slate-900",children:"Pièce reçue !"}),t.jsx("p",{className:"text-sm text-slate-500",children:"Voulez-vous prévenir le client ?"})]})]}),t.jsx("div",{className:"bg-slate-50 rounded-lg p-3 mb-5 text-sm text-slate-600 leading-relaxed",children:P(l)}),t.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[t.jsxs("button",{onClick:Z,className:"flex-1 flex items-center justify-center gap-2 px-4 py-2.5 rounded-lg bg-blue-600 text-white text-sm font-medium hover:bg-blue-700 transition-colors",children:[t.jsx(ce,{className:"w-4 h-4"})," SMS"]}),t.jsxs("button",{onClick:ee,className:"flex-1 flex items-center justify-center gap-2 px-4 py-2.5 rounded-lg bg-green-600 text-white text-sm font-medium hover:bg-green-700 transition-colors",children:[t.jsx(ie,{className:"w-4 h-4"})," WhatsApp"]}),t.jsx("button",{onClick:te,className:"flex-1 flex items-center justify-center gap-2 px-4 py-2.5 rounded-lg bg-slate-100 text-slate-600 text-sm font-medium hover:bg-slate-200 transition-colors",children:"Non merci"})]})]})}),t.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-6",children:[t.jsxs("div",{children:[t.jsxs("h1",{className:"text-2xl font-display font-bold text-slate-900 tracking-tight flex items-center gap-2",children:[t.jsx(w,{className:"w-6 h-6 text-brand-600"})," Commandes de pièces"]}),t.jsxs("p",{className:"text-sm text-slate-500 mt-0.5",children:[p.filter(e=>!F.includes(e.statut)).length," en cours — ",p.filter(e=>F.includes(e.statut)).length," clôturée(s)"]})]}),t.jsxs("button",{onClick:()=>{S(),_(!0)},className:"btn-primary",children:[t.jsx(oe,{className:"w-4 h-4"})," Nouvelle commande"]})]}),t.jsxs("div",{className:"card overflow-hidden mb-6",children:[t.jsx("div",{className:"p-3 sm:p-4 border-b border-slate-100",children:t.jsxs("div",{className:"relative",children:[t.jsx(de,{className:"absolute left-3.5 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"}),t.jsx("input",{type:"text",placeholder:"Rechercher par désignation, fournisseur, référence, ticket...",value:k,onChange:e=>B(e.target.value),className:"w-full pl-10 pr-4 py-2.5 rounded-lg border border-slate-200 bg-slate-50/50 text-sm placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-brand-500/20 focus:border-brand-500 focus:bg-white transition-all"})]})}),t.jsx("div",{className:"px-3 sm:px-4 py-2 flex gap-1 overflow-x-auto scrollbar-none bg-slate-50/50",children:Ce.map(e=>{const s=X[e.value]??0,n=o===e.value,x=e.value!=="all"?R(e.value):null,g=x==null?void 0:x.icon;return t.jsxs("button",{onClick:()=>L(e.value),className:`px-3 py-1.5 rounded-md text-xs font-medium whitespace-nowrap transition-all flex items-center gap-1.5
                  ${n?"bg-brand-600 text-white shadow-sm":"text-slate-500 hover:bg-white hover:shadow-sm"}`,children:[g&&t.jsx(g,{className:"w-3.5 h-3.5"}),e.label," (",s,")"]},e.value)})})]}),U&&t.jsxs("div",{className:"card p-5 mb-6 border-brand-200 animate-in",children:[t.jsxs("div",{className:"flex items-center justify-between mb-4",children:[t.jsx("h2",{className:"text-sm font-semibold text-slate-800",children:j?"Modifier la commande":"Nouvelle commande"}),t.jsx("button",{onClick:S,className:"btn-ghost p-1.5",children:t.jsx(me,{className:"w-4 h-4"})})]}),t.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-3 gap-3",children:[t.jsxs("div",{className:"col-span-2 sm:col-span-1",children:[t.jsx("label",{className:"input-label",children:"Désignation *"}),t.jsx("input",{value:r.description,onChange:e=>c(s=>({...s,description:e.target.value})),className:"input",placeholder:"Écran iPhone 15..."})]}),t.jsxs("div",{children:[t.jsx("label",{className:"input-label",children:"Fournisseur"}),t.jsx("input",{value:r.fournisseur,onChange:e=>c(s=>({...s,fournisseur:e.target.value})),className:"input",placeholder:"Nom fournisseur"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"input-label",children:"Référence"}),t.jsx("input",{value:r.reference,onChange:e=>c(s=>({...s,reference:e.target.value})),className:"input font-mono",placeholder:"REF-001"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"input-label",children:"Prix (€)"}),t.jsx("input",{type:"number",step:"0.01",value:r.prix,onChange:e=>c(s=>({...s,prix:e.target.value})),className:"input"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"input-label",children:"Ticket associé"}),t.jsx("input",{value:r.ticket_code,onChange:e=>c(s=>({...s,ticket_code:e.target.value})),className:"input font-mono",placeholder:"KP-000001"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"input-label",children:"Statut"}),t.jsx("select",{value:r.statut,onChange:e=>c(s=>({...s,statut:e.target.value})),className:"input",children:C.map(e=>t.jsx("option",{value:e,children:e},e))})]}),t.jsxs("div",{className:"col-span-2 sm:col-span-3",children:[t.jsx("label",{className:"input-label",children:"Notes"}),t.jsx("input",{value:r.notes,onChange:e=>c(s=>({...s,notes:e.target.value})),className:"input",placeholder:"Notes..."})]})]}),t.jsx("div",{className:"flex justify-end mt-4 pt-3 border-t border-slate-100",children:t.jsxs("button",{onClick:H,disabled:!r.description,className:"btn-primary",children:[t.jsx(xe,{className:"w-4 h-4"})," ",j?"Mettre à jour":"Créer"]})})]}),t.jsxs("div",{className:"card overflow-hidden",children:[t.jsxs("div",{className:"hidden lg:grid grid-cols-[1fr_140px_130px_130px_100px_80px_100px_140px_70px] gap-3 items-center px-5 py-3 bg-slate-50/80 border-b border-slate-100",children:[t.jsx("span",{className:"table-header",children:"Désignation"}),t.jsx("span",{className:"table-header",children:"Modèle"}),t.jsx("span",{className:"table-header",children:"Client"}),t.jsx("span",{className:"table-header",children:"Fournisseur"}),t.jsx("span",{className:"table-header",children:"Panne"}),t.jsx("span",{className:"table-header text-right",children:"Prix"}),t.jsx("span",{className:"table-header",children:"Dates"}),t.jsx("span",{className:"table-header",children:"Statut"}),t.jsx("span",{className:"table-header text-right",children:"Actions"})]}),O?t.jsxs("div",{className:"py-16 text-center",children:[t.jsx("div",{className:"w-8 h-8 border-2 border-brand-600 border-t-transparent rounded-full animate-spin mx-auto mb-3"}),t.jsx("p",{className:"text-sm text-slate-400",children:"Chargement..."})]}):M.length===0?t.jsxs("div",{className:"py-16 text-center",children:[t.jsx("div",{className:"w-14 h-14 rounded-2xl bg-slate-100 flex items-center justify-center mx-auto mb-4",children:t.jsx(w,{className:"w-7 h-7 text-slate-300"})}),t.jsx("p",{className:"text-slate-500 font-medium",children:"Aucune commande"}),t.jsx("p",{className:"text-sm text-slate-400 mt-1",children:o==="all"?"Créez votre première commande de pièce":`Aucune commande avec le statut "${o}"`})]}):t.jsx("div",{className:"divide-y divide-slate-100/80",children:M.map(e=>{const s=R(e.statut);s.icon;const n=[e.client_prenom,e.client_nom].filter(Boolean).join(" "),x=[e.marque,e.modele||e.modele_autre].filter(Boolean).join(" "),g=e.panne||"—";return t.jsxs("div",{className:"lg:grid lg:grid-cols-[1fr_140px_130px_130px_100px_80px_100px_140px_70px] gap-3 items-center px-4 sm:px-5 py-3.5 hover:bg-slate-50 transition-colors",children:[t.jsxs("div",{className:"min-w-0",children:[t.jsx("p",{className:"text-sm font-semibold text-slate-800 truncate",title:e.description,children:e.description}),e.ticket_code&&t.jsxs("button",{onClick:()=>Y(e.ticket_code),className:"text-xs text-brand-600 font-mono hover:text-brand-800 hover:underline flex items-center gap-1",children:[e.ticket_code," ",t.jsx(ue,{className:"w-2.5 h-2.5"})]}),e.notes&&t.jsx("p",{className:"text-xs text-slate-400 mt-0.5 truncate",title:e.notes,children:e.notes})]}),t.jsx("div",{className:"hidden lg:block min-w-0",children:t.jsx("p",{className:"text-sm text-slate-600 truncate",title:x,children:x||"—"})}),t.jsxs("div",{className:"hidden lg:block min-w-0",children:[t.jsx("p",{className:"text-sm text-slate-700 truncate",title:n,children:n||"—"}),e.client_tel&&t.jsx("p",{className:"text-[11px] text-slate-400 font-mono",children:e.client_tel})]}),t.jsx("div",{className:"hidden lg:block min-w-0",children:t.jsx("p",{className:"text-sm text-slate-600 truncate",title:e.fournisseur||"—",children:e.fournisseur||"—"})}),t.jsx("div",{className:"hidden lg:block min-w-0",children:t.jsx("p",{className:"text-xs text-slate-500 truncate",title:g,children:g})}),t.jsx("div",{className:"hidden lg:block text-right",children:t.jsx("p",{className:"text-sm font-medium text-slate-800",children:e.prix?ae(e.prix):"—"})}),t.jsxs("div",{className:"hidden lg:block",children:[t.jsxs("p",{className:"text-[11px] text-slate-500",children:[t.jsx(he,{className:"w-3 h-3 inline mr-0.5"}),e.date_creation?E(e.date_creation):"—"]}),e.date_commande&&t.jsxs("p",{className:"text-[10px] text-blue-500",children:["Cmd: ",E(e.date_commande)]}),e.date_reception&&t.jsxs("p",{className:"text-[10px] text-emerald-500",children:["Reçue: ",E(e.date_reception)]})]}),t.jsx("div",{className:"mt-2 lg:mt-0",onClick:m=>m.stopPropagation(),children:t.jsx("select",{value:e.statut,onChange:m=>Q(e,m.target.value),className:"w-full min-w-[130px] py-1.5 px-2 text-[11px] font-semibold rounded-lg border-2 cursor-pointer appearance-none bg-no-repeat truncate",style:{borderColor:s.color,color:s.color,backgroundColor:s.color+"10",backgroundImage:`url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 24 24' fill='none' stroke='${encodeURIComponent(s.color)}' stroke-width='2'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E")`,backgroundPosition:"right 4px center",backgroundSize:"14px",paddingRight:"22px"},children:C.map(m=>t.jsx("option",{value:m,children:m},m))})}),t.jsxs("div",{className:"hidden lg:flex justify-end gap-1",children:[t.jsx("button",{onClick:()=>V(e),className:"btn-ghost p-1.5",title:"Modifier",children:t.jsx(pe,{className:"w-3.5 h-3.5"})}),t.jsx("button",{onClick:()=>J(e.id),className:"btn-ghost p-1.5",title:"Supprimer",children:t.jsx(ge,{className:"w-3.5 h-3.5 text-red-400"})})]})]},e.id)})})]})]})}export{Se as default};
