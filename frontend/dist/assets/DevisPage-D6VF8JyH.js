import{u as ie,j as e,c as d}from"./index-jhMOtRsP.js";import{r as n}from"./vendor-react-DWtYaMjq.js";import{F as b,D as B,a3 as I,a8 as ne,av as re,S as ce,q as V,ae as $,$ as U,p as de,X as k,r as xe,aR as oe,aS as me,a0 as pe}from"./vendor-icons-DUhoIZbQ.js";const ue=["Brouillon","Envoyé","Accepté","Refusé","Converti"],g={Brouillon:{bg:"#f1f5f9",text:"#475569",border:"#cbd5e1"},Envoyé:{bg:"#eff6ff",text:"#1d4ed8",border:"#93c5fd"},Accepté:{bg:"#ecfdf5",text:"#047857",border:"#6ee7b7"},Refusé:{bg:"#fef2f2",text:"#dc2626",border:"#fca5a5"},Converti:{bg:"#f5f3ff",text:"#7c3aed",border:"#c4b5fd"}},c=y=>y==null?"0,00":Number(y).toFixed(2).replace(".",",");function ve(){var P;const{user:y}=ie(),[S,z]=n.useState([]),[H,D]=n.useState(!0),[v,O]=n.useState(""),[N,G]=n.useState(""),[m,J]=n.useState(null),[K,p]=n.useState(!1),[f,T]=n.useState(null),[A,q]=n.useState(!1),[i,r]=n.useState(R()),[u,h]=n.useState([{description:"",quantite:1,prix_unitaire:0}]),[a,E]=n.useState(null),[L,j]=n.useState(!1);function R(){return{client_nom:"",client_prenom:"",client_tel:"",client_email:"",appareil:"",description:"",tva:20,remise:0,notes:"",validite_jours:30}}const o=async()=>{D(!0);try{const s={};v&&(s.search=v),N&&(s.statut=N);const[t,l]=await Promise.all([d.getDevis(s),d.getDevisStats()]);z(t||[]),J(l)}catch(s){console.error(s)}D(!1)};n.useEffect(()=>{o()},[v,N]);const Q=()=>{T(null),r(R()),h([{description:"",quantite:1,prix_unitaire:0}]),p(!0)},F=async s=>{var t;try{const l=await d.getDevisById(s);T(s),r({client_nom:l.client_nom||"",client_prenom:l.client_prenom||"",client_tel:l.client_tel||"",client_email:l.client_email||"",appareil:l.appareil||"",description:l.description||"",tva:l.tva||20,remise:l.remise||0,notes:l.notes||"",validite_jours:l.validite_jours||30}),h(((t=l.lignes)==null?void 0:t.length)>0?l.lignes.map(x=>({description:x.description,quantite:x.quantite,prix_unitaire:Number(x.prix_unitaire)})):[{description:"",quantite:1,prix_unitaire:0}]),p(!0)}catch{}},W=async s=>{try{const t=await d.getDevisById(s);E(t),j(!0)}catch{}},w=n.useMemo(()=>{const s=u.reduce((t,l)=>t+(l.quantite||0)*(l.prix_unitaire||0),0);return Math.max(0,s-(i.remise||0))},[u,i.remise]),Y=n.useMemo(()=>w*(1+(i.tva||0)/100),[w,i.tva]),Z=async()=>{if(!(!i.client_nom&&!i.client_tel)){q(!0);try{const s=u.filter(l=>l.description.trim()),t={...i,lignes:s};f?await d.updateDevis(f,t):await d.createDevis(t),p(!1),o()}catch(s){console.error(s)}q(!1)}},ee=async s=>{if(confirm("Supprimer ce devis ?"))try{await d.deleteDevis(s),o()}catch{}},_=async(s,t)=>{try{await d.updateDevis(s,{statut:t}),o(),L&&(a==null?void 0:a.id)===s&&E(l=>({...l,statut:t}))}catch{}},se=async s=>{if(confirm("Convertir ce devis en ticket SAV ?"))try{const t=await d.convertDevisToTicket(s);alert(`Ticket créé: ${t.ticket_code}`),o(),j(!1)}catch(t){alert("Erreur: "+t.message)}},M=async s=>{try{await d.duplicateDevis(s),o()}catch{}},te=()=>h(s=>[...s,{description:"",quantite:1,prix_unitaire:0}]),ae=s=>h(t=>t.filter((l,x)=>x!==s)),C=(s,t,l)=>h(x=>x.map((X,le)=>le===s?{...X,[t]:l}:X));return e.jsxs("div",{className:"p-4 sm:p-6 lg:p-8 max-w-7xl",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 mb-6",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-2xl font-display font-bold text-slate-900 tracking-tight flex items-center gap-2",children:[e.jsx(b,{className:"w-6 h-6 text-brand-600"})," Devis"]}),e.jsx("p",{className:"text-sm text-slate-500 mt-0.5",children:"Gestion des devis clients"})]}),e.jsxs("button",{onClick:Q,className:"btn-primary",children:[e.jsx(B,{className:"w-4 h-4"})," Nouveau devis"]})]}),m&&e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-4 gap-3 mb-6",children:[e.jsxs("div",{className:"card p-3",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx(b,{className:"w-4 h-4 text-slate-400"}),e.jsx("span",{className:"text-xs text-slate-500",children:"Total"})]}),e.jsx("p",{className:"text-xl font-bold text-slate-900",children:m.total||0})]}),e.jsxs("div",{className:"card p-3",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx(I,{className:"w-4 h-4 text-emerald-500"}),e.jsx("span",{className:"text-xs text-slate-500",children:"Acceptés"})]}),e.jsx("p",{className:"text-xl font-bold text-emerald-600",children:m.acceptes||0})]}),e.jsxs("div",{className:"card p-3",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx(ne,{className:"w-4 h-4 text-blue-500"}),e.jsx("span",{className:"text-xs text-slate-500",children:"En attente"})]}),e.jsx("p",{className:"text-xl font-bold text-blue-600",children:m.envoyes||0})]}),e.jsxs("div",{className:"card p-3",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx(re,{className:"w-4 h-4 text-brand-500"}),e.jsx("span",{className:"text-xs text-slate-500",children:"CA Accepté"})]}),e.jsxs("p",{className:"text-xl font-bold text-brand-600",children:[c(m.ca_accepte)," €"]})]})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-3 mb-4",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(ce,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"}),e.jsx("input",{value:v,onChange:s=>O(s.target.value),placeholder:"Rechercher par nom, téléphone, numéro...",className:"input pl-9"})]}),e.jsxs("select",{value:N,onChange:s=>G(s.target.value),className:"input w-auto min-w-[140px]",children:[e.jsx("option",{value:"",children:"Tous statuts"}),ue.map(s=>e.jsx("option",{value:s,children:s},s))]})]}),H?e.jsx("div",{className:"flex justify-center py-12",children:e.jsx(V,{className:"w-6 h-6 animate-spin text-brand-600"})}):S.length===0?e.jsxs("div",{className:"text-center py-16",children:[e.jsx(b,{className:"w-12 h-12 text-slate-300 mx-auto mb-3"}),e.jsx("p",{className:"text-slate-500 font-medium",children:"Aucun devis"}),e.jsx("p",{className:"text-sm text-slate-400 mt-1",children:"Créez votre premier devis"})]}):e.jsx("div",{className:"space-y-2",children:S.map(s=>{const t=g[s.statut]||g.Brouillon;return e.jsx("div",{className:"card p-4 hover:shadow-md transition-shadow cursor-pointer",onClick:()=>W(s.id),children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3 flex-1 min-w-0",children:[e.jsx("div",{className:"w-10 h-10 rounded-xl flex items-center justify-center shrink-0",style:{background:t.bg},children:e.jsx(b,{className:"w-5 h-5",style:{color:t.text}})}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("span",{className:"font-semibold text-sm text-slate-900",children:s.numero}),e.jsx("span",{className:"text-xs px-2 py-0.5 rounded-full font-medium",style:{background:t.bg,color:t.text,border:`1px solid ${t.border}`},children:s.statut})]}),e.jsxs("p",{className:"text-xs text-slate-500 mt-0.5 truncate",children:[s.client_prenom," ",s.client_nom,s.appareil?` — ${s.appareil}`:""]})]})]}),e.jsxs("div",{className:"text-right shrink-0 ml-3",children:[e.jsxs("p",{className:"font-bold text-sm text-slate-900",children:[c(s.total_ttc)," €"]}),e.jsx("p",{className:"text-[11px] text-slate-400",children:s.date_creation?new Date(s.date_creation).toLocaleDateString("fr-FR"):""})]}),e.jsxs("div",{className:"flex items-center gap-1 ml-3",onClick:l=>l.stopPropagation(),children:[e.jsx("button",{onClick:()=>F(s.id),className:"p-1.5 rounded-lg hover:bg-slate-100 text-slate-400 hover:text-slate-600",title:"Modifier",children:e.jsx($,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>M(s.id),className:"p-1.5 rounded-lg hover:bg-slate-100 text-slate-400 hover:text-slate-600",title:"Dupliquer",children:e.jsx(U,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>ee(s.id),className:"p-1.5 rounded-lg hover:bg-red-50 text-slate-400 hover:text-red-500",title:"Supprimer",children:e.jsx(de,{className:"w-4 h-4"})})]})]})},s.id)})}),K&&e.jsx("div",{className:"fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-start justify-center overflow-y-auto p-4",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-2xl my-8",children:[e.jsxs("div",{className:"flex items-center justify-between px-6 py-4 border-b border-slate-100",children:[e.jsx("h2",{className:"text-lg font-display font-bold text-slate-900",children:f?"Modifier le devis":"Nouveau devis"}),e.jsx("button",{onClick:()=>p(!1),className:"p-2 rounded-lg hover:bg-slate-100",children:e.jsx(k,{className:"w-5 h-5 text-slate-400"})})]}),e.jsxs("div",{className:"p-6 space-y-5 max-h-[70vh] overflow-y-auto",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-xs font-semibold text-slate-500 uppercase tracking-wider mb-3",children:"Client"}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"input-label",children:"Nom *"}),e.jsx("input",{value:i.client_nom,onChange:s=>r(t=>({...t,client_nom:s.target.value})),className:"input",placeholder:"Dupont"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"input-label",children:"Prénom"}),e.jsx("input",{value:i.client_prenom,onChange:s=>r(t=>({...t,client_prenom:s.target.value})),className:"input",placeholder:"Jean"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"input-label",children:"Téléphone"}),e.jsx("input",{value:i.client_tel,onChange:s=>r(t=>({...t,client_tel:s.target.value})),className:"input",placeholder:"06 XX XX XX XX"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"input-label",children:"Email"}),e.jsx("input",{value:i.client_email,onChange:s=>r(t=>({...t,client_email:s.target.value})),className:"input",placeholder:"email@exemple.com"})]})]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-xs font-semibold text-slate-500 uppercase tracking-wider mb-3",children:"Appareil & Description"}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"input-label",children:"Appareil"}),e.jsx("input",{value:i.appareil,onChange:s=>r(t=>({...t,appareil:s.target.value})),className:"input",placeholder:"iPhone 15 Pro Max"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"input-label",children:"Description"}),e.jsx("input",{value:i.description,onChange:s=>r(t=>({...t,description:s.target.value})),className:"input",placeholder:"Remplacement écran OLED"})]})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h3",{className:"text-xs font-semibold text-slate-500 uppercase tracking-wider",children:"Lignes du devis"}),e.jsxs("button",{onClick:te,className:"text-xs text-brand-600 hover:text-brand-700 font-medium flex items-center gap-1",children:[e.jsx(B,{className:"w-3.5 h-3.5"})," Ajouter"]})]}),e.jsx("div",{className:"space-y-2",children:u.map((s,t)=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{value:s.description,onChange:l=>C(t,"description",l.target.value),placeholder:"Description",className:"input flex-1"}),e.jsx("input",{type:"number",value:s.quantite,onChange:l=>C(t,"quantite",parseInt(l.target.value)||1),className:"input w-16 text-center",min:"1"}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"number",value:s.prix_unitaire,onChange:l=>C(t,"prix_unitaire",parseFloat(l.target.value)||0),className:"input w-24 pr-6 text-right",step:"0.01",min:"0"}),e.jsx("span",{className:"absolute right-2 top-1/2 -translate-y-1/2 text-xs text-slate-400",children:"€"})]}),e.jsxs("span",{className:"text-sm font-semibold text-slate-700 w-20 text-right",children:[c((s.quantite||0)*(s.prix_unitaire||0))," €"]}),u.length>1&&e.jsx("button",{onClick:()=>ae(t),className:"p-1.5 rounded-lg hover:bg-red-50 text-slate-400 hover:text-red-500",children:e.jsx(k,{className:"w-4 h-4"})})]},t))})]}),e.jsxs("div",{className:"bg-slate-50 rounded-xl p-4",children:[e.jsxs("div",{className:"grid grid-cols-3 gap-3 mb-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"input-label",children:"TVA (%)"}),e.jsx("input",{type:"number",value:i.tva,onChange:s=>r(t=>({...t,tva:parseFloat(s.target.value)||0})),className:"input",step:"0.1"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"input-label",children:"Remise (€)"}),e.jsx("input",{type:"number",value:i.remise,onChange:s=>r(t=>({...t,remise:parseFloat(s.target.value)||0})),className:"input",step:"0.01"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"input-label",children:"Validité (jours)"}),e.jsx("input",{type:"number",value:i.validite_jours,onChange:s=>r(t=>({...t,validite_jours:parseInt(s.target.value)||30})),className:"input"})]})]}),e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"text-slate-500",children:"Total HT"}),e.jsxs("span",{className:"font-semibold",children:[c(w)," €"]})]}),e.jsxs("div",{className:"flex items-center justify-between text-lg font-bold mt-2 pt-2 border-t border-slate-200",children:[e.jsx("span",{className:"text-slate-900",children:"Total TTC"}),e.jsxs("span",{className:"text-brand-600",children:[c(Y)," €"]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"input-label",children:"Notes"}),e.jsx("textarea",{value:i.notes,onChange:s=>r(t=>({...t,notes:s.target.value})),className:"input min-h-[60px]",placeholder:"Notes internes ou conditions..."})]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2 px-6 py-4 border-t border-slate-100",children:[e.jsx("button",{onClick:()=>p(!1),className:"btn-secondary",children:"Annuler"}),e.jsxs("button",{onClick:Z,disabled:A||!i.client_nom&&!i.client_tel,className:"btn-primary",children:[A?e.jsx(V,{className:"w-4 h-4 animate-spin"}):e.jsx(b,{className:"w-4 h-4"}),f?"Enregistrer":"Créer le devis"]})]})]})}),L&&a&&e.jsx("div",{className:"fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-start justify-center overflow-y-auto p-4",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-2xl my-8",children:[e.jsxs("div",{className:"flex items-center justify-between px-6 py-4 border-b border-slate-100",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("h2",{className:"text-lg font-display font-bold text-slate-900",children:a.numero}),(()=>{const s=g[a.statut]||g.Brouillon;return e.jsx("span",{className:"text-xs px-2.5 py-1 rounded-full font-semibold",style:{background:s.bg,color:s.text,border:`1px solid ${s.border}`},children:a.statut})})()]}),e.jsx("button",{onClick:()=>j(!1),className:"p-2 rounded-lg hover:bg-slate-100",children:e.jsx(k,{className:"w-5 h-5 text-slate-400"})})]}),e.jsxs("div",{className:"p-6 space-y-5 max-h-[70vh] overflow-y-auto",children:[e.jsxs("div",{className:"bg-slate-50 rounded-xl p-4",children:[e.jsx("p",{className:"text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2",children:"Client"}),e.jsxs("p",{className:"font-semibold text-slate-900",children:[a.client_prenom," ",a.client_nom]}),e.jsxs("p",{className:"text-sm text-slate-500",children:[a.client_tel," ",a.client_email?`— ${a.client_email}`:""]}),a.appareil&&e.jsxs("p",{className:"text-sm text-slate-600 mt-1",children:[e.jsx("b",{children:"Appareil:"})," ",a.appareil]}),a.description&&e.jsx("p",{className:"text-sm text-slate-500 mt-1",children:a.description})]}),((P=a.lignes)==null?void 0:P.length)>0&&e.jsxs("div",{children:[e.jsx("p",{className:"text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2",children:"Détail"}),e.jsx("div",{className:"divide-y divide-slate-100",children:a.lignes.map((s,t)=>e.jsxs("div",{className:"flex items-center justify-between py-2",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-slate-800",children:s.description}),e.jsxs("p",{className:"text-xs text-slate-400",children:[s.quantite," x ",c(s.prix_unitaire)," €"]})]}),e.jsxs("span",{className:"font-semibold text-sm",children:[c(s.total)," €"]})]},t))})]}),e.jsxs("div",{className:"bg-brand-50/50 rounded-xl p-4",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{children:"Total HT"}),e.jsxs("span",{children:[c(a.total_ht)," €"]})]}),Number(a.remise)>0&&e.jsxs("div",{className:"flex justify-between text-sm text-red-600",children:[e.jsx("span",{children:"Remise"}),e.jsxs("span",{children:["-",c(a.remise)," €"]})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{children:["TVA (",c(a.tva),"%)"]}),e.jsxs("span",{children:[c(Number(a.total_ttc)-Number(a.total_ht))," €"]})]}),e.jsxs("div",{className:"flex justify-between text-lg font-bold mt-2 pt-2 border-t border-brand-200",children:[e.jsx("span",{children:"Total TTC"}),e.jsxs("span",{className:"text-brand-600",children:[c(a.total_ttc)," €"]})]})]}),a.notes&&e.jsxs("div",{className:"bg-amber-50 rounded-xl p-4 text-sm text-amber-800",children:[e.jsx("b",{children:"Notes:"})," ",a.notes]})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2 px-6 py-4 border-t border-slate-100",children:[a.statut==="Brouillon"&&e.jsxs("button",{onClick:()=>_(a.id,"Envoyé"),className:"btn-primary text-xs",children:[e.jsx(xe,{className:"w-3.5 h-3.5"})," Marquer envoyé"]}),a.statut==="Envoyé"&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:()=>_(a.id,"Accepté"),className:"btn-primary text-xs",style:{background:"#059669"},children:[e.jsx(I,{className:"w-3.5 h-3.5"})," Accepter"]}),e.jsxs("button",{onClick:()=>_(a.id,"Refusé"),className:"btn-secondary text-xs text-red-600 border-red-200 hover:bg-red-50",children:[e.jsx(oe,{className:"w-3.5 h-3.5"})," Refuser"]})]}),a.statut==="Accepté"&&e.jsxs("button",{onClick:()=>se(a.id),className:"btn-primary text-xs",children:[e.jsx(me,{className:"w-3.5 h-3.5"})," Convertir en ticket"]}),e.jsxs("a",{href:d.getDevisPrintUrl(a.id),target:"_blank",rel:"noopener noreferrer",className:"btn-secondary text-xs",children:[e.jsx(pe,{className:"w-3.5 h-3.5"})," Imprimer"]}),e.jsxs("button",{onClick:()=>{F(a.id),j(!1)},className:"btn-secondary text-xs",children:[e.jsx($,{className:"w-3.5 h-3.5"})," Modifier"]}),e.jsxs("button",{onClick:()=>{M(a.id),j(!1)},className:"btn-secondary text-xs",children:[e.jsx(U,{className:"w-3.5 h-3.5"})," Dupliquer"]})]})]})})]})}export{ve as default};
