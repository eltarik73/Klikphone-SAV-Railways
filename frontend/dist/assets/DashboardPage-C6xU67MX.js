import{u as we,a as j,j as t,S as Q,g as T,f as ke,w as _e,s as Ce,b as Se}from"./index-5YFw6LH3.js";import{u as ye,r as n}from"./vendor-react-DMwujlca.js";import{b as Y,a as Z,W as $e,j as Te,P as ee,h as Pe,z as Ee,C as De,X as Me,D as te,E as se,m as Ae,e as Re,x as ze,l as Be,q as Ie,G as Ke,J as ae,K as Le}from"./vendor-icons-DnXwj2oL.js";function He(){const d=ye(),{user:r}=we(),x=(r==null?void 0:r.target)==="tech"?"/tech":"/accueil",[u,le]=n.useState(null),[v,P]=n.useState([]),[U,W]=n.useState(!0),[E,ne]=n.useState(""),[D,re]=n.useState(""),[C,M]=n.useState(""),[F,A]=n.useState(null),[R,N]=n.useState(!1),[ie,z]=n.useState(0),[V,ce]=n.useState({}),[h,w]=n.useState(new Set),[qe,Ue]=n.useState(""),[H,B]=n.useState(!1),[k,oe]=n.useState(""),[I,de]=n.useState([]),[m,xe]=n.useState(()=>parseInt(localStorage.getItem("kp_page_size")||"50")),[c,p]=n.useState(0),S=n.useRef(null);n.useEffect(()=>(S.current&&clearTimeout(S.current),S.current=setTimeout(()=>re(E),300),()=>clearTimeout(S.current)),[E]);const J=n.useCallback(async()=>{W(!0);try{const e={limit:200};D&&(e.search=D),C&&(e.statut=C);const[a,l]=await Promise.all([j.getKPI(),j.getTickets(e)]);le(a),P(l)}catch(e){console.error(e)}finally{W(!1)}},[D,C,ie]);n.useEffect(()=>{J()},[J]),n.useEffect(()=>{j.getActiveTeam().then(e=>{const a={};e.forEach(l=>{l.couleur&&(a[l.nom]=l.couleur)}),ce(a),de(e)}).catch(()=>{})},[]),n.useEffect(()=>{const e=setInterval(()=>z(a=>a+1),3e4);return()=>clearInterval(e)},[]);const he=e=>{w(a=>{const l=new Set(a);return l.has(e)?l.delete(e):l.add(e),l})},me=()=>{h.size===g.length?w(new Set):w(new Set(g.map(e=>e.id)))},ue=async e=>{if(h.size!==0)try{await Promise.all([...h].map(a=>j.changeStatus(a,e))),w(new Set),B(!1),z(a=>a+1)}catch(a){console.error(a)}},pe=async(e,a)=>{try{await j.changeStatus(e,a),P(l=>l.map(s=>s.id===e?{...s,statut:a}:s))}catch(l){console.error(l)}},ge=async(e,a)=>{try{await j.updateTicket(e,{technicien_assigne:a||null}),P(l=>l.map(s=>s.id===e?{...s,technicien_assigne:a||null}:s))}catch(l){console.error(l)}},be=(e,a)=>{F===a?(A(null),M(""),N(!1)):(A(a),e&&(M(e),N(!1)))},O=(r==null?void 0:r.target)==="tech",y=r==null?void 0:r.utilisateur,K=(e,a)=>{if(!e||!a)return!1;const l=e.trim(),s=a.trim();return l===s||l.startsWith(s+" ")},L=e=>{if(!e)return null;const a=V[e];if(a)return a;for(const[l,s]of Object.entries(V))if(K(e,l))return s;return null},$=n.useMemo(()=>k==="__mine__"&&y?v.filter(e=>K(e.technicien_assigne,y)||!e.technicien_assigne):k?v.filter(e=>K(e.technicien_assigne,k)):v,[v,k,y]),G=n.useMemo(()=>$.filter(e=>!["Clôturé","Rendu au client"].includes(e.statut)),[$]),X=n.useMemo(()=>$.filter(e=>["Clôturé","Rendu au client"].includes(e.statut)),[$]),_=R?X:G,q=Math.ceil(_.length/m),g=_.slice(c*m,(c+1)*m),fe=e=>{xe(e),p(0),localStorage.setItem("kp_page_size",e.toString())},je=u?[{label:"Total actifs",value:u.total_actifs,icon:Y,color:"text-brand-600",iconBg:"bg-brand-100"},{label:"Diagnostic",value:u.en_attente_diagnostic,icon:Z,color:"text-amber-600",iconBg:"bg-amber-100",filter:"En attente de diagnostic"},{label:"Réparation",value:u.en_cours,icon:$e,color:"text-blue-600",iconBg:"bg-blue-100",filter:"En cours de réparation"},{label:"Accord client",value:u.en_attente_accord,icon:Te,color:"text-orange-600",iconBg:"bg-orange-100",filter:"En attente d'accord client"},{label:"Pièces",value:u.en_attente_piece,icon:ee,color:"text-violet-600",iconBg:"bg-violet-100",filter:"En attente de pièce"}]:[],ve=e=>{if(!e)return{text:"Non définie",color:"text-slate-400",urgent:!1};const a=new Date;let l;if(e.includes("-")&&e.length>=10)l=new Date(e);else{const f=e.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})/);if(f)l=new Date(`${f[3]}-${f[2].padStart(2,"0")}-${f[1].padStart(2,"0")}`);else return{text:e,color:"text-slate-500",urgent:!1}}if(isNaN(l.getTime()))return{text:e,color:"text-slate-500",urgent:!1};const s=l-a,o=Math.round(s/36e5),i=Math.floor(Math.abs(o)/24),b=Math.abs(o)%24;return s>0?{text:i>0?`dans ${i}j ${b}h`:`dans ${Math.abs(o)}h`,color:"text-emerald-600",urgent:!1}:{text:i>0?`DÉPASSÉ ${i}j ${b}h`:`DÉPASSÉ ${Math.abs(o)}h`,color:"text-red-600 font-bold",urgent:!0}},Ne=[{label:"Tous",value:""},{label:"Diagnostic",value:"En attente de diagnostic"},{label:"Réparation",value:"En cours de réparation"},{label:"Accord",value:"En attente d'accord client"},{label:"Pièces",value:"En attente de pièce"},{label:"Pièce reçue",value:"Pièce reçue"},{label:"Terminés",value:"Réparation terminée"},{label:"Rendus",value:"Rendu au client"},{label:"Clôturés",value:"Clôturé"}];return t.jsxs("div",{className:"p-4 sm:p-6 lg:p-8",children:[t.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-6",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("img",{src:"/logo_k.png",alt:"",className:"w-8 h-8 rounded-lg object-contain shadow-sm hidden sm:block"}),t.jsxs("div",{children:[t.jsx("h1",{className:"text-2xl font-display font-bold text-slate-900 tracking-tight",children:(r==null?void 0:r.target)==="tech"?"Espace Technicien":"Tableau de bord"}),t.jsx("p",{className:"text-sm text-slate-500 mt-0.5",children:(r==null?void 0:r.target)==="tech"?`Bienvenue ${(r==null?void 0:r.utilisateur)||""} — vos réparations`:"Vue d'ensemble des réparations"})]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("button",{onClick:()=>z(e=>e+1),className:"btn-ghost p-2.5",title:"Rafraîchir",children:t.jsx(Pe,{className:`w-4 h-4 ${U?"animate-spin":""}`})}),t.jsxs("button",{onClick:()=>d("/client"),className:"btn-primary",children:[t.jsx(Ee,{className:"w-4 h-4"})," Nouveau ticket"]})]})]}),t.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-3 mb-6",children:je.map(({label:e,value:a,icon:l,color:s,iconBg:o,filter:i},b)=>t.jsxs("button",{onClick:()=>be(i,b),className:`card p-4 hover:shadow-md hover:-translate-y-0.5 transition-all duration-200 animate-in text-left
              ${F===b?"ring-2 ring-brand-500 shadow-lg shadow-brand-500/10":""}`,style:{animationDelay:`${b*50}ms`},children:[t.jsx("div",{className:`w-9 h-9 rounded-lg ${o} flex items-center justify-center mb-3`,children:t.jsx(l,{className:`w-4 h-4 ${s}`})}),t.jsx("p",{className:"text-2xl font-bold text-slate-900 tracking-tight",children:a}),t.jsx("p",{className:"text-[11px] text-slate-500 font-medium mt-0.5 leading-tight",children:e})]},e))}),t.jsxs("div",{className:"card overflow-hidden mb-6",children:[t.jsx("div",{className:"p-3 sm:p-4 border-b border-slate-100",children:t.jsxs("div",{className:"flex gap-2",children:[t.jsxs("div",{className:"relative flex-1",children:[t.jsx(Z,{className:"absolute left-3.5 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"}),t.jsx("input",{type:"text",placeholder:"Rechercher par nom, téléphone, code, marque, modèle...",value:E,onChange:e=>{ne(e.target.value),p(0)},className:"w-full pl-10 pr-4 py-2.5 rounded-lg border border-slate-200 bg-slate-50/50 text-sm placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-brand-500/20 focus:border-brand-500 focus:bg-white transition-all"})]}),I.length>0&&t.jsxs("select",{value:k,onChange:e=>{oe(e.target.value),p(0)},className:"px-3 py-2.5 rounded-lg border border-slate-200 bg-slate-50/50 text-sm text-slate-700 focus:outline-none focus:ring-2 focus:ring-brand-500/20 focus:border-brand-500 min-w-[140px]",children:[t.jsx("option",{value:"",children:"Tous les techs"}),O&&y&&t.jsx("option",{value:"__mine__",children:"Mes tickets"}),I.map(e=>t.jsx("option",{value:e.nom,children:e.nom},e.id))]})]})}),t.jsx("div",{className:"px-3 sm:px-4 py-2 flex gap-1 overflow-x-auto scrollbar-none bg-slate-50/50",children:Ne.map(({label:e,value:a})=>t.jsx("button",{onClick:()=>{M(a),A(null),N(["Rendu au client","Clôturé"].includes(a))},className:`flex items-center gap-1.5 px-3 py-1.5 rounded-md text-xs font-medium whitespace-nowrap transition-all
                ${C===a?"bg-brand-600 text-white shadow-sm shadow-brand-600/25":"text-slate-500 hover:bg-white hover:text-slate-700 hover:shadow-sm"}`,children:e},a))})]}),t.jsxs("div",{className:"flex items-center justify-between mb-3 px-1",children:[t.jsxs("button",{onClick:()=>N(!1),className:`text-sm font-medium ${R?"text-slate-400 hover:text-slate-600":"text-brand-600"}`,children:[G.length," actif(s)"]}),t.jsxs("button",{onClick:()=>N(!0),className:`text-sm font-medium ${R?"text-brand-600":"text-slate-400 hover:text-slate-600"}`,children:["Voir ",X.length," archivé(s)"]})]}),h.size>0&&t.jsxs("div",{className:"flex items-center gap-3 mb-3 px-4 py-2.5 bg-brand-50 border border-brand-200 rounded-xl animate-in",children:[t.jsxs("span",{className:"text-sm font-semibold text-brand-700",children:[h.size," sélectionné(s)"]}),t.jsxs("div",{className:"relative ml-auto",children:[t.jsxs("button",{onClick:()=>B(!H),className:"btn-primary text-xs px-3 py-1.5",children:["Changer statut ",t.jsx(De,{className:"w-3.5 h-3.5"})]}),H&&t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"fixed inset-0 z-40",onClick:()=>B(!1)}),t.jsx("div",{className:"absolute right-0 top-full mt-1 w-64 card p-1.5 shadow-xl z-50 animate-in",children:Q.map(e=>t.jsx("button",{onClick:()=>ue(e),className:"w-full text-left px-3 py-2 rounded-lg text-sm hover:bg-slate-50 text-slate-700 transition-colors",children:e},e))})]})]}),t.jsx("button",{onClick:()=>w(new Set),className:"btn-ghost p-1.5",children:t.jsx(Me,{className:"w-4 h-4"})})]}),t.jsxs("div",{className:"card overflow-hidden",children:[t.jsxs("div",{className:"hidden lg:grid grid-cols-[28px_72px_1fr_120px_1fr_100px_150px_72px_80px_72px_28px] gap-2 items-center px-5 py-3 bg-slate-50/80 border-b border-slate-100",children:[t.jsx("button",{onClick:me,className:"flex items-center justify-center",children:h.size===g.length&&g.length>0?t.jsx(te,{className:"w-4 h-4 text-brand-600"}):t.jsx(se,{className:"w-4 h-4 text-slate-300"})}),t.jsx("span",{className:"table-header",children:"Ticket"}),t.jsx("span",{className:"table-header",children:"Client"}),t.jsx("span",{className:"table-header",children:"Appareil"}),t.jsx("span",{className:"table-header",children:"Panne"}),t.jsx("span",{className:"table-header",children:"Tech"}),t.jsx("span",{className:"table-header",children:"Statut"}),t.jsx("span",{className:"table-header",children:"Date"}),t.jsx("span",{className:"table-header",children:"Contact"}),t.jsx("span",{className:"table-header text-right",children:"Prix"}),t.jsx("span",{})]}),U&&v.length===0?t.jsxs("div",{className:"py-16 text-center",children:[t.jsx("div",{className:"w-8 h-8 border-2 border-brand-600 border-t-transparent rounded-full animate-spin mx-auto mb-3"}),t.jsx("p",{className:"text-sm text-slate-400",children:"Chargement..."})]}):g.length===0?t.jsxs("div",{className:"py-16 text-center",children:[t.jsx("div",{className:"w-14 h-14 rounded-2xl bg-slate-100 flex items-center justify-center mx-auto mb-4",children:t.jsx(Y,{className:"w-7 h-7 text-slate-300"})}),t.jsx("p",{className:"text-slate-500 font-medium",children:"Aucun ticket trouvé"}),t.jsx("p",{className:"text-sm text-slate-400 mt-1",children:"Modifiez vos filtres ou créez un nouveau ticket"})]}):t.jsx("div",{className:"divide-y divide-slate-100/80",children:g.map(e=>{var a,l;return t.jsxs("div",{className:"lg:grid lg:grid-cols-[28px_72px_1fr_120px_1fr_100px_150px_72px_80px_72px_28px] gap-2 items-center px-4 sm:px-5 py-3 hover:bg-brand-50/40 transition-colors group",children:[t.jsx("div",{className:"hidden lg:flex items-center justify-center",children:t.jsx("button",{onClick:()=>he(e.id),children:h.has(e.id)?t.jsx(te,{className:"w-4 h-4 text-brand-600"}):t.jsx(se,{className:"w-4 h-4 text-slate-300 group-hover:text-slate-400"})})}),t.jsx("div",{className:"cursor-pointer",onClick:()=>d(`${x}/ticket/${e.id}`),children:t.jsxs("div",{className:"flex items-center gap-1",children:[e.attention&&t.jsx("span",{className:"w-2 h-2 rounded-full bg-red-500 shrink-0",title:"Attention"}),t.jsx("p",{className:"text-xs font-bold text-brand-600 font-mono",children:e.ticket_code})]})}),t.jsx("div",{className:"min-w-0 mt-1 lg:mt-0 cursor-pointer",onClick:()=>d(`${x}/ticket/${e.id}`),children:t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("div",{className:"w-7 h-7 rounded-full bg-brand-100 flex items-center justify-center shrink-0",children:t.jsxs("span",{className:"text-brand-700 font-bold text-[10px]",children:[(((a=e.client_prenom)==null?void 0:a[0])||"").toUpperCase(),(((l=e.client_nom)==null?void 0:l[0])||"").toUpperCase()]})}),t.jsxs("div",{className:"min-w-0",children:[t.jsxs("p",{className:"text-sm font-semibold text-slate-800 truncate",children:[e.client_prenom||""," ",e.client_nom||""]}),t.jsx("p",{className:"text-[11px] text-slate-400 font-mono truncate",children:e.client_tel||""})]})]})}),t.jsxs("div",{className:"hidden lg:block cursor-pointer",onClick:()=>d(`${x}/ticket/${e.id}`),children:[t.jsxs("p",{className:"text-xs text-slate-700 font-medium truncate",children:[e.marque," ",e.modele||e.modele_autre]}),O&&(e.pin||e.pattern)&&t.jsxs("div",{className:"flex items-center gap-2 mt-0.5",children:[e.pin&&t.jsxs("span",{className:"text-[10px] font-mono text-amber-600 flex items-center gap-0.5",children:[t.jsx(Ae,{className:"w-2.5 h-2.5"})," ",e.pin]}),e.pattern&&t.jsxs("span",{className:"text-[10px] font-mono text-violet-600 flex items-center gap-0.5",children:[t.jsx(Re,{className:"w-2.5 h-2.5"})," ",e.pattern]})]})]}),t.jsx("div",{className:"hidden lg:block cursor-pointer",onClick:()=>d(`${x}/ticket/${e.id}`),children:e.commande_piece===1?t.jsxs("p",{className:"text-xs text-amber-600 font-medium truncate flex items-center gap-1",children:[t.jsx(ee,{className:"w-3 h-3 shrink-0"})," Pièce à commander"]}):(()=>{let s=[];try{const o=JSON.parse(e.reparation_supp||"[]");Array.isArray(o)&&(s=o.filter(i=>i.label).map(i=>i.label))}catch{}return s.length===0&&e.panne&&(s=[e.panne]),t.jsx("p",{className:"text-xs text-slate-600 truncate",title:s.join(" + "),children:s.join(" + ")||"—"})})()}),t.jsx("div",{className:"hidden lg:block",onClick:s=>s.stopPropagation(),children:t.jsxs("select",{value:e.technicien_assigne||"",onChange:s=>ge(e.id,s.target.value),className:"w-full py-1.5 px-2 text-[11px] font-medium rounded-lg border cursor-pointer appearance-none bg-no-repeat truncate transition-colors",style:{borderColor:e.technicien_assigne?L(e.technicien_assigne)||"#94a3b8":"#e2e8f0",color:e.technicien_assigne?"#334155":"#94a3b8",backgroundColor:e.technicien_assigne&&L(e.technicien_assigne)?L(e.technicien_assigne)+"15":"#f8fafc",backgroundImage:`url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E")`,backgroundPosition:"right 4px center",backgroundSize:"12px",paddingRight:"20px"},children:[t.jsx("option",{value:"",children:"— Aucun"}),I.map(s=>t.jsx("option",{value:s.nom,children:s.nom},s.id))]})}),t.jsx("div",{className:"mt-2 lg:mt-0",onClick:s=>s.stopPropagation(),children:t.jsx("select",{value:e.statut,onChange:s=>pe(e.id,s.target.value),className:"w-full py-1.5 px-2 text-[11px] font-semibold rounded-lg border-2 cursor-pointer appearance-none bg-no-repeat truncate",style:{borderColor:T(e.statut).color,color:T(e.statut).color,backgroundColor:T(e.statut).color+"10",backgroundImage:`url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 24 24' fill='none' stroke='${encodeURIComponent(T(e.statut).color)}' stroke-width='2'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E")`,backgroundPosition:"right 4px center",backgroundSize:"14px",paddingRight:"22px"},children:Q.map(s=>t.jsx("option",{value:s,children:s},s))})}),t.jsxs("div",{className:"hidden lg:block cursor-pointer",onClick:()=>d(`${x}/ticket/${e.id}`),children:[t.jsx("p",{className:"text-[11px] text-slate-500",children:ke(e.date_depot)}),e.date_recuperation&&(()=>{const s=ve(e.date_recuperation);return t.jsxs("p",{className:`text-[10px] flex items-center gap-0.5 mt-0.5 ${s.color}`,children:[t.jsx(ze,{className:"w-2.5 h-2.5"})," ",s.text]})})()]}),t.jsxs("div",{className:"flex items-center gap-1 mt-2 lg:mt-0",children:[t.jsx("a",{href:e.client_tel?_e(e.client_tel,`Bonjour, concernant votre ticket ${e.ticket_code}...`):"#",target:"_blank",rel:"noopener noreferrer",onClick:s=>{e.client_tel||s.preventDefault(),s.stopPropagation()},className:"p-1.5 rounded-md hover:bg-green-50 transition-colors",title:"WhatsApp",children:t.jsx(Be,{className:`w-3.5 h-3.5 ${e.msg_whatsapp?"text-green-500":"text-slate-300"}`})}),t.jsx("a",{href:e.client_tel?Ce(e.client_tel,`Klikphone: Votre ticket ${e.ticket_code}...`):"#",onClick:s=>{e.client_tel||s.preventDefault(),s.stopPropagation()},className:"p-1.5 rounded-md hover:bg-blue-50 transition-colors",title:"SMS",children:t.jsx(Ie,{className:`w-3.5 h-3.5 ${e.msg_sms?"text-blue-500":"text-slate-300"}`})}),t.jsx("a",{href:e.client_email?`mailto:${e.client_email}`:"#",onClick:s=>{e.client_email||s.preventDefault(),s.stopPropagation()},className:"p-1.5 rounded-md hover:bg-amber-50 transition-colors",title:"Email",children:t.jsx(Ke,{className:`w-3.5 h-3.5 ${e.msg_email?"text-amber-500":"text-slate-300"}`})})]}),t.jsx("div",{className:"hidden lg:block text-right cursor-pointer",onClick:()=>d(`${x}/ticket/${e.id}`),children:e.devis_estime||e.tarif_final?t.jsx("p",{className:"text-xs font-semibold text-slate-800",children:Se(e.tarif_final||e.devis_estime)}):t.jsx("p",{className:"text-xs text-slate-300",children:"—"})}),t.jsx("div",{className:"hidden lg:flex justify-end cursor-pointer",onClick:()=>d(`${x}/ticket/${e.id}`),children:t.jsx(ae,{className:"w-4 h-4 text-slate-300 group-hover:text-brand-500 transition-colors"})})]},e.id)})}),_.length>m&&t.jsxs("div",{className:"flex items-center justify-between px-5 py-3 border-t border-slate-100 bg-slate-50/50",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsxs("span",{className:"text-xs text-slate-500",children:[c*m+1,"–",Math.min((c+1)*m,_.length)," sur ",_.length]}),t.jsx("select",{value:m,onChange:e=>fe(Number(e.target.value)),className:"text-xs border border-slate-200 rounded-md px-2 py-1 bg-white text-slate-600",children:[10,25,50,100].map(e=>t.jsxs("option",{value:e,children:[e," / page"]},e))})]}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx("button",{onClick:()=>p(e=>Math.max(0,e-1)),disabled:c===0,className:"p-1.5 rounded-md hover:bg-slate-100 disabled:opacity-30 disabled:cursor-not-allowed transition-colors",children:t.jsx(Le,{className:"w-4 h-4 text-slate-600"})}),Array.from({length:q},(e,a)=>t.jsx("button",{onClick:()=>p(a),className:`w-7 h-7 rounded-md text-xs font-medium transition-colors ${a===c?"bg-brand-600 text-white":"text-slate-500 hover:bg-slate-100"}`,children:a+1},a)).slice(Math.max(0,c-2),c+3),t.jsx("button",{onClick:()=>p(e=>Math.min(q-1,e+1)),disabled:c>=q-1,className:"p-1.5 rounded-md hover:bg-slate-100 disabled:opacity-30 disabled:cursor-not-allowed transition-colors",children:t.jsx(ae,{className:"w-4 h-4 text-slate-600"})})]})]})]})]})}export{He as default};
