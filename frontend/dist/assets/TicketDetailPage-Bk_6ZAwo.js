import{a as x,j as e,w as ht,s as bt,c as gt,u as ft,b as E,d as ts,P as ss,F as as,g as se,S as ls,e as Ae}from"./index-5YFw6LH3.js";import{r,c as ns,u as rs}from"./vendor-react-DMwujlca.js";import{P as is}from"./PatternGrid-aMzuwF_t.js";import{N as nt,O as cs,Q as jt,F as Nt,X as U,Y as vt,Z as os,q as je,C as wt,l as Ne,G as ve,_ as ds,$ as ms,a0 as xs,a1 as ie,b as $e,A as Me,k as be,a2 as rt,W as it,j as De,a3 as ps,o as ct,a4 as fe,a5 as Fe,P as ot,z as ae,a6 as ge,a7 as dt,a8 as us,a9 as hs,m as mt,aa as bs,x as gs,e as fs,v as js}from"./vendor-icons-DnXwj2oL.js";const xt=[{type:"client",label:"Client",desc:"ReÃ§u de dÃ©pÃ´t",icon:nt},{type:"staff",label:"Atelier",desc:"Fiche technicien",icon:cs},{type:"combined",label:"Double",desc:"Client + Atelier",icon:jt},{type:"devis",label:"Devis",desc:"Devis dÃ©taillÃ©",icon:Nt},{type:"recu",label:"ReÃ§u",desc:"ReÃ§u de paiement",icon:nt}],pt=new Set(["devis","recu"]);function Ns({open:u,onClose:$,ticketId:i,ticketCode:c,clientTel:_,clientEmail:M}){const[p,I]=r.useState("client"),O=r.useRef(null),[q,D]=r.useState(!0),[P,N]=r.useState(!1),[K,S]=r.useState(!1),[W,J]=r.useState(!1),[R,L]=r.useState(null),F=x.getPrintUrl(i,p),w=xt.find(b=>b.type===p),C=pt.has(p);r.useEffect(()=>(u?(I("client"),L(null),document.body.style.overflow="hidden"):document.body.style.overflow="",()=>{document.body.style.overflow=""}),[u]),r.useEffect(()=>{u&&D(!0)},[p]),r.useEffect(()=>{if(!R)return;const b=setTimeout(()=>L(null),4e3);return()=>clearTimeout(b)},[R]);const T=async()=>{N(!0);try{const h=await(await fetch(F)).text(),j=window.open("","_blank");if(!j){window.open(F,"_blank");return}j.document.write(h),j.document.close(),j.focus(),setTimeout(()=>{j.print()},300)}catch{window.open(F,"_blank")}finally{N(!1)}},V=()=>{window.open(F,"_blank")},G=()=>{window.open(x.getPdfUrl(i,p),"_blank")},z=()=>C?x.getSharePdfUrl(i,p):x.getSharePrintUrl(i,p),m=()=>{if(!_)return;const b=z(),h=`Bonjour, voici votre ${(w==null?void 0:w.desc)||"document"} pour le ticket ${c}.

${b.trim()}`;window.open(ht(_,h),"_blank"),S(!1)},g=()=>{if(!_)return;const b=z(),h=`Klikphone - ${(w==null?void 0:w.desc)||"document"} ${c}
${b.trim()}`;window.open(bt(_,h),"_blank"),S(!1)},f=async()=>{if(M){J(!0);try{const b=await x.sendDocument(i,p,M);b.status==="ok"?(S(!1),L({type:"success",message:`Email envoyÃ© avec succÃ¨s Ã  ${M}`})):L({type:"error",message:b.detail||"Erreur lors de l'envoi de l'email"})}catch{L({type:"error",message:"Erreur lors de l'envoi de l'email"})}finally{J(!1)}}};return u?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 bg-black/50 backdrop-blur-sm z-50 transition-opacity",onClick:$}),e.jsxs("div",{className:"fixed inset-y-0 right-0 w-full sm:w-[520px] lg:w-[600px] bg-white shadow-2xl z-50 flex flex-col animate-in",style:{animationName:"slideInRight",animationDuration:"300ms"},children:[e.jsxs("div",{className:"flex items-center justify-between px-5 py-4 border-b border-slate-100 shrink-0",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-base font-display font-bold text-slate-900",children:"Impression"}),e.jsxs("p",{className:"text-xs text-slate-400 mt-0.5",children:["Ticket ",c]})]}),e.jsx("button",{onClick:$,className:"p-2 rounded-lg hover:bg-slate-100 text-slate-400 hover:text-slate-600 transition-colors",children:e.jsx(U,{className:"w-5 h-5"})})]}),e.jsx("div",{className:"flex gap-1 px-5 py-3 border-b border-slate-100 overflow-x-auto scrollbar-none shrink-0 bg-slate-50/50",children:xt.map(({type:b,label:h,icon:j})=>e.jsxs("button",{onClick:()=>{I(b),D(!0)},className:`flex items-center gap-1.5 px-3 py-2 rounded-lg text-xs font-medium whitespace-nowrap transition-all ${p===b?"bg-brand-600 text-white shadow-sm shadow-brand-600/25":"text-slate-500 hover:bg-white hover:text-slate-700 hover:shadow-sm"}`,children:[e.jsx(j,{className:"w-3.5 h-3.5"}),h,e.jsx("span",{className:`text-[9px] px-1 py-0.5 rounded ${p===b?"bg-white/20":"bg-slate-200 text-slate-500"}`,children:pt.has(b)?"A4":"80mm"})]},b))}),e.jsxs("div",{className:"flex-1 relative bg-slate-100 overflow-hidden",children:[e.jsx("div",{className:"absolute top-3 left-3 z-10 flex items-center gap-2",children:e.jsx("span",{className:"text-[10px] font-semibold px-2 py-1 rounded-md shadow-sm bg-slate-800 text-white",children:C?"PDF A4":"THERMIQUE 80mm"})}),q&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-slate-100 z-10",children:e.jsxs("div",{className:"flex flex-col items-center gap-3",children:[e.jsx("div",{className:"w-8 h-8 border-2 border-brand-600 border-t-transparent rounded-full animate-spin"}),e.jsx("p",{className:"text-sm text-slate-400",children:"Chargement de l'aperÃ§u..."})]})}),e.jsx("div",{className:"h-full overflow-auto flex justify-center pt-4 pb-8",children:e.jsx("div",{className:`bg-white shadow-xl rounded-lg overflow-hidden shrink-0 ${C?"w-[480px]":"w-[320px]"}`,children:e.jsx("iframe",{ref:O,src:C?x.getPdfUrl(i,p):F,className:"w-full h-full border-0",style:{minHeight:"600px"},title:`AperÃ§u ${w==null?void 0:w.label}`,onLoad:()=>D(!1)})})})]}),e.jsxs("div",{className:"px-5 py-4 border-t border-slate-100 bg-white shrink-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{onClick:T,disabled:P,className:`flex-1 justify-center ${C?"btn-ghost border border-slate-200":"btn-primary shadow-lg shadow-brand-600/20"}`,children:[e.jsx(vt,{className:"w-4 h-4"}),P?"Ouverture...":"Imprimer 80mm"]}),C&&e.jsxs("button",{onClick:G,className:"btn-primary flex-1 justify-center shadow-lg shadow-brand-600/20",children:[e.jsx(os,{className:"w-4 h-4"}),"PDF A4"]}),e.jsxs("div",{className:"relative",children:[e.jsxs("button",{onClick:()=>S(!K),className:"btn-ghost border border-slate-200 px-3 gap-1",children:[e.jsx(je,{className:"w-4 h-4"}),e.jsx(wt,{className:"w-3 h-3"})]}),K&&e.jsxs("div",{className:"absolute bottom-full right-0 mb-2 w-48 bg-white rounded-lg shadow-xl border border-slate-200 py-1 z-50",children:[e.jsxs("button",{onClick:m,disabled:!_,className:"w-full flex items-center gap-2 px-3 py-2 text-sm text-slate-700 hover:bg-slate-50 disabled:opacity-40",children:[e.jsx(Ne,{className:"w-4 h-4 text-green-600"}),"WhatsApp"]}),e.jsxs("button",{onClick:g,disabled:!_,className:"w-full flex items-center gap-2 px-3 py-2 text-sm text-slate-700 hover:bg-slate-50 disabled:opacity-40",children:[e.jsx(je,{className:"w-4 h-4 text-blue-600"}),"SMS"]}),e.jsxs("button",{onClick:f,disabled:!M||W,className:"w-full flex items-center gap-2 px-3 py-2 text-sm text-slate-700 hover:bg-slate-50 disabled:opacity-40",children:[e.jsx(ve,{className:"w-4 h-4 text-red-500"}),W?"Envoi...":C?"Email (PDF)":"Email"]})]})]}),e.jsx("button",{onClick:V,className:"btn-ghost border border-slate-200 px-3",title:"Ouvrir dans un nouvel onglet",children:e.jsx(ds,{className:"w-4 h-4"})})]}),e.jsx("p",{className:"text-[10px] text-slate-400 text-center mt-2",children:C?"Document PDF format A4 professionnel":"Format optimisÃ© pour imprimante thermique 80mm"})]})]}),R&&e.jsx("div",{className:"fixed inset-x-0 bottom-24 z-[60] flex justify-center pointer-events-none",children:e.jsxs("div",{className:`pointer-events-auto flex items-center gap-3 px-5 py-3 rounded-xl shadow-2xl border transition-all ${R.type==="success"?"bg-emerald-600 border-emerald-700 text-white":"bg-red-600 border-red-700 text-white"}`,style:{animation:"toastIn 300ms ease-out"},children:[R.type==="success"?e.jsx(ms,{className:"w-5 h-5 shrink-0"}):e.jsx(xs,{className:"w-5 h-5 shrink-0"}),e.jsx("span",{className:"text-sm font-semibold",children:R.message}),e.jsx("button",{onClick:()=>L(null),className:"ml-2 p-0.5 rounded hover:bg-white/20",children:e.jsx(U,{className:"w-4 h-4"})})]})}),e.jsx("style",{children:`
        @keyframes slideInRight {
          from { transform: translateX(100%); }
          to { transform: translateX(0); }
        }
        @keyframes toastIn {
          from { transform: translateY(20px); opacity: 0; }
          to { transform: translateY(0); opacity: 1; }
        }
      `})]}):null}const vs=[{id:1,label:"Appareil recu",message:"Bonjour {prenom}, votre {appareil} a bien ete pris en charge sous le numero {code}. Nous vous tiendrons informe de l'avancement. Klikphone 04 79 60 89 22"},{id:2,label:"Diagnostic en cours",message:"Bonjour {prenom}, le diagnostic de votre {appareil} est en cours. Nous reviendrons vers vous rapidement. Klikphone"},{id:3,label:"Devis a valider",message:"Bonjour {prenom}, le devis pour votre {appareil} est de {montant} EUR. Merci de nous confirmer votre accord. Klikphone 04 79 60 89 22"},{id:4,label:"En cours de reparation",message:"Bonjour {prenom}, la reparation de votre {appareil} est en cours. Klikphone"},{id:5,label:"Attente piece",message:"Bonjour {prenom}, nous sommes en attente d'une piece pour votre {appareil}. Nous vous previendrons des reception. Klikphone"},{id:6,label:"Appareil pret",message:"Bonjour {prenom}, votre {appareil} est pret ! Vous pouvez venir le recuperer a la boutique. Montant : {montant} EUR. Klikphone 79 Place Saint Leger, Chambery"},{id:7,label:"Commande arrivee",message:"Bonjour {prenom}, la piece commandee pour votre {appareil} est arrivee. Nous lancons la reparation. Klikphone 04 79 60 89 22"},{id:8,label:"Non reparable",message:"Bonjour {prenom}, malheureusement votre {appareil} n'est pas reparable. Vous pouvez passer recuperer votre appareil en boutique. Klikphone"},{id:9,label:"Rappel RDV",message:"Bonjour {prenom}, nous vous rappelons votre rendez-vous demain pour votre {appareil}. Klikphone 79 Place Saint Leger, Chambery"},{id:10,label:"Personnalise",message:""}],ws={1:"ðŸ“±",2:"ðŸ”",3:"ðŸ“‹",4:"ðŸ”§",5:"â³",6:"âœ…",7:"ðŸ“¦",8:"âŒ",9:"ðŸ“…",10:"âœï¸"};function ys({ticket:u,onMessageSent:$}){const i=gt(),{user:c}=ft(),[_,M]=r.useState(vs),[p,I]=r.useState(null),[O,q]=r.useState(""),[D,P]=r.useState(null);r.useEffect(()=>{x.getMessageTemplates().then(m=>{m&&m.length>0&&M(m)}).catch(()=>{})},[]);const N=u,K=N.modele_autre||`${N.marque||""} ${N.modele||""}`.trim()||"appareil",S=parseFloat(N.tarif_final)||parseFloat(N.devis_estime)||0,W=parseFloat(N.reduction_pourcentage)||0,J=parseFloat(N.reduction_montant)||0,R=W>0?S*(W/100):J,L=Math.max(0,S-R),F=m=>m.replace(/\{prenom\}/g,N.client_prenom||"").replace(/\{nom\}/g,N.client_nom||"").replace(/\{appareil\}/g,K).replace(/\{code\}/g,N.ticket_code||"").replace(/\{montant\}/g,String(L)).replace(/\{adresse\}/g,"79 Place Saint Leger, 73000 Chambery").replace(/\{horaires\}/g,"Lundi-Samedi 10h-19h").replace(/\{tel_boutique\}/g,"04 79 60 89 22"),w=_.find(m=>m.id===p),C=p===10,T=C?O:w?F(w.message):"",V=(m,g)=>{let f=m.replace(/[\s\-\.]/g,"");f.startsWith("0")&&(f="33"+f.substring(1)),!f.startsWith("+")&&!f.startsWith("33")&&(f="33"+f),f=f.replace("+",""),window.open(`https://wa.me/${f}?text=${encodeURIComponent(g)}`,"_blank")},G=(m,g)=>{window.open(`sms:${m}?body=${encodeURIComponent(g)}`,"_blank")},z=async m=>{if(!T.trim()){i.error("Message vide");return}P(m);try{const g=N.client_tel,f=N.client_email;if(m==="whatsapp"){if(!g){i.error("Pas de telephone");return}V(g,T)}else if(m==="sms"){if(!g){i.error("Pas de telephone");return}G(g,T)}else if(m==="email"){if(!f){i.error("Ce client n'a pas d'adresse email");return}const y=await x.envoyerEmail(f,`Klikphone SAV - ${N.ticket_code}`,T);if(y.status!=="ok"){i.error(y.message||"Erreur d'envoi email");return}}const b=(c==null?void 0:c.utilisateur)||"Accueil",j=`[${w?w.label:"Message"}] ${T.substring(0,120)}${T.length>120?"...":""}`;await x.logMessage(N.id,b,j,m),i.success(m==="email"?"Email envoyÃ© avec succÃ¨s":`Message ${m} envoyÃ©`),$&&$()}catch(g){i.error(g.message||"Erreur envoi"),console.error(g)}finally{P(null)}};return e.jsxs("div",{className:"card p-5",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx("div",{className:"w-8 h-8 rounded-lg bg-green-50 flex items-center justify-center",children:e.jsx(Ne,{className:"w-4 h-4 text-green-600"})}),e.jsx("h2",{className:"text-sm font-semibold text-slate-800",children:"Messages"})]}),e.jsx("div",{className:"grid grid-cols-2 gap-1.5 mb-3",children:_.map(m=>e.jsxs("button",{onClick:()=>I(m.id===p?null:m.id),className:`text-left px-2.5 py-2 rounded-lg text-xs font-medium transition-all border ${p===m.id?"bg-brand-50 border-brand-300 text-brand-700 shadow-sm":"bg-white border-slate-150 text-slate-600 hover:bg-slate-50 hover:border-slate-200"}`,children:[e.jsx("span",{className:"mr-1",children:ws[m.id]||"ðŸ’¬"}),m.label]},m.id))}),p&&e.jsxs("div",{className:"animate-in",children:[C?e.jsx("textarea",{value:O,onChange:m=>q(m.target.value),placeholder:"Tapez votre message...",rows:3,className:"w-full px-3 py-2 rounded-lg border border-slate-200 text-sm resize-none focus:outline-none focus:ring-2 focus:ring-brand-500/20 focus:border-brand-500 mb-3"}):e.jsx("div",{className:"p-3 bg-slate-50 rounded-lg text-sm text-slate-700 leading-relaxed mb-3 border border-slate-100",children:T}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:()=>z("whatsapp"),disabled:!!D,className:"flex-1 flex items-center justify-center gap-1.5 py-2.5 rounded-lg bg-green-500 hover:bg-green-600 text-white text-xs font-bold transition-colors disabled:opacity-50",children:[D==="whatsapp"?e.jsx(ie,{className:"w-3.5 h-3.5"}):e.jsx(Ne,{className:"w-3.5 h-3.5"}),"WhatsApp"]}),e.jsxs("button",{onClick:()=>z("sms"),disabled:!!D,className:"flex-1 flex items-center justify-center gap-1.5 py-2.5 rounded-lg bg-white hover:bg-slate-50 text-slate-600 text-xs font-bold border border-slate-200 transition-colors disabled:opacity-50",children:[D==="sms"?e.jsx(ie,{className:"w-3.5 h-3.5"}):e.jsx(je,{className:"w-3.5 h-3.5"}),"SMS"]}),e.jsxs("button",{onClick:()=>z("email"),disabled:!!D,className:"flex-1 flex items-center justify-center gap-1.5 py-2.5 rounded-lg bg-white hover:bg-slate-50 text-slate-600 text-xs font-bold border border-slate-200 transition-colors disabled:opacity-50",children:[D==="email"?e.jsx(ie,{className:"w-3.5 h-3.5"}):e.jsx(ve,{className:"w-3.5 h-3.5"}),"Email"]})]})]})]})}function ut({title:u,icon:$,iconBg:i,iconColor:c,editing:_,onEdit:M,onSave:p,onCancel:I,children:O,viewContent:q}){return e.jsxs("div",{className:"card p-5",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:`w-8 h-8 rounded-lg ${i} flex items-center justify-center`,children:e.jsx($,{className:`w-4 h-4 ${c}`})}),e.jsx("h2",{className:"text-sm font-semibold text-slate-800",children:u})]}),_?e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsxs("button",{onClick:I,className:"btn-ghost text-xs px-2.5 py-1.5",children:[e.jsx(U,{className:"w-3.5 h-3.5"})," Annuler"]}),e.jsxs("button",{onClick:p,className:"btn-primary text-xs px-2.5 py-1.5",children:[e.jsx(Fe,{className:"w-3.5 h-3.5"})," Sauver"]})]}):e.jsx("button",{onClick:M,className:"btn-ghost p-1.5",title:"Modifier",children:e.jsx(fe,{className:"w-3.5 h-3.5"})})]}),_?O:q]})}const _s=new Set(["client","device","dates","notes","messages","reparation","status","fidelite"]),Re=[{id:"client",title:"Client",col:"left",order:0,size:"normal"},{id:"device",title:"Appareil",col:"left",order:1,size:"normal"},{id:"dates",title:"Dates",col:"left",order:2,size:"compact"},{id:"messages",title:"Messages",col:"left",order:3,size:"normal"},{id:"notes",title:"Notes internes",col:"left",order:4,size:"normal"},{id:"reparation",title:"RÃ©paration & Tarifs",col:"right",order:0,size:"large"},{id:"status",title:"Statut",col:"right",order:1,size:"compact"},{id:"fidelite",title:"FidÃ©litÃ©",col:"right",order:2,size:"compact"}];function Ms(){const{id:u}=ns(),$=rs(),{user:i}=ft(),c=gt(),_=(i==null?void 0:i.target)==="tech"?"/tech":"/accueil",M=(i==null?void 0:i.target)==="tech",[p,I]=r.useState(null),[O,q]=r.useState(!0),[D,P]=r.useState(!1),[N,K]=r.useState(""),[S,W]=r.useState(!0),[J,R]=r.useState(!1),[L,F]=r.useState(!1),[w,C]=r.useState(!1),[T,V]=r.useState(!1),[G,z]=r.useState(!1),[m,g]=r.useState({}),[f,b]=r.useState({}),[h,j]=r.useState({}),[y,Q]=r.useState([]),[yt,Le]=r.useState(!1),[_t,ce]=r.useState(!1),[we,X]=r.useState(!1),[Y,ze]=r.useState(""),[oe,Ct]=r.useState([]),[kt,Ie]=r.useState(!1),[le,St]=r.useState(0),[de,Oe]=r.useState([]),[Cs,ks]=r.useState(""),[Ss,Es]=r.useState(!1),[Et,me]=r.useState(!1),[Tt,Z]=r.useState(!1),[ye,ne]=r.useState(Re),[xe,qe]=r.useState(null),[H,Be]=r.useState(!1),[Ue,Ke]=r.useState([]),[Pt,_e]=r.useState(!1),[Ce,We]=r.useState(""),[Ve,ke]=r.useState(""),[Ye,He]=r.useState(!1),[At,Je]=r.useState(!1),Ge=t=>{try{if(t.reparation_supp&&t.reparation_supp.startsWith("["))return JSON.parse(t.reparation_supp)}catch{}const n=[];return t.panne&&n.push({label:t.panne,prix:t.devis_estime||0}),t.reparation_supp&&n.push({label:t.reparation_supp,prix:t.prix_supp||0}),n.length>0?n:[{label:"",prix:0}]},k=r.useCallback(async()=>{q(!0);try{const t=await x.getTicket(u);I(t),g({categorie:t.categorie||"",marque:t.marque||"",modele:t.modele||"",modele_autre:t.modele_autre||"",imei:t.imei||"",panne:t.panne||"",panne_detail:t.panne_detail||"",pin:t.pin||"",pattern:t.pattern||"",notes_client:t.notes_client||""}),b({nom:t.client_nom||"",prenom:t.client_prenom||"",telephone:t.client_tel||"",email:t.client_email||"",societe:t.client_societe||""}),j({devis_estime:t.devis_estime||"",tarif_final:t.tarif_final||"",acompte:t.acompte||"",technicien_assigne:t.technicien_assigne||"",type_ecran:t.type_ecran||"",date_recuperation:t.date_recuperation||"",reduction_montant:t.reduction_montant||"",reduction_pourcentage:t.reduction_pourcentage||"",commande_piece:t.commande_piece||0}),Q(Ge(t)),Ie(!!(t.attention||(t.notes_internes||"").includes("[ATTENTION]")));try{const n=await x.getPartsByTicket(t.id);Ke(n||[])}catch{Ke([])}}catch(t){console.error(t)}finally{q(!1)}},[u]);r.useEffect(()=>{k()},[k]);const Se=r.useCallback(async()=>{try{const t=await x.getNotes(u);Oe(t||[])}catch{Oe([])}},[u]);r.useEffect(()=>{Se()},[Se]),r.useEffect(()=>{x.getActiveTeam().then(Ct).catch(()=>{}),x.getConfig().then(t=>{const o=(Array.isArray(t)?t:[]).find(s=>s.cle==="tva");o&&St(parseFloat(o.valeur)||0)}).catch(()=>{}),x.getCaisseConfig().then(t=>Je(t.CAISSE_ENABLED==="1")).catch(()=>Je(!1))},[]),r.useEffect(()=>{if(i!=null&&i.utilisateur)try{const t=localStorage.getItem(`kp_layout_${i.utilisateur}`);if(t){const n=JSON.parse(t).filter(l=>_s.has(l.id)),o=new Set(n.map(l=>l.id)),s=Re.filter(l=>!o.has(l.id));n.length>0&&ne([...n,...s])}}catch{}},[i==null?void 0:i.utilisateur]);const $t=()=>{i!=null&&i.utilisateur&&(localStorage.setItem(`kp_layout_${i.utilisateur}`,JSON.stringify(ye)),c.success("Layout sauvegardÃ©"),Be(!1))},Mt=()=>{i!=null&&i.utilisateur&&(localStorage.removeItem(`kp_layout_${i.utilisateur}`),ne(Re),c.success("Layout rÃ©initialisÃ©"))},Dt=t=>{!xe||xe===t||(ne(n=>{const o=n.map(A=>({...A})),s=o.find(A=>A.id===xe),l=o.find(A=>A.id===t);if(!s||!l)return n;const d=s.col,v=s.order;return s.col=l.col,s.order=l.order,l.col=d,l.order=v,o}),qe(null))},Rt=t=>{ne(n=>n.map(o=>o.id===t?{...o,size:o.size==="compact"?"normal":o.size==="normal"?"large":"compact"}:o))},Ft=(t,n)=>{ne(o=>{const s=o.map(d=>({...d})),l=s.find(d=>d.id===t);return l?(l.col=n,l.order=s.filter(d=>d.col===n&&d.id!==t).length,s):o})},Lt=async()=>{P(!0);try{await x.updateTicket(u,m),F(!1),await k(),c.success("Appareil mis Ã  jour")}catch{c.error("Erreur sauvegarde appareil")}finally{P(!1)}},zt=async()=>{P(!0);try{await x.updateClient(p.client_id,f),C(!1),await k(),c.success("Client mis Ã  jour")}catch{c.error("Erreur sauvegarde client")}finally{P(!1)}},It=async()=>{P(!0);try{const t=y.reduce((v,A)=>v+(parseFloat(A.prix)||0),0),n=JSON.stringify(y.filter(v=>v.label));let o=parseFloat(h.reduction_montant)||0;const s=parseFloat(h.reduction_pourcentage)||0;s>0&&(o=t*(s/100));const l=parseFloat(h.tarif_final)||t-o||null,d={...h,devis_estime:parseFloat(h.devis_estime)||null,tarif_final:l,acompte:parseFloat(h.acompte)||null,reduction_montant:o||null,reduction_pourcentage:s||null,reparation_supp:n,prix_supp:t};await x.updateTicket(u,d),V(!1),await k(),c.success("Tarification mise Ã  jour")}catch{c.error("Erreur sauvegarde tarification")}finally{P(!1)}},Ot=async t=>{if(t==="Rendu au client"){if(p.telephone_pret&&!p.telephone_pret_rendu){me(!0);return}Z(!0);return}try{await x.changeStatus(u,t),await k(),c.success(`Statut changÃ© : ${t}`)}catch{c.error("Erreur changement de statut")}},qt=async()=>{try{await x.updateTicket(u,{telephone_pret_rendu:1}),me(!1),Z(!0)}catch{c.error("Erreur")}},Bt=async()=>{try{await x.updateTicket(u,{paye:1}),await x.changeStatus(u,"Rendu au client"),await x.changeStatus(u,"ClÃ´turÃ©"),Z(!1),await k(),c.success("Ticket clÃ´turÃ©")}catch{c.error("Erreur")}},Ut=async()=>{try{await x.changeStatus(u,"Rendu au client"),Z(!1),await k(),c.success("Attention : ticket non payÃ©")}catch{c.error("Erreur")}},Qe=async()=>{if(Ce!=="caramail"){ke("Code incorrect");return}He(!0);try{await x.deleteTicket(u),c.success("Ticket supprimÃ©"),$(_)}catch{c.error("Erreur lors de la suppression"),He(!1)}},Xe=async()=>{if(N.trim())try{const t=S?"[INTERNE]":"[CLIENT]";await x.addNote(u,`${t} ${N}`),K(""),await k(),c.success("Note ajoutÃ©e")}catch{c.error("Erreur ajout de note")}},Kt=async()=>{const t=prompt("Message de la note importante :");if(!(!t||!t.trim()))try{await x.addPrivateNote(u,(i==null?void 0:i.utilisateur)||"Accueil",t.trim(),!0),await x.updateTicket(u,{attention:t.trim()}),await k(),c.success("Note importante ajoutÃ©e")}catch{c.error("Erreur ajout attention")}},Wt=async()=>{try{const t=await x.togglePaye(u);await k(),c.success(t.paye?"MarquÃ© payÃ©":"MarquÃ© non payÃ©")}catch{c.error("Erreur toggle payÃ©")}},ee=(t,n)=>{j(o=>({...o,[t]:Math.max(0,(parseFloat(o[t])||0)+n).toString()}))},Vt=()=>{navigator.clipboard.writeText(p.ticket_code),R(!0),setTimeout(()=>R(!1),2e3)},Yt=async()=>{const t=p;if(!t)return;const n=y.filter(s=>s.label),o=`RÃ©paration ${t.marque||""} ${t.modele||t.modele_autre||""} - ${n.map(s=>s.label).join(" + ")}`.trim();try{const s=await x.envoyerCaisse({ticket_id:t.id,ticket_code:t.ticket_code,nom:t.client_nom||"",prenom:t.client_prenom||"",telephone:t.client_tel||"",email:t.client_email||"",description:o,montant:he});s.result==="OK"?(c.success(s.message||"Vente envoyÃ©e en caisse"),k()):c.error(s.message||"Erreur caisse")}catch(s){c.error(s.message||"Erreur envoi en caisse")}},Ht=()=>{if(!p)return"";const t=p,n=t.modele_autre||`${t.marque||""} ${t.modele||""}`.trim()||"appareil",o=y.filter(d=>d.label),s=o.reduce((d,v)=>d+(parseFloat(v.prix)||0),0),l=o.map(d=>`- ${d.label} : ${parseFloat(d.prix||0).toFixed(2)} EUR`).join(`
`);return`Bonjour ${t.client_prenom||""}, suite au diagnostic de votre ${n}, voici le dÃ©tail des rÃ©parations nÃ©cessaires :

${l}

Total : ${s.toFixed(2)} EUR

Merci de nous confirmer votre accord pour lancer la rÃ©paration.
Klikphone 04 79 60 89 22`},Jt=()=>{ze(Ht()),ce(!0)},Ee=async t=>{if(!Y.trim()){c.error("Message vide");return}X(!0);try{const n=p.client_tel,o=p.client_email;if(t==="whatsapp"){if(!n){c.error("Pas de tÃ©lÃ©phone"),X(!1);return}window.open(ht(n,Y),"_blank")}else if(t==="sms"){if(!n){c.error("Pas de tÃ©lÃ©phone"),X(!1);return}window.open(bt(n,Y),"_blank")}else if(t==="email"){if(!o){c.error("Ce client n'a pas d'adresse email"),X(!1);return}const d=await x.envoyerEmail(o,`Klikphone SAV - Accord ${p.ticket_code}`,Y);if(d.status!=="ok"){c.error(d.message||"Erreur d'envoi email"),X(!1);return}}await x.changeStatus(u,"En attente d'accord client");const s=(i==null?void 0:i.utilisateur)||"Accueil",l=`[Demande accord] ${Y.substring(0,120)}${Y.length>120?"...":""}`;await x.logMessage(u,s,l,t),ce(!1),await k(),c.success("Demande d'accord envoyÃ©e")}catch{c.error("Erreur envoi de la demande")}finally{X(!1)}},Ze=async t=>{try{if(t){await x.changeStatus(u,"En cours de rÃ©paration");const n=(i==null?void 0:i.utilisateur)||"Accueil";await x.addPrivateNote(u,n,"Accord client reÃ§u â€” rÃ©paration lancÃ©e"),c.success("Ticket en cours de rÃ©paration")}else{await x.changeStatus(u,"RÃ©paration terminÃ©e");const n=(i==null?void 0:i.utilisateur)||"Accueil";await x.addPrivateNote(u,n,"Client a refusÃ© la rÃ©paration"),c.success("Ticket marquÃ© non rÃ©parable")}await k()}catch{c.error("Erreur changement de statut")}},Gt=()=>{Q(t=>[...t,{label:"",prix:0}])},Qt=t=>{Q(n=>n.filter((o,s)=>s!==t))},et=(t,n,o)=>{Q(s=>s.map((l,d)=>d===t?{...l,[n]:o}:l))},tt=(t,n)=>{Q(o=>o.map((s,l)=>l===t?{...s,prix:Math.max(0,(parseFloat(s.prix)||0)+n)}:s))},pe=y.reduce((t,n)=>t+(parseFloat(n.prix)||0),0),Xt=parseFloat(h.reduction_montant)||0,ue=parseFloat(h.reduction_pourcentage)||0,Te=ue>0?pe*(ue/100):Xt,Pe=parseFloat(h.tarif_final)||pe-Te,st=le>0?Pe*(le/100):0,he=Pe+st,te=he-(parseFloat(h.acompte)||0);if(O)return e.jsx("div",{className:"flex items-center justify-center py-20",children:e.jsxs("div",{className:"flex flex-col items-center gap-3",children:[e.jsx("div",{className:"w-8 h-8 border-2 border-brand-600 border-t-transparent rounded-full animate-spin"}),e.jsx("p",{className:"text-sm text-slate-400",children:"Chargement..."})]})});if(!p)return e.jsxs("div",{className:"flex flex-col items-center justify-center py-20",children:[e.jsx("div",{className:"w-14 h-14 rounded-2xl bg-slate-100 flex items-center justify-center mb-4",children:e.jsx($e,{className:"w-7 h-7 text-slate-300"})}),e.jsx("p",{className:"text-slate-500 font-medium",children:"Ticket non trouvÃ©"}),e.jsxs("button",{onClick:()=>$(_),className:"btn-secondary mt-4",children:[e.jsx(Me,{className:"w-4 h-4"})," Retour au dashboard"]})]});const a=p,Zt=a.modele_autre||`${a.marque||""} ${a.modele||""}`.trim(),B=[];a.notes_internes&&a.notes_internes.split(`
`).filter(Boolean).forEach(t=>{t.includes("[INTERNE]");const n=t.includes("[CLIENT]"),o=t.includes("[ATTENTION]"),s=t.replace(/\[(INTERNE|CLIENT|ATTENTION)\]\s*/g,""),l=s.match(/^\[(\d{2}\/\d{2}\/?\d{0,4}\s?\d{2}:\d{2})\]\s*/),d=l?l[1]:"",v=l?s.replace(l[0],""):s;B.push({type:o?"attention":n?"client":"internal",text:v,timestamp:d,raw:t})}),a.historique&&a.historique.split(`
`).filter(Boolean).forEach(t=>{const n=t.match(/^\[(\d{2}\/\d{2}\s?\d{2}:\d{2})\]\s*/),o=n?n[1]:"",s=n?t.replace(n[0],""):t;B.push({type:"history",text:s,timestamp:o,raw:t})}),B.reverse();const es=t=>{var n,o;switch(t){case"client":return e.jsx(ut,{title:"Client",icon:rt,iconBg:"bg-blue-50",iconColor:"text-blue-600",editing:w,onEdit:()=>C(!0),onSave:zt,onCancel:()=>{C(!1),b({nom:a.client_nom||"",prenom:a.client_prenom||"",telephone:a.client_tel||"",email:a.client_email||"",societe:a.client_societe||""})},viewContent:e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("div",{className:"w-11 h-11 rounded-full bg-brand-100 flex items-center justify-center shrink-0",children:e.jsxs("span",{className:"text-brand-700 font-bold text-sm",children:[(((n=a.client_prenom)==null?void 0:n[0])||"").toUpperCase(),(((o=a.client_nom)==null?void 0:o[0])||"").toUpperCase()]})}),e.jsxs("div",{className:"min-w-0",children:[e.jsxs("p",{className:"text-base font-bold text-slate-900 truncate",children:[a.client_prenom||""," ",a.client_nom||""]}),a.client_societe&&e.jsx("p",{className:"text-xs text-slate-500",children:a.client_societe})]})]}),e.jsxs("div",{className:"space-y-2",children:[a.client_tel&&e.jsxs("a",{href:`tel:${a.client_tel}`,className:"flex items-center gap-2.5 text-sm text-slate-600 hover:text-brand-600 transition-colors",children:[e.jsx("div",{className:"w-8 h-8 rounded-lg bg-slate-100 flex items-center justify-center shrink-0",children:e.jsx(js,{className:"w-4 h-4 text-slate-500"})}),e.jsx("span",{className:"font-mono text-xs",children:a.client_tel})]}),a.client_email&&e.jsxs("a",{href:`mailto:${a.client_email}`,className:"flex items-center gap-2.5 text-sm text-slate-600 hover:text-brand-600 transition-colors",children:[e.jsx("div",{className:"w-8 h-8 rounded-lg bg-slate-100 flex items-center justify-center shrink-0",children:e.jsx(ve,{className:"w-4 h-4 text-slate-500"})}),e.jsx("span",{className:"text-xs truncate",children:a.client_email})]})]}),e.jsx("div",{className:"mt-4 pt-4 border-t border-slate-100",children:e.jsx("p",{className:"text-[10px] text-slate-400 text-center",children:"Messages dans le bloc Messages ci-dessous"})})]}),children:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"input-label",children:"PrÃ©nom"}),e.jsx("input",{value:f.prenom,onChange:s=>b(l=>({...l,prenom:s.target.value})),className:"input"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"input-label",children:"Nom"}),e.jsx("input",{value:f.nom,onChange:s=>b(l=>({...l,nom:s.target.value})),className:"input"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"input-label",children:"TÃ©lÃ©phone"}),e.jsx("input",{value:f.telephone,onChange:s=>b(l=>({...l,telephone:s.target.value})),className:"input font-mono"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"input-label",children:"Email"}),e.jsx("input",{value:f.email,onChange:s=>b(l=>({...l,email:s.target.value})),className:"input"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"input-label",children:"SociÃ©tÃ©"}),e.jsx("input",{value:f.societe,onChange:s=>b(l=>({...l,societe:s.target.value})),className:"input"})]})]})});case"device":return e.jsx(ut,{title:"Appareil",icon:$e,iconBg:"bg-brand-50",iconColor:"text-brand-600",editing:L,onEdit:()=>F(!0),onSave:Lt,onCancel:()=>{F(!1),g({categorie:a.categorie||"",marque:a.marque||"",modele:a.modele||"",modele_autre:a.modele_autre||"",imei:a.imei||"",panne:a.panne||"",panne_detail:a.panne_detail||"",pin:a.pin||"",pattern:a.pattern||"",notes_client:a.notes_client||""})},viewContent:e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 gap-x-6 gap-y-4 text-sm",children:[{label:"CatÃ©gorie",value:a.categorie},{label:"Marque",value:a.marque},{label:"ModÃ¨le",value:(a.modele&&a.modele!=="Autre"?a.modele:a.modele_autre)||a.modele||"â€”"},{label:"Panne",value:a.panne},{label:"IMEI / NÂ° sÃ©rie",value:a.imei,mono:!0},{label:"DÃ©tail panne",value:a.panne_detail}].map(({label:s,value:l,mono:d})=>e.jsxs("div",{children:[e.jsx("p",{className:"text-slate-400 text-xs mb-0.5",children:s}),e.jsx("p",{className:`font-medium text-slate-800 ${d?"font-mono text-xs":""}`,children:l||"â€”"})]},s))}),(a.pin||a.pattern)&&e.jsxs("div",{className:"mt-4 pt-4 border-t border-slate-100 flex flex-wrap gap-6",children:[a.pin&&e.jsxs("div",{children:[e.jsxs("p",{className:"text-slate-400 text-xs mb-1 flex items-center gap-1",children:[e.jsx(mt,{className:"w-3 h-3"})," Code PIN"]}),e.jsx("p",{className:"text-lg font-bold font-mono text-slate-800 tracking-widest",children:a.pin})]}),a.pattern&&e.jsxs("div",{children:[e.jsxs("p",{className:"text-slate-400 text-xs mb-1 flex items-center gap-1",children:[e.jsx(fs,{className:"w-3 h-3"})," Pattern"]}),e.jsx(is,{value:a.pattern,readOnly:!0,size:120})]})]}),a.notes_client&&e.jsxs("div",{className:"mt-4 p-3 bg-amber-50 border border-amber-100 rounded-lg text-sm text-amber-800",children:[e.jsx("span",{className:"font-semibold",children:"Note client :"})," ",a.notes_client]})]}),children:e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-3 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"input-label",children:"CatÃ©gorie"}),e.jsx("input",{value:m.categorie,onChange:s=>g(l=>({...l,categorie:s.target.value})),className:"input"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"input-label",children:"Marque"}),e.jsx("input",{value:m.marque,onChange:s=>g(l=>({...l,marque:s.target.value})),className:"input"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"input-label",children:"ModÃ¨le"}),e.jsx("input",{value:m.modele,onChange:s=>g(l=>({...l,modele:s.target.value})),className:"input"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"input-label",children:"Panne"}),e.jsx("input",{value:m.panne,onChange:s=>g(l=>({...l,panne:s.target.value})),className:"input"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"input-label",children:"IMEI"}),e.jsx("input",{value:m.imei,onChange:s=>g(l=>({...l,imei:s.target.value})),className:"input font-mono"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"input-label",children:"DÃ©tail panne"}),e.jsx("input",{value:m.panne_detail,onChange:s=>g(l=>({...l,panne_detail:s.target.value})),className:"input"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"input-label",children:"Code PIN"}),e.jsx("input",{value:m.pin,onChange:s=>g(l=>({...l,pin:s.target.value})),className:"input font-mono tracking-widest",maxLength:10})]}),e.jsxs("div",{children:[e.jsx("label",{className:"input-label",children:"Pattern"}),e.jsx("input",{value:m.pattern,onChange:s=>g(l=>({...l,pattern:s.target.value})),className:"input font-mono",placeholder:"1-5-9-6-3"})]}),e.jsxs("div",{className:"col-span-2 sm:col-span-3",children:[e.jsx("label",{className:"input-label",children:"Note client"}),e.jsx("textarea",{value:m.notes_client,onChange:s=>g(l=>({...l,notes_client:s.target.value})),className:"input resize-none",rows:2})]})]})});case"dates":return e.jsxs("div",{className:"card p-5",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx("div",{className:"w-8 h-8 rounded-lg bg-slate-100 flex items-center justify-center",children:e.jsx(gs,{className:"w-4 h-4 text-slate-500"})}),e.jsx("h2",{className:"text-sm font-semibold text-slate-800",children:"Dates"})]}),e.jsxs("div",{className:"space-y-3 text-sm",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-slate-500",children:"DÃ©pÃ´t"}),e.jsx("span",{className:"font-medium text-slate-800",children:Ae(a.date_depot)})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-slate-500",children:"Mise Ã  jour"}),e.jsx("span",{className:"font-medium text-slate-800",children:Ae(a.date_maj)})]}),a.date_cloture&&e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-slate-500",children:"ClÃ´ture"}),e.jsx("span",{className:"font-medium text-slate-800",children:Ae(a.date_cloture)})]}),a.date_recuperation&&(()=>{const s=new Date(a.date_recuperation),l=!isNaN(s.getTime()),d=new Date;let v="";if(l&&s>d){const A=s-d,re=Math.floor(A/864e5),lt=Math.floor(A%864e5/36e5);v=re>0?`dans ${re}j ${lt}h`:`dans ${lt}h`}else l&&s<=d&&(v="dÃ©passÃ©e");return e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-slate-500",children:"RÃ©cupÃ©ration"}),e.jsxs("div",{className:"text-right",children:[e.jsx("span",{className:"font-medium text-slate-800",children:l?s.toLocaleString("fr-FR",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"}):a.date_recuperation}),v&&e.jsx("span",{className:`ml-2 text-xs font-semibold ${s<=d?"text-red-500":"text-emerald-600"}`,children:v})]})]})})()]})]});case"messages":return e.jsx(ys,{ticket:a,onMessageSent:()=>Se()});case"notes":return e.jsxs("div",{className:"card p-5",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-8 h-8 rounded-lg bg-amber-50 flex items-center justify-center",children:e.jsx(Nt,{className:"w-4 h-4 text-amber-600"})}),e.jsx("h2",{className:"text-sm font-semibold text-slate-800",children:"Notes internes"}),e.jsx("span",{className:"text-[10px] text-slate-400",children:`${[...de,...B.filter(l=>l.type==="internal"||l.type==="client"||l.type==="attention")].length} note(s)`})]}),e.jsxs("button",{onClick:Kt,className:"btn-ghost text-xs gap-1 text-red-500 hover:bg-red-50",title:"Ajouter flag attention",children:[e.jsx(hs,{className:"w-3.5 h-3.5"})," Attention"]})]}),e.jsxs("div",{className:"flex gap-2 mb-4",children:[e.jsxs("div",{className:"flex-1 flex gap-2",children:[e.jsx("button",{onClick:()=>W(!S),className:`shrink-0 p-2.5 rounded-lg border transition-colors ${S?"bg-slate-50 border-slate-200 text-slate-500":"bg-blue-50 border-blue-200 text-blue-500"}`,title:S?"Note interne":"Note visible client",children:S?e.jsx(mt,{className:"w-4 h-4"}):e.jsx(bs,{className:"w-4 h-4"})}),e.jsx("input",{type:"text",value:N,onChange:s=>K(s.target.value),onKeyDown:s=>s.key==="Enter"&&Xe(),placeholder:S?"Note interne...":"Note visible par le client...",className:"input flex-1"})]}),e.jsx("button",{onClick:Xe,className:"btn-primary px-3",children:e.jsx(ae,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"max-h-80 overflow-y-auto divide-y divide-slate-100",children:[de.map(s=>{var re;const l=s.type_note||"note",d=l==="whatsapp"?{bg:"bg-green-100 text-green-700",label:"WhatsApp"}:l==="sms"?{bg:"bg-blue-100 text-blue-700",label:"SMS"}:l==="email"?{bg:"bg-amber-100 text-amber-700",label:"Email"}:null,v=(re=s.auteur)==null?void 0:re.toLowerCase().includes("tech"),A=s.important?"text-red-600 font-semibold":d?"text-slate-600":v?"text-blue-600":"text-emerald-600";return e.jsxs("div",{className:"flex items-start gap-2 py-1.5",children:[d&&e.jsx("span",{className:`text-[9px] font-bold px-1.5 py-0.5 rounded uppercase tracking-wider shrink-0 mt-0.5 ${d.bg}`,children:d.label}),!d&&l==="note"&&e.jsx("span",{className:"text-[9px] font-bold px-1.5 py-0.5 rounded bg-blue-50 text-blue-600 uppercase tracking-wider shrink-0 mt-0.5",children:s.auteur||"Note"}),e.jsx("span",{className:`text-sm flex-1 min-w-0 ${A}`,children:s.contenu}),e.jsx("span",{className:"text-[10px] text-slate-400 whitespace-nowrap shrink-0 mt-0.5",children:s.date_creation?new Date(s.date_creation).toLocaleString("fr-FR",{day:"2-digit",month:"2-digit",hour:"2-digit",minute:"2-digit"}):""})]},`db-${s.id}`)}),B.filter(s=>s.type!=="history").map((s,l)=>{const d=s.type==="attention"?"text-red-600 font-semibold":s.type==="internal"?"text-blue-600":"text-emerald-600";return e.jsxs("div",{className:"flex items-start gap-2 py-1.5",children:[e.jsx("span",{className:`text-sm flex-1 min-w-0 ${d}`,children:s.text}),s.timestamp&&e.jsx("span",{className:"text-[10px] text-slate-400 whitespace-nowrap shrink-0 mt-0.5",children:s.timestamp})]},`tl-${l}`)}),de.length===0&&B.filter(s=>s.type!=="history").length===0&&e.jsx("p",{className:"text-xs text-slate-400 text-center py-3",children:"Aucune note"})]}),B.filter(s=>s.type==="history").length>0&&e.jsxs("div",{className:"mt-4 pt-3 border-t border-slate-100",children:[e.jsx("p",{className:"text-[10px] text-slate-400 uppercase tracking-wider mb-2",children:"Historique"}),e.jsxs("div",{className:"relative max-h-48 overflow-y-auto pl-4",children:[e.jsx("div",{className:"absolute left-[9px] top-2 bottom-2 w-0.5 bg-slate-200"}),e.jsx("div",{className:"space-y-0.5",children:B.filter(s=>s.type==="history").map((s,l)=>e.jsxs("div",{className:"relative flex items-start gap-3 py-1.5 px-2 rounded-lg hover:bg-slate-50 transition-colors",children:[e.jsx("div",{className:"absolute -left-4 top-3 w-2 h-2 rounded-full bg-brand-400 z-10"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-xs text-slate-500",children:s.text}),s.timestamp&&e.jsx("span",{className:"text-[10px] text-slate-400",children:s.timestamp})]})]},l))})]})]})]});case"reparation":return e.jsxs("div",{className:"card p-5",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-8 h-8 rounded-lg bg-emerald-50 flex items-center justify-center",children:e.jsx(it,{className:"w-4 h-4 text-emerald-600"})}),e.jsx("h2",{className:"text-sm font-semibold text-slate-800",children:"RÃ©paration & Tarifs"})]}),!T&&e.jsx("button",{onClick:()=>V(!0),className:"btn-ghost p-1.5",title:"Modifier",children:e.jsx(fe,{className:"w-3.5 h-3.5"})}),T&&e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsxs("button",{onClick:()=>{V(!1),j({devis_estime:a.devis_estime||"",tarif_final:a.tarif_final||"",acompte:a.acompte||"",technicien_assigne:a.technicien_assigne||"",type_ecran:a.type_ecran||"",date_recuperation:a.date_recuperation||"",reduction_montant:a.reduction_montant||"",reduction_pourcentage:a.reduction_pourcentage||"",commande_piece:a.commande_piece||0}),Q(Ge(a))},className:"btn-ghost text-xs px-2.5 py-1.5",children:[e.jsx(U,{className:"w-3.5 h-3.5"})," Annuler"]}),e.jsxs("button",{onClick:It,className:"btn-primary text-xs px-2.5 py-1.5",children:[e.jsx(Fe,{className:"w-3.5 h-3.5"})," Sauver"]})]})]}),e.jsxs("div",{className:"mb-4 p-3 bg-slate-50 rounded-xl border border-slate-100",children:[e.jsx("div",{className:"text-[11px] text-slate-400 uppercase tracking-wider mb-2",children:"Technicien assignÃ©"}),M&&!G?e.jsxs("div",{className:"flex items-center gap-2",children:[(()=>{var l,d;const s=oe.find(v=>a.technicien_assigne===v.nom||(a.technicien_assigne||"").startsWith(v.nom+" "));return s?e.jsx("div",{className:"w-7 h-7 rounded-lg flex items-center justify-center text-white text-xs font-bold",style:{backgroundColor:s.couleur||"#94a3b8"},children:((l=a.technicien_assigne)==null?void 0:l.charAt(0))||"?"}):e.jsx("div",{className:"w-7 h-7 rounded-lg bg-slate-300 flex items-center justify-center text-white text-xs font-bold",children:((d=a.technicien_assigne)==null?void 0:d.charAt(0))||"?"})})(),e.jsx("span",{className:"text-sm font-semibold text-slate-800",children:a.technicien_assigne||"Non assignÃ©"}),e.jsx("button",{onClick:()=>z(!0),className:"text-slate-400 hover:text-brand-600 ml-auto",children:e.jsx(fe,{className:"w-3.5 h-3.5"})})]}):e.jsxs("div",{className:"flex items-center gap-2",children:[(()=>{const s=oe.find(l=>(a.technicien_assigne||"")===l.nom);return e.jsx("div",{className:"w-7 h-7 rounded-lg flex items-center justify-center text-white text-xs font-bold",style:{backgroundColor:(s==null?void 0:s.couleur)||"#94a3b8"},children:(a.technicien_assigne||G||"?").charAt(0)})})(),oe.length>0?e.jsxs("select",{value:a.technicien_assigne||"",onChange:async s=>{const l=s.target.value;if(l)try{await x.updateTicket(u,{technicien_assigne:l}),await k(),c.success(`AssignÃ© Ã  ${l}`),z(!1)}catch{c.error("Erreur assignation")}},className:"flex-1 px-3 py-1.5 rounded-lg border border-slate-200 text-sm font-semibold bg-white",children:[e.jsx("option",{value:"",children:"â€” Non assignÃ© â€”"}),oe.map(s=>e.jsxs("option",{value:s.nom,children:[s.nom,s.role?` (${s.role})`:""]},s.id))]}):e.jsx("input",{type:"text",value:h.technicien_assigne,onChange:s=>j(l=>({...l,technicien_assigne:s.target.value})),className:"flex-1 input text-sm",placeholder:"Nom du technicien"})]}),a.personne_charge&&e.jsxs("p",{className:"text-[10px] text-slate-400 mt-2",children:["Prise en charge : ",e.jsx("span",{className:"font-medium text-slate-600",children:a.personne_charge})]})]}),T?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("label",{className:"input-label mb-0",children:"Lignes de rÃ©paration"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("label",{className:"flex items-center gap-1.5 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:!!h.commande_piece,onChange:s=>j(l=>({...l,commande_piece:s.target.checked?1:0})),className:"w-3.5 h-3.5 rounded border-slate-300 text-amber-600 focus:ring-amber-500"}),e.jsxs("span",{className:"text-xs font-medium text-amber-700",children:[e.jsx(ot,{className:"w-3 h-3 inline mr-0.5"}),"PiÃ¨ce Ã  commander"]})]}),e.jsxs("button",{onClick:Gt,className:"btn-ghost text-xs px-2 py-1",children:[e.jsx(ae,{className:"w-3 h-3"})," Ajouter"]})]})]}),e.jsx("div",{className:"space-y-2",children:y.map((s,l)=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{value:s.label,onChange:d=>et(l,"label",d.target.value),className:"input flex-1",placeholder:"Description rÃ©paration"}),e.jsxs("div",{className:"relative w-28 shrink-0",children:[e.jsx("input",{type:"number",step:"0.01",value:s.prix,onChange:d=>et(l,"prix",d.target.value),className:"input text-right pr-7",placeholder:"0"}),e.jsx("span",{className:"absolute right-2.5 top-1/2 -translate-y-1/2 text-xs text-slate-400",children:"â‚¬"})]}),e.jsx("button",{onClick:()=>tt(l,-5),className:"btn-ghost p-1.5 shrink-0",children:e.jsx(ge,{className:"w-3 h-3"})}),e.jsx("button",{onClick:()=>tt(l,5),className:"btn-ghost p-1.5 shrink-0",children:e.jsx(ae,{className:"w-3 h-3"})}),y.length>1&&e.jsx("button",{onClick:()=>Qt(l),className:"btn-ghost p-1.5 shrink-0 text-red-400 hover:text-red-600",children:e.jsx(ct,{className:"w-3 h-3"})})]},l))}),e.jsxs("div",{className:"text-right mt-2",children:[e.jsx("span",{className:"text-xs text-slate-400",children:"Total :"}),e.jsx("span",{className:"text-sm font-bold text-slate-800 ml-2",children:E(pe)})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"input-label",children:"Devis estimÃ©"}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:()=>ee("devis_estime",-5),className:"btn-ghost p-1.5 shrink-0",children:e.jsx(ge,{className:"w-3 h-3"})}),e.jsxs("div",{className:"relative flex-1",children:[e.jsx("input",{type:"number",step:"0.01",value:h.devis_estime,onChange:s=>j(l=>({...l,devis_estime:s.target.value})),className:"input text-center pr-7"}),e.jsx("span",{className:"absolute right-2.5 top-1/2 -translate-y-1/2 text-xs text-slate-400",children:"â‚¬"})]}),e.jsx("button",{onClick:()=>ee("devis_estime",5),className:"btn-ghost p-1.5 shrink-0",children:e.jsx(ae,{className:"w-3 h-3"})})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"input-label",children:"Tarif final"}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:()=>ee("tarif_final",-5),className:"btn-ghost p-1.5 shrink-0",children:e.jsx(ge,{className:"w-3 h-3"})}),e.jsxs("div",{className:"relative flex-1",children:[e.jsx("input",{type:"number",step:"0.01",value:h.tarif_final,onChange:s=>j(l=>({...l,tarif_final:s.target.value})),className:"input text-center pr-7",placeholder:pe||""}),e.jsx("span",{className:"absolute right-2.5 top-1/2 -translate-y-1/2 text-xs text-slate-400",children:"â‚¬"})]}),e.jsx("button",{onClick:()=>ee("tarif_final",5),className:"btn-ghost p-1.5 shrink-0",children:e.jsx(ae,{className:"w-3 h-3"})})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"input-label",children:"Acompte"}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:()=>ee("acompte",-5),className:"btn-ghost p-1.5 shrink-0",children:e.jsx(ge,{className:"w-3 h-3"})}),e.jsxs("div",{className:"relative flex-1",children:[e.jsx("input",{type:"number",step:"0.01",value:h.acompte,onChange:s=>j(l=>({...l,acompte:s.target.value})),className:"input text-center pr-7"}),e.jsx("span",{className:"absolute right-2.5 top-1/2 -translate-y-1/2 text-xs text-slate-400",children:"â‚¬"})]}),e.jsx("button",{onClick:()=>ee("acompte",5),className:"btn-ghost p-1.5 shrink-0",children:e.jsx(ae,{className:"w-3 h-3"})})]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"input-label flex items-center gap-1",children:[e.jsx(dt,{className:"w-3 h-3"})," RÃ©duction (%)"]}),e.jsx("input",{type:"number",step:"1",min:"0",max:"100",value:h.reduction_pourcentage,onChange:s=>j(l=>({...l,reduction_pourcentage:s.target.value,reduction_montant:""})),className:"input",placeholder:"0"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"input-label",children:"RÃ©duction (â‚¬)"}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"number",step:"0.01",value:h.reduction_montant,onChange:s=>j(l=>({...l,reduction_montant:s.target.value,reduction_pourcentage:""})),className:"input pr-7",placeholder:"0"}),e.jsx("span",{className:"absolute right-2.5 top-1/2 -translate-y-1/2 text-xs text-slate-400",children:"â‚¬"})]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"input-label",children:"QualitÃ© Ã©cran"}),e.jsxs("select",{value:h.type_ecran,onChange:s=>j(l=>({...l,type_ecran:s.target.value})),className:"input",children:[e.jsx("option",{value:"",children:"â€”"}),e.jsx("option",{value:"Original",children:"Original (OEM)"}),e.jsx("option",{value:"Original reconditionnÃ©",children:"Original reconditionnÃ©"}),e.jsx("option",{value:"Compatible Premium",children:"Compatible Premium"}),e.jsx("option",{value:"Compatible",children:"Compatible"}),e.jsx("option",{value:"OLED",children:"OLED"}),e.jsx("option",{value:"OLED Premium",children:"OLED Premium"}),e.jsx("option",{value:"Incell",children:"Incell"}),e.jsx("option",{value:"LCD",children:"LCD"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"input-label",children:"Date rÃ©cupÃ©ration"}),e.jsx("input",{type:"datetime-local",value:h.date_recuperation,onChange:s=>j(l=>({...l,date_recuperation:s.target.value})),className:"input"})]})]})]}):e.jsxs(e.Fragment,{children:[Ue.length>0&&e.jsxs("div",{className:"mb-3 p-3 bg-amber-50 border border-amber-200 rounded-xl",children:[e.jsxs("div",{className:"text-[11px] font-bold text-amber-800 uppercase tracking-wider mb-2 flex items-center gap-1",children:[e.jsx(ot,{className:"w-3 h-3"})," PiÃ¨ce(s) commandÃ©e(s)"]}),Ue.map(s=>e.jsxs("div",{className:"flex items-center justify-between py-1.5 border-b border-amber-100 last:border-0",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold text-slate-700",children:s.description}),s.notes&&e.jsx("div",{className:"text-xs text-slate-500",children:s.notes}),s.fournisseur&&e.jsxs("div",{className:"text-xs text-slate-400",children:["Fournisseur : ",s.fournisseur]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[s.prix>0&&e.jsx("span",{className:"text-sm font-bold",children:E(s.prix)}),e.jsx("span",{className:`text-[10px] font-bold px-2 py-0.5 rounded-full ${s.statut==="En attente"?"bg-amber-100 text-amber-700":s.statut==="CommandÃ©e"?"bg-blue-100 text-blue-700":s.statut==="ExpÃ©diÃ©e"?"bg-purple-100 text-purple-700":s.statut==="ReÃ§ue"?"bg-green-100 text-green-700":"bg-red-100 text-red-700"}`,children:s.statut})]})]},s.id))]}),e.jsxs("div",{className:"mb-3",children:[y.filter(s=>s.label).map((s,l)=>e.jsxs("div",{className:"flex items-center justify-between py-2 border-b border-slate-50 last:border-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-sm font-medium text-slate-700",children:s.label}),a.type_ecran&&l===0&&e.jsx("span",{className:"text-[10px] font-semibold text-violet-600 bg-violet-50 px-2 py-0.5 rounded",children:a.type_ecran})]}),e.jsx("span",{className:"text-sm font-bold text-slate-800",children:E(s.prix)})]},l)),y.filter(s=>s.label).length===0&&e.jsx("p",{className:"text-sm text-slate-400 italic py-2",children:"Aucune rÃ©paration enregistrÃ©e"})]}),Te>0&&e.jsxs("div",{className:"flex justify-between py-1 text-sm text-emerald-600",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(dt,{className:"w-3 h-3"})," RÃ©duction",ue>0?` (${ue}%)`:""]}),e.jsxs("span",{className:"font-medium",children:["- ",E(Te)]})]}),e.jsxs("div",{className:"border-t border-slate-200 mt-2 pt-2 space-y-1",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-slate-500",children:le>0?"Sous-total HT":"Tarif final"}),e.jsx("span",{className:"font-semibold text-slate-800",children:E(Pe)})]}),le>0&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"text-slate-500",children:["TVA (",le,"%)"]}),e.jsx("span",{className:"font-medium text-slate-600",children:E(st)})]}),e.jsxs("div",{className:"flex justify-between text-sm font-bold border-t border-slate-200 pt-2",children:[e.jsx("span",{className:"text-slate-800",children:"Total TTC"}),e.jsx("span",{className:"text-slate-900",children:E(he)})]})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-slate-500",children:"Acompte versÃ©"}),e.jsxs("span",{className:"font-medium text-slate-800",children:["- ",a.acompte?E(a.acompte):"0,00 â‚¬"]})]})]}),te>0&&e.jsxs("div",{className:"flex justify-between mt-3 px-4 py-3 rounded-xl bg-gradient-to-r from-emerald-50 to-green-50 border border-emerald-200",children:[e.jsx("span",{className:"font-extrabold text-emerald-700 text-[15px]",children:"RESTE Ã€ PAYER"}),e.jsx("span",{className:"font-extrabold text-emerald-700 text-[15px]",children:E(te)})]}),e.jsxs("div",{className:"flex gap-2 mt-3 flex-wrap",children:[e.jsxs("button",{onClick:Wt,className:`px-3 py-2 rounded-lg text-xs font-semibold transition-colors ${a.paye?"bg-emerald-500 text-white":"bg-emerald-50 text-emerald-700 border border-emerald-200 hover:bg-emerald-100"}`,children:[e.jsx(be,{className:"w-3.5 h-3.5 inline mr-1"}),a.paye?"PayÃ© âœ“":"Marquer payÃ©"]}),At&&e.jsxs("button",{onClick:Yt,className:"px-3 py-2 rounded-lg bg-amber-500 text-white text-xs font-semibold hover:bg-amber-600",children:[e.jsx(us,{className:"w-3.5 h-3.5 inline mr-1"}),"Envoyer en caisse"]}),e.jsxs("button",{onClick:Jt,className:"px-3 py-2 rounded-lg bg-orange-50 text-orange-600 text-xs font-semibold border border-orange-200 hover:bg-orange-100",children:[e.jsx(De,{className:"w-3.5 h-3.5 inline mr-1"}),"Accord client"]})]})]})]});case"status":return e.jsxs("div",{className:"card p-5",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx("div",{className:"w-8 h-8 rounded-lg flex items-center justify-center",style:{backgroundColor:se(a.statut).color+"20"},children:e.jsx(wt,{className:"w-4 h-4",style:{color:se(a.statut).color}})}),e.jsx("h2",{className:"text-sm font-semibold text-slate-800",children:"Changer le statut"})]}),e.jsx("select",{value:a.statut,onChange:s=>Ot(s.target.value),className:"w-full py-3 px-4 text-base font-semibold rounded-xl border-2 transition-colors cursor-pointer appearance-none bg-no-repeat",style:{borderColor:se(a.statut).color,color:se(a.statut).color,backgroundColor:se(a.statut).color+"10",backgroundImage:`url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='${encodeURIComponent(se(a.statut).color)}' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E")`,backgroundPosition:"right 12px center",backgroundSize:"20px"},children:ls.map(s=>e.jsx("option",{value:s,children:s},s))}),a.statut==="En attente d'accord client"&&e.jsxs("div",{className:"mt-3 p-3 bg-orange-50 border border-orange-200 rounded-xl space-y-2",children:[e.jsx("p",{className:"text-[11px] font-semibold text-orange-700 uppercase tracking-wider",children:"RÃ©ponse du client"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:()=>Ze(!0),className:"flex-1 py-2 px-3 rounded-lg bg-emerald-50 text-emerald-700 text-xs font-bold border border-emerald-200 hover:bg-emerald-100 transition-colors",children:[e.jsx(ie,{className:"w-3.5 h-3.5 inline mr-1"}),"Client a validÃ©"]}),e.jsxs("button",{onClick:()=>Ze(!1),className:"flex-1 py-2 px-3 rounded-lg bg-red-50 text-red-600 text-xs font-bold border border-red-200 hover:bg-red-100 transition-colors",children:[e.jsx(U,{className:"w-3.5 h-3.5 inline mr-1"}),"Client a refusÃ©"]})]})]})]});case"fidelite":return a.client_id&&!M?e.jsx(as,{clientId:a.client_id}):null;default:return null}},at=t=>{const n=es(t.id);if(!n)return null;if(!H)return e.jsx("div",{children:n},t.id);const o=t.size==="compact"?"S":t.size==="large"?"L":"M";return e.jsxs("div",{draggable:!0,onDragStart:()=>qe(t.id),onDragOver:s=>s.preventDefault(),onDrop:s=>{s.preventDefault(),Dt(t.id)},className:`relative group rounded-xl transition-all ${xe===t.id?"opacity-40 scale-[0.98]":""} ${H?"ring-2 ring-dashed ring-slate-200 hover:ring-brand-400":""}`,children:[e.jsxs("div",{className:"absolute -top-3 left-3 flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity z-10",children:[e.jsxs("span",{className:"px-2 py-0.5 bg-brand-600 text-white text-[10px] rounded-full font-medium cursor-grab active:cursor-grabbing shadow-sm",children:["â ¿ ",t.title]}),e.jsx("button",{onClick:()=>Rt(t.id),className:"px-1.5 py-0.5 bg-slate-700 text-white text-[10px] rounded-full hover:bg-slate-600 shadow-sm",children:o}),e.jsx("button",{onClick:()=>Ft(t.id,t.col==="left"?"right":"left"),className:"px-1.5 py-0.5 bg-slate-700 text-white text-[10px] rounded-full hover:bg-slate-600 shadow-sm",children:t.col==="left"?"â†’":"â†"})]}),e.jsx("div",{className:t.size==="compact"?"max-h-52 overflow-hidden":"",children:n})]},t.id)};return e.jsxs("div",{className:"max-w-7xl mx-auto",children:[e.jsx("div",{className:"bg-gradient-to-br from-slate-800 to-slate-900 text-white px-4 sm:px-6 lg:px-8 py-8 sm:py-10 -mx-4 sm:-mx-6 lg:-mx-8 -mt-4 sm:-mt-6 lg:-mt-8 mb-6",children:e.jsxs("div",{className:"max-w-7xl mx-auto",children:[e.jsxs("button",{onClick:()=>$(-1),className:"flex items-center gap-1.5 text-slate-400 hover:text-white transition-colors mb-5 -ml-1",children:[e.jsx(Me,{className:"w-4 h-4"}),e.jsx("span",{className:"text-xs font-medium",children:"Retour"})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-start gap-5",children:[e.jsxs("div",{className:"flex-1 min-w-0 space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("h1",{className:"text-2xl sm:text-3xl font-display font-bold text-white font-mono tracking-tight",children:a.ticket_code}),e.jsx("button",{onClick:Vt,className:"p-1.5 rounded-lg hover:bg-white/10 transition-colors",title:"Copier le code",children:J?e.jsx(ie,{className:"w-4 h-4 text-emerald-400"}):e.jsx(jt,{className:"w-4 h-4 text-slate-400"})}),a.paye&&e.jsxs("span",{className:"px-2.5 py-1 rounded-full bg-emerald-500/20 text-emerald-300 text-xs font-bold flex items-center gap-1",children:[e.jsx(be,{className:"w-3.5 h-3.5"})," PayÃ©"]})]}),e.jsxs("div",{className:"text-sm text-slate-300 flex flex-wrap items-center gap-x-2 gap-y-1",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(rt,{className:"w-3.5 h-3.5 text-slate-500"})," ",a.client_prenom||""," ",a.client_nom||""]}),e.jsx("span",{className:"text-slate-600",children:"â€¢"}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx($e,{className:"w-3.5 h-3.5 text-slate-500"})," ",Zt||"â€”"]}),e.jsx("span",{className:"text-slate-600",children:"â€¢"}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(it,{className:"w-3.5 h-3.5 text-slate-500"}),y.filter(t=>t.label).length>0?y.filter(t=>t.label).map(t=>t.label).join(" + "):a.panne||"â€”"]}),e.jsx("span",{className:"text-slate-600",children:"â€¢"}),e.jsx("span",{className:"font-semibold text-emerald-400",children:E(he||0)}),a.paye&&e.jsx("span",{className:"text-xs bg-emerald-500/20 text-emerald-300 px-2 py-0.5 rounded-full",children:"PayÃ©"}),!a.paye&&te>0&&e.jsxs("span",{className:"text-xs bg-amber-500/20 text-amber-300 px-2 py-0.5 rounded-full",children:["Reste ",E(te)]})]}),a.client_tel&&e.jsx("a",{href:`tel:${a.client_tel}`,className:"text-sm text-slate-400 hover:text-white font-mono transition-colors",children:a.client_tel})]}),e.jsxs("div",{className:"flex sm:flex-col items-center sm:items-end gap-3 shrink-0",children:[e.jsx(ts,{statut:a.statut,size:"lg"}),e.jsxs("button",{onClick:()=>Le(!0),className:"flex items-center gap-2 px-4 py-2 rounded-lg bg-white/10 hover:bg-white/20 text-slate-300 hover:text-white text-sm font-medium transition-colors",children:[e.jsx(vt,{className:"w-4 h-4"})," Imprimer"]})]})]})]})}),_t&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 bg-black/60 backdrop-blur-sm z-50",onClick:()=>ce(!1)}),e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-lg p-6 animate-in max-h-[90vh] overflow-y-auto",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-5",children:[e.jsx("div",{className:"w-10 h-10 rounded-xl bg-orange-100 flex items-center justify-center",children:e.jsx(De,{className:"w-5 h-5 text-orange-600"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-display font-bold text-slate-900",children:"Demande d'accord client"}),e.jsxs("p",{className:"text-sm text-slate-500",children:[a.ticket_code," â€” ",a.client_prenom," ",a.client_nom]})]}),e.jsx("button",{onClick:()=>ce(!1),className:"ml-auto btn-ghost p-1.5",children:e.jsx(U,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"p-4 bg-slate-50 border border-slate-200 rounded-xl mb-4",children:[e.jsx("div",{className:"text-[11px] font-bold text-slate-500 uppercase tracking-wider mb-2",children:"RÃ©capitulatif des rÃ©parations"}),y.filter(t=>t.label).map((t,n)=>e.jsxs("div",{className:"flex justify-between py-1.5 border-b border-slate-100 last:border-0",children:[e.jsxs("span",{className:"text-sm text-slate-700",children:[t.label,a.type_ecran&&n===0&&e.jsx("span",{className:"text-[10px] font-semibold text-violet-600 bg-violet-50 px-1.5 py-0.5 rounded ml-2",children:a.type_ecran})]}),e.jsx("span",{className:"text-sm font-bold text-slate-800",children:E(t.prix)})]},n)),e.jsxs("div",{className:"flex justify-between pt-2 mt-1 border-t border-slate-300",children:[e.jsx("span",{className:"text-sm font-bold text-slate-900",children:"Total"}),e.jsx("span",{className:"text-sm font-bold text-emerald-700",children:E(y.filter(t=>t.label).reduce((t,n)=>t+(parseFloat(n.prix)||0),0))})]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"text-xs font-semibold text-slate-600 mb-1 block",children:"Message au client"}),e.jsx("textarea",{value:Y,onChange:t=>ze(t.target.value),rows:7,className:"w-full px-3 py-2.5 rounded-xl border border-slate-200 text-sm resize-none focus:outline-none focus:ring-2 focus:ring-orange-500/20 focus:border-orange-500"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:()=>Ee("whatsapp"),disabled:we,className:"flex-1 flex items-center justify-center gap-1.5 py-2.5 rounded-lg bg-green-500 hover:bg-green-600 text-white text-xs font-bold transition-colors disabled:opacity-50",children:[e.jsx(Ne,{className:"w-3.5 h-3.5"})," WhatsApp"]}),e.jsxs("button",{onClick:()=>Ee("sms"),disabled:we,className:"flex-1 flex items-center justify-center gap-1.5 py-2.5 rounded-lg bg-white hover:bg-slate-50 text-slate-600 text-xs font-bold border border-slate-200 transition-colors disabled:opacity-50",children:[e.jsx(je,{className:"w-3.5 h-3.5"})," SMS"]}),e.jsxs("button",{onClick:()=>Ee("email"),disabled:we,className:"flex-1 flex items-center justify-center gap-1.5 py-2.5 rounded-lg bg-white hover:bg-slate-50 text-slate-600 text-xs font-bold border border-slate-200 transition-colors disabled:opacity-50",children:[e.jsx(ve,{className:"w-3.5 h-3.5"})," Email"]})]})]})})]}),Et&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 bg-black/60 backdrop-blur-sm z-50",onClick:()=>me(!1)}),e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 animate-in",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("div",{className:"w-10 h-10 rounded-xl bg-amber-100 flex items-center justify-center",children:e.jsx(ps,{className:"w-5 h-5 text-amber-600"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-display font-bold text-slate-900",children:"TÃ©lÃ©phone de prÃªt"}),e.jsx("p",{className:"text-sm text-slate-500",children:"Ce client a un tÃ©lÃ©phone de prÃªt !"})]})]}),e.jsxs("div",{className:"p-4 bg-amber-50 border border-amber-200 rounded-xl mb-4",children:[e.jsxs("p",{className:"text-sm font-semibold text-amber-800",children:["TÃ©lÃ©phone prÃªtÃ© : ",p.telephone_pret]}),p.telephone_pret_imei&&e.jsxs("p",{className:"text-xs text-amber-600 font-mono mt-1",children:["IMEI : ",p.telephone_pret_imei]}),e.jsx("p",{className:"text-xs text-amber-700 mt-2 font-medium",children:"Pensez Ã  rÃ©cupÃ©rer le tÃ©lÃ©phone de prÃªt avant de rendre l'appareil au client !"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>me(!1),className:"btn-ghost flex-1",children:"Annuler"}),e.jsx("button",{onClick:qt,className:"btn-primary flex-1",children:"TÃ©lÃ©phone rÃ©cupÃ©rÃ©, rendre au client"})]})]})})]}),Tt&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 bg-black/60 backdrop-blur-sm z-50",onClick:()=>Z(!1)}),e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 animate-in",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-5",children:[e.jsx("div",{className:"w-10 h-10 rounded-xl bg-emerald-100 flex items-center justify-center",children:e.jsx(be,{className:"w-5 h-5 text-emerald-600"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-display font-bold text-slate-900",children:"Rendu au client"}),e.jsx("p",{className:"text-sm text-slate-500",children:"Le client a-t-il rÃ©glÃ© ?"})]})]}),te>0&&e.jsxs("div",{className:"p-4 bg-gradient-to-br from-emerald-50 to-green-50 border border-emerald-200 rounded-xl mb-5 text-center",children:[e.jsx("p",{className:"text-xs text-emerald-600 font-medium mb-1",children:"Reste Ã  payer"}),e.jsx("p",{className:"text-2xl font-extrabold text-emerald-700",children:E(te)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("button",{onClick:Bt,className:"w-full py-3 px-4 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white text-sm font-bold transition-colors flex items-center justify-center gap-2",children:[e.jsx(be,{className:"w-4 h-4"})," Oui, payÃ©"]}),e.jsxs("button",{onClick:Ut,className:"w-full py-3 px-4 rounded-xl bg-red-50 hover:bg-red-100 text-red-600 text-sm font-bold border border-red-200 transition-colors flex items-center justify-center gap-2",children:[e.jsx(U,{className:"w-4 h-4"})," Non, pas payÃ©"]}),e.jsxs("button",{onClick:()=>Z(!1),className:"w-full py-2.5 px-4 rounded-xl text-slate-400 hover:text-slate-600 text-sm font-medium transition-colors flex items-center justify-center gap-1",children:[e.jsx(Me,{className:"w-3.5 h-3.5"})," Annuler"]})]})]})})]}),Pt&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 bg-black/60 backdrop-blur-sm z-50",onClick:()=>_e(!1)}),e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 animate-in",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("div",{className:"w-10 h-10 rounded-xl bg-red-100 flex items-center justify-center",children:e.jsx(ct,{className:"w-5 h-5 text-red-600"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-display font-bold text-slate-900",children:"Supprimer le ticket"}),e.jsx("p",{className:"text-sm text-slate-500",children:a.ticket_code})]})]}),e.jsx("p",{className:"text-sm text-slate-600 mb-4",children:"Cette action est irrÃ©versible. Toutes les donnÃ©es liÃ©es (notes, commandes, historique) seront supprimÃ©es."}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"input-label",children:"Code administrateur"}),e.jsx("input",{type:"password",value:Ce,onChange:t=>{We(t.target.value),ke("")},onKeyDown:t=>t.key==="Enter"&&Qe(),className:"input",placeholder:"Entrez le code admin",autoFocus:!0}),Ve&&e.jsx("p",{className:"text-xs text-red-500 mt-1 font-medium",children:Ve})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>_e(!1),className:"btn-ghost flex-1",children:"Annuler"}),e.jsx("button",{onClick:Qe,disabled:Ye||!Ce,className:"flex-1 py-2.5 px-4 rounded-xl bg-red-600 hover:bg-red-700 text-white text-sm font-semibold transition-colors disabled:opacity-50 flex items-center justify-center gap-2",children:Ye?"Suppression...":"Supprimer"})]})]})})]}),e.jsxs("div",{className:"px-4 sm:px-6 lg:px-8",children:[(()=>{const t=de.filter(n=>n.important);return!kt&&t.length===0?null:(t.length>0&&t[0],e.jsxs("div",{className:"flex items-start gap-3 p-4 mb-5 rounded-xl bg-red-50 border border-red-200 shadow-sm animate-in",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-red-500 flex items-center justify-center shrink-0",children:e.jsx(De,{className:"w-5 h-5 text-white"})}),e.jsxs("div",{className:"flex-1 min-w-0 space-y-1",children:[e.jsx("p",{className:"text-sm font-bold text-red-800",children:"Note importante"}),t.map(n=>e.jsx("p",{className:"text-sm text-red-700",children:n.contenu.replace(/^\[ATTENTION\]\s*âš ?\s*/i,"")},n.id)),t.length===0&&a.attention&&e.jsx("p",{className:"text-sm text-red-700",children:a.attention})]}),e.jsx("button",{onClick:()=>Ie(!1),className:"shrink-0 p-1 rounded-lg text-red-300 hover:text-red-600 hover:bg-red-100 transition-colors",children:e.jsx(U,{className:"w-4 h-4"})})]}))})(),e.jsx("div",{className:"card p-5 mb-6",children:e.jsx(ss,{statut:a.statut,hasPiece:a.commande_piece===1})}),e.jsxs("div",{className:"flex items-center gap-2 mb-5",children:[e.jsxs("button",{onClick:()=>Be(!H),className:`flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-medium transition-colors ${H?"bg-brand-600 text-white":"bg-slate-100 text-slate-600 hover:bg-slate-200"}`,children:[e.jsx(fe,{className:"w-3.5 h-3.5"}),H?"Mode Ã©dition":"Personnaliser"]}),H&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:$t,className:"btn-primary text-xs px-3 py-1.5",children:[e.jsx(Fe,{className:"w-3.5 h-3.5"})," Sauver"]}),e.jsx("button",{onClick:Mt,className:"btn-ghost text-xs px-3 py-1.5",children:"RÃ©initialiser"})]})]}),H&&e.jsx("div",{className:"p-3 mb-5 rounded-lg bg-brand-50 border border-brand-200 text-xs text-brand-700",children:"Glissez-dÃ©posez les blocs pour rÃ©organiser. Cliquez S/M/L pour changer la taille, les flÃ¨ches pour dÃ©placer entre colonnes."}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-[55fr_45fr] gap-5",children:[e.jsx("div",{className:"space-y-5",children:ye.filter(t=>t.col==="left").sort((t,n)=>t.order-n.order).map(at)}),e.jsx("div",{className:"space-y-5",children:ye.filter(t=>t.col==="right").sort((t,n)=>t.order-n.order).map(at)})]})]}),e.jsx("div",{className:"mt-10 mb-4 text-center",children:e.jsx("button",{onClick:()=>{_e(!0),We(""),ke("")},className:"text-xs text-slate-400 hover:text-red-500 transition-colors",children:"Supprimer ce ticket"})}),e.jsx(Ns,{open:yt,onClose:()=>Le(!1),ticketId:u,ticketCode:a.ticket_code,clientTel:a.client_tel,clientEmail:a.client_email})]})}export{Ms as default};
