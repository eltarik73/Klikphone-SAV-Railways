import{a as x,j as e,w as bt,s as gt,c as ft,u as jt,b as S,d as ts,P as ss,F as as,g as ae,S as ls,e as $e}from"./index-D0nULZW-.js";import{r,c as ns,u as rs}from"./vendor-react-DMwujlca.js";import{P as is}from"./PatternGrid-CIV3F5XA.js";import{N as rt,O as cs,Q as Nt,F as vt,X as Y,Y as wt,Z as os,q as Ne,C as yt,l as ve,G as we,_ as ds,$ as ms,a0 as xs,a1 as ce,b as Me,A as De,k as ge,a2 as it,W as ct,j as Re,a3 as ps,o as ot,a4 as je,a5 as Le,P as dt,z as le,a6 as fe,a7 as mt,a8 as us,a9 as hs,m as xt,aa as bs,x as gs,e as fs,v as js}from"./vendor-icons-DnXwj2oL.js";const pt=[{type:"client",label:"Client",desc:"ReÃ§u de dÃ©pÃ´t",icon:rt},{type:"staff",label:"Atelier",desc:"Fiche technicien",icon:cs},{type:"combined",label:"Double",desc:"Client + Atelier",icon:Nt},{type:"devis",label:"Devis",desc:"Devis dÃ©taillÃ©",icon:vt},{type:"recu",label:"ReÃ§u",desc:"ReÃ§u de paiement",icon:rt}],ut=new Set(["devis","recu"]);function Ns({open:u,onClose:D,ticketId:i,ticketCode:c,clientTel:y,clientEmail:R}){const[p,B]=r.useState("client"),U=r.useRef(null),[K,E]=r.useState(!0),[P,j]=r.useState(!1),[H,C]=r.useState(!1),[J,X]=r.useState(!1),[F,z]=r.useState(null),[A,I]=r.useState(!1),$=x.getPrintUrl(i,p),N=pt.find(h=>h.type===p),O=ut.has(p),T=O&&A;r.useEffect(()=>(u?(B("client"),I(!1),z(null),document.body.style.overflow="hidden"):document.body.style.overflow="",()=>{document.body.style.overflow=""}),[u]),r.useEffect(()=>{u&&(E(!0),I(!1))},[p]),r.useEffect(()=>{u&&E(!0)},[A]),r.useEffect(()=>{if(!F)return;const h=setTimeout(()=>z(null),4e3);return()=>clearTimeout(h)},[F]);const W=async()=>{j(!0);try{const k=await(await fetch($)).text(),q=window.open("","_blank");if(!q){window.open($,"_blank");return}q.document.write(k),q.document.close(),q.focus(),setTimeout(()=>{q.print()},300)}catch{window.open($,"_blank")}finally{j(!1)}},m=()=>{window.open($,"_blank")},b=()=>{window.open(x.getPdfUrl(i,p),"_blank")},g=()=>T?x.getSharePdfUrl(i,p):x.getSharePrintUrl(i,p),L=()=>{if(!y)return;const h=g(),k=`Bonjour, voici votre ${(N==null?void 0:N.desc)||"document"} pour le ticket ${c}.

${h.trim()}`;window.open(bt(y,k),"_blank"),C(!1)},f=()=>{if(!y)return;const h=g(),k=`Klikphone - ${(N==null?void 0:N.desc)||"document"} ${c}
${h.trim()}`;window.open(gt(y,k),"_blank"),C(!1)},w=async()=>{if(R){X(!0);try{const h=await x.sendDocument(i,p,R);h.status==="ok"?(C(!1),z({type:"success",message:`Email envoyÃ© avec succÃ¨s Ã  ${R}`})):z({type:"error",message:h.detail||"Erreur lors de l'envoi de l'email"})}catch{z({type:"error",message:"Erreur lors de l'envoi de l'email"})}finally{X(!1)}}};return u?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 bg-black/50 backdrop-blur-sm z-50 transition-opacity",onClick:D}),e.jsxs("div",{className:"fixed inset-y-0 right-0 w-full sm:w-[520px] lg:w-[600px] bg-white shadow-2xl z-50 flex flex-col animate-in",style:{animationName:"slideInRight",animationDuration:"300ms"},children:[e.jsxs("div",{className:"flex items-center justify-between px-5 py-4 border-b border-slate-100 shrink-0",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-base font-display font-bold text-slate-900",children:"Impression"}),e.jsxs("p",{className:"text-xs text-slate-400 mt-0.5",children:["Ticket ",c]})]}),e.jsx("button",{onClick:D,className:"p-2 rounded-lg hover:bg-slate-100 text-slate-400 hover:text-slate-600 transition-colors",children:e.jsx(Y,{className:"w-5 h-5"})})]}),e.jsx("div",{className:"flex gap-1 px-5 py-3 border-b border-slate-100 overflow-x-auto scrollbar-none shrink-0 bg-slate-50/50",children:pt.map(({type:h,label:k,icon:q})=>e.jsxs("button",{onClick:()=>{B(h),E(!0)},className:`flex items-center gap-1.5 px-3 py-2 rounded-lg text-xs font-medium whitespace-nowrap transition-all ${p===h?"bg-brand-600 text-white shadow-sm shadow-brand-600/25":"text-slate-500 hover:bg-white hover:text-slate-700 hover:shadow-sm"}`,children:[e.jsx(q,{className:"w-3.5 h-3.5"}),k,e.jsx("span",{className:`text-[9px] px-1 py-0.5 rounded ${p===h?"bg-white/20":"bg-slate-200 text-slate-500"}`,children:p===h&&A&&ut.has(h)?"A4":"80mm"})]},h))}),e.jsxs("div",{className:"flex-1 relative bg-slate-100 overflow-hidden",children:[e.jsxs("div",{className:"absolute top-3 left-3 z-10 flex items-center gap-2",children:[e.jsx("span",{className:"text-[10px] font-semibold px-2 py-1 rounded-md shadow-sm bg-slate-800 text-white",children:T?"PDF A4":"THERMIQUE 80mm"}),O&&e.jsx("button",{onClick:()=>{I(!A),E(!0)},className:`text-[10px] font-semibold px-2 py-1 rounded-md shadow-sm transition-colors ${A?"bg-brand-600 text-white":"bg-white text-slate-600 border border-slate-200"}`,children:A?"Passer en 80mm":"Passer en A4"})]}),K&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-slate-100 z-10",children:e.jsxs("div",{className:"flex flex-col items-center gap-3",children:[e.jsx("div",{className:"w-8 h-8 border-2 border-brand-600 border-t-transparent rounded-full animate-spin"}),e.jsx("p",{className:"text-sm text-slate-400",children:"Chargement de l'aperÃ§u..."})]})}),e.jsx("div",{className:"h-full overflow-auto flex justify-center pt-4 pb-8",children:e.jsx("div",{className:`bg-white shadow-xl rounded-lg overflow-hidden shrink-0 ${T?"w-[480px]":"w-[320px]"}`,children:e.jsx("iframe",{ref:U,src:T?x.getPdfUrl(i,p):$,className:"w-full h-full border-0",style:{minHeight:"600px"},title:`AperÃ§u ${N==null?void 0:N.label}`,onLoad:()=>E(!1)})})})]}),e.jsxs("div",{className:"px-5 py-4 border-t border-slate-100 bg-white shrink-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{onClick:W,disabled:P,className:`flex-1 justify-center ${T?"btn-ghost border border-slate-200":"btn-primary shadow-lg shadow-brand-600/20"}`,children:[e.jsx(wt,{className:"w-4 h-4"}),P?"Ouverture...":"Imprimer 80mm"]}),O&&e.jsxs("button",{onClick:b,className:`${T?"btn-primary shadow-lg shadow-brand-600/20":"btn-ghost border border-slate-200"} flex-1 justify-center`,children:[e.jsx(os,{className:"w-4 h-4"}),"PDF A4"]}),e.jsxs("div",{className:"relative",children:[e.jsxs("button",{onClick:()=>C(!H),className:"btn-ghost border border-slate-200 px-3 gap-1",children:[e.jsx(Ne,{className:"w-4 h-4"}),e.jsx(yt,{className:"w-3 h-3"})]}),H&&e.jsxs("div",{className:"absolute bottom-full right-0 mb-2 w-48 bg-white rounded-lg shadow-xl border border-slate-200 py-1 z-50",children:[e.jsxs("button",{onClick:L,disabled:!y,className:"w-full flex items-center gap-2 px-3 py-2 text-sm text-slate-700 hover:bg-slate-50 disabled:opacity-40",children:[e.jsx(ve,{className:"w-4 h-4 text-green-600"}),"WhatsApp"]}),e.jsxs("button",{onClick:f,disabled:!y,className:"w-full flex items-center gap-2 px-3 py-2 text-sm text-slate-700 hover:bg-slate-50 disabled:opacity-40",children:[e.jsx(Ne,{className:"w-4 h-4 text-blue-600"}),"SMS"]}),e.jsxs("button",{onClick:w,disabled:!R||J,className:"w-full flex items-center gap-2 px-3 py-2 text-sm text-slate-700 hover:bg-slate-50 disabled:opacity-40",children:[e.jsx(we,{className:"w-4 h-4 text-red-500"}),J?"Envoi...":T?"Email (PDF)":"Email"]})]})]}),e.jsx("button",{onClick:m,className:"btn-ghost border border-slate-200 px-3",title:"Ouvrir dans un nouvel onglet",children:e.jsx(ds,{className:"w-4 h-4"})})]}),e.jsx("p",{className:"text-[10px] text-slate-400 text-center mt-2",children:T?"Document PDF format A4 professionnel":"Format optimisÃ© pour imprimante thermique 80mm"})]})]}),F&&e.jsx("div",{className:"fixed inset-x-0 bottom-24 z-[60] flex justify-center pointer-events-none",children:e.jsxs("div",{className:`pointer-events-auto flex items-center gap-3 px-5 py-3 rounded-xl shadow-2xl border transition-all ${F.type==="success"?"bg-emerald-600 border-emerald-700 text-white":"bg-red-600 border-red-700 text-white"}`,style:{animation:"toastIn 300ms ease-out"},children:[F.type==="success"?e.jsx(ms,{className:"w-5 h-5 shrink-0"}):e.jsx(xs,{className:"w-5 h-5 shrink-0"}),e.jsx("span",{className:"text-sm font-semibold",children:F.message}),e.jsx("button",{onClick:()=>z(null),className:"ml-2 p-0.5 rounded hover:bg-white/20",children:e.jsx(Y,{className:"w-4 h-4"})})]})}),e.jsx("style",{children:`
        @keyframes slideInRight {
          from { transform: translateX(100%); }
          to { transform: translateX(0); }
        }
        @keyframes toastIn {
          from { transform: translateY(20px); opacity: 0; }
          to { transform: translateY(0); opacity: 1; }
        }
      `})]}):null}const vs=[{id:1,label:"Appareil recu",message:"Bonjour {prenom}, votre {appareil} a bien ete pris en charge sous le numero {code}. Nous vous tiendrons informe de l'avancement. Klikphone 04 79 60 89 22"},{id:2,label:"Diagnostic en cours",message:"Bonjour {prenom}, le diagnostic de votre {appareil} est en cours. Nous reviendrons vers vous rapidement. Klikphone"},{id:3,label:"Devis a valider",message:"Bonjour {prenom}, le devis pour votre {appareil} est de {montant} EUR. Merci de nous confirmer votre accord. Klikphone 04 79 60 89 22"},{id:4,label:"En cours de reparation",message:"Bonjour {prenom}, la reparation de votre {appareil} est en cours. Klikphone"},{id:5,label:"Attente piece",message:"Bonjour {prenom}, nous sommes en attente d'une piece pour votre {appareil}. Nous vous previendrons des reception. Klikphone"},{id:6,label:"Appareil pret",message:"Bonjour {prenom}, votre {appareil} est pret ! Vous pouvez venir le recuperer a la boutique. Montant : {montant} EUR. Klikphone 79 Place Saint Leger, Chambery"},{id:7,label:"Commande arrivee",message:"Bonjour {prenom}, la piece commandee pour votre {appareil} est arrivee. Nous lancons la reparation. Klikphone 04 79 60 89 22"},{id:8,label:"Non reparable",message:"Bonjour {prenom}, malheureusement votre {appareil} n'est pas reparable. Vous pouvez passer recuperer votre appareil en boutique. Klikphone"},{id:9,label:"Rappel RDV",message:"Bonjour {prenom}, nous vous rappelons votre rendez-vous demain pour votre {appareil}. Klikphone 79 Place Saint Leger, Chambery"},{id:10,label:"Personnalise",message:""}],ws={1:"ðŸ“±",2:"ðŸ”",3:"ðŸ“‹",4:"ðŸ”§",5:"â³",6:"âœ…",7:"ðŸ“¦",8:"âŒ",9:"ðŸ“…",10:"âœï¸"};function ys({ticket:u,onMessageSent:D}){const i=ft(),{user:c}=jt(),[y,R]=r.useState(vs),[p,B]=r.useState(null),[U,K]=r.useState(""),[E,P]=r.useState(null);r.useEffect(()=>{x.getMessageTemplates().then(m=>{m&&m.length>0&&R(m)}).catch(()=>{})},[]);const j=u,H=j.modele_autre||`${j.marque||""} ${j.modele||""}`.trim()||"appareil",C=parseFloat(j.tarif_final)||parseFloat(j.devis_estime)||0,J=parseFloat(j.reduction_pourcentage)||0,X=parseFloat(j.reduction_montant)||0,F=J>0?C*(J/100):X,z=Math.max(0,C-F),A=m=>m.replace(/\{prenom\}/g,j.client_prenom||"").replace(/\{nom\}/g,j.client_nom||"").replace(/\{appareil\}/g,H).replace(/\{code\}/g,j.ticket_code||"").replace(/\{montant\}/g,String(z)).replace(/\{adresse\}/g,"79 Place Saint Leger, 73000 Chambery").replace(/\{horaires\}/g,"Lundi-Samedi 10h-19h").replace(/\{tel_boutique\}/g,"04 79 60 89 22"),I=y.find(m=>m.id===p),$=p===10,N=$?U:I?A(I.message):"",O=(m,b)=>{let g=m.replace(/[\s\-\.]/g,"");g.startsWith("0")&&(g="33"+g.substring(1)),!g.startsWith("+")&&!g.startsWith("33")&&(g="33"+g),g=g.replace("+",""),window.open(`https://wa.me/${g}?text=${encodeURIComponent(b)}`,"_blank")},T=(m,b)=>{window.open(`sms:${m}?body=${encodeURIComponent(b)}`,"_blank")},W=async m=>{if(!N.trim()){i.error("Message vide");return}P(m);try{const b=j.client_tel,g=j.client_email;if(m==="whatsapp"){if(!b){i.error("Pas de telephone");return}O(b,N)}else if(m==="sms"){if(!b){i.error("Pas de telephone");return}T(b,N)}else if(m==="email"){if(!g){i.error("Ce client n'a pas d'adresse email");return}const h=await x.envoyerEmail(g,`Klikphone SAV - ${j.ticket_code}`,N);if(h.status!=="ok"){i.error(h.message||"Erreur d'envoi email");return}}const L=(c==null?void 0:c.utilisateur)||"Accueil",w=`[${I?I.label:"Message"}] ${N.substring(0,120)}${N.length>120?"...":""}`;await x.logMessage(j.id,L,w,m),i.success(m==="email"?"Email envoyÃ© avec succÃ¨s":`Message ${m} envoyÃ©`),D&&D()}catch(b){i.error(b.message||"Erreur envoi"),console.error(b)}finally{P(null)}};return e.jsxs("div",{className:"card p-5",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx("div",{className:"w-8 h-8 rounded-lg bg-green-50 flex items-center justify-center",children:e.jsx(ve,{className:"w-4 h-4 text-green-600"})}),e.jsx("h2",{className:"text-sm font-semibold text-slate-800",children:"Messages"})]}),e.jsx("div",{className:"grid grid-cols-2 gap-1.5 mb-3",children:y.map(m=>e.jsxs("button",{onClick:()=>B(m.id===p?null:m.id),className:`text-left px-2.5 py-2 rounded-lg text-xs font-medium transition-all border ${p===m.id?"bg-brand-50 border-brand-300 text-brand-700 shadow-sm":"bg-white border-slate-150 text-slate-600 hover:bg-slate-50 hover:border-slate-200"}`,children:[e.jsx("span",{className:"mr-1",children:ws[m.id]||"ðŸ’¬"}),m.label]},m.id))}),p&&e.jsxs("div",{className:"animate-in",children:[$?e.jsx("textarea",{value:U,onChange:m=>K(m.target.value),placeholder:"Tapez votre message...",rows:3,className:"w-full px-3 py-2 rounded-lg border border-slate-200 text-sm resize-none focus:outline-none focus:ring-2 focus:ring-brand-500/20 focus:border-brand-500 mb-3"}):e.jsx("div",{className:"p-3 bg-slate-50 rounded-lg text-sm text-slate-700 leading-relaxed mb-3 border border-slate-100",children:N}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:()=>W("whatsapp"),disabled:!!E,className:"flex-1 flex items-center justify-center gap-1.5 py-2.5 rounded-lg bg-green-500 hover:bg-green-600 text-white text-xs font-bold transition-colors disabled:opacity-50",children:[E==="whatsapp"?e.jsx(ce,{className:"w-3.5 h-3.5"}):e.jsx(ve,{className:"w-3.5 h-3.5"}),"WhatsApp"]}),e.jsxs("button",{onClick:()=>W("sms"),disabled:!!E,className:"flex-1 flex items-center justify-center gap-1.5 py-2.5 rounded-lg bg-white hover:bg-slate-50 text-slate-600 text-xs font-bold border border-slate-200 transition-colors disabled:opacity-50",children:[E==="sms"?e.jsx(ce,{className:"w-3.5 h-3.5"}):e.jsx(Ne,{className:"w-3.5 h-3.5"}),"SMS"]}),e.jsxs("button",{onClick:()=>W("email"),disabled:!!E,className:"flex-1 flex items-center justify-center gap-1.5 py-2.5 rounded-lg bg-white hover:bg-slate-50 text-slate-600 text-xs font-bold border border-slate-200 transition-colors disabled:opacity-50",children:[E==="email"?e.jsx(ce,{className:"w-3.5 h-3.5"}):e.jsx(we,{className:"w-3.5 h-3.5"}),"Email"]})]})]})]})}function ht({title:u,icon:D,iconBg:i,iconColor:c,editing:y,onEdit:R,onSave:p,onCancel:B,children:U,viewContent:K}){return e.jsxs("div",{className:"card p-5",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:`w-8 h-8 rounded-lg ${i} flex items-center justify-center`,children:e.jsx(D,{className:`w-4 h-4 ${c}`})}),e.jsx("h2",{className:"text-sm font-semibold text-slate-800",children:u})]}),y?e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsxs("button",{onClick:B,className:"btn-ghost text-xs px-2.5 py-1.5",children:[e.jsx(Y,{className:"w-3.5 h-3.5"})," Annuler"]}),e.jsxs("button",{onClick:p,className:"btn-primary text-xs px-2.5 py-1.5",children:[e.jsx(Le,{className:"w-3.5 h-3.5"})," Sauver"]})]}):e.jsx("button",{onClick:R,className:"btn-ghost p-1.5",title:"Modifier",children:e.jsx(je,{className:"w-3.5 h-3.5"})})]}),y?U:K]})}const _s=new Set(["client","device","dates","notes","messages","reparation","status","fidelite"]),Fe=[{id:"client",title:"Client",col:"left",order:0,size:"normal"},{id:"device",title:"Appareil",col:"left",order:1,size:"normal"},{id:"dates",title:"Dates",col:"left",order:2,size:"compact"},{id:"messages",title:"Messages",col:"left",order:3,size:"normal"},{id:"notes",title:"Notes internes",col:"left",order:4,size:"normal"},{id:"reparation",title:"RÃ©paration & Tarifs",col:"right",order:0,size:"large"},{id:"status",title:"Statut",col:"right",order:1,size:"compact"},{id:"fidelite",title:"FidÃ©litÃ©",col:"right",order:2,size:"compact"}];function Ms(){const{id:u}=ns(),D=rs(),{user:i}=jt(),c=ft(),y=(i==null?void 0:i.target)==="tech"?"/tech":"/accueil",R=(i==null?void 0:i.target)==="tech",[p,B]=r.useState(null),[U,K]=r.useState(!0),[E,P]=r.useState(!1),[j,H]=r.useState(""),[C,J]=r.useState(!0),[X,F]=r.useState(!1),[z,A]=r.useState(!1),[I,$]=r.useState(!1),[N,O]=r.useState(!1),[T,W]=r.useState(!1),[m,b]=r.useState({}),[g,L]=r.useState({}),[f,w]=r.useState({}),[h,k]=r.useState([]),[q,ze]=r.useState(!1),[_t,oe]=r.useState(!1),[ye,Z]=r.useState(!1),[G,Ie]=r.useState(""),[de,Ct]=r.useState([]),[kt,Oe]=r.useState(!1),[ne,St]=r.useState(0),[me,qe]=r.useState([]),[Cs,ks]=r.useState(""),[Ss,Es]=r.useState(!1),[Et,xe]=r.useState(!1),[Tt,ee]=r.useState(!1),[_e,re]=r.useState(Fe),[pe,Be]=r.useState(null),[Q,Ue]=r.useState(!1),[Ke,We]=r.useState([]),[Pt,Ce]=r.useState(!1),[ke,Ve]=r.useState(""),[Ye,Se]=r.useState(""),[He,Je]=r.useState(!1),[At,Ge]=r.useState(!1),Qe=t=>{try{if(t.reparation_supp&&t.reparation_supp.startsWith("["))return JSON.parse(t.reparation_supp)}catch{}const n=[];return t.panne&&n.push({label:t.panne,prix:t.devis_estime||0}),t.reparation_supp&&n.push({label:t.reparation_supp,prix:t.prix_supp||0}),n.length>0?n:[{label:"",prix:0}]},_=r.useCallback(async()=>{K(!0);try{const t=await x.getTicket(u);B(t),b({categorie:t.categorie||"",marque:t.marque||"",modele:t.modele||"",modele_autre:t.modele_autre||"",imei:t.imei||"",panne:t.panne||"",panne_detail:t.panne_detail||"",pin:t.pin||"",pattern:t.pattern||"",notes_client:t.notes_client||""}),L({nom:t.client_nom||"",prenom:t.client_prenom||"",telephone:t.client_tel||"",email:t.client_email||"",societe:t.client_societe||""}),w({devis_estime:t.devis_estime||"",tarif_final:t.tarif_final||"",acompte:t.acompte||"",technicien_assigne:t.technicien_assigne||"",type_ecran:t.type_ecran||"",date_recuperation:t.date_recuperation||"",reduction_montant:t.reduction_montant||"",reduction_pourcentage:t.reduction_pourcentage||"",commande_piece:t.commande_piece||0}),k(Qe(t)),Oe(!!(t.attention||(t.notes_internes||"").includes("[ATTENTION]")));try{const n=await x.getPartsByTicket(t.id);We(n||[])}catch{We([])}}catch(t){console.error(t)}finally{K(!1)}},[u]);r.useEffect(()=>{_()},[_]);const Ee=r.useCallback(async()=>{try{const t=await x.getNotes(u);qe(t||[])}catch{qe([])}},[u]);r.useEffect(()=>{Ee()},[Ee]),r.useEffect(()=>{x.getActiveTeam().then(Ct).catch(()=>{}),x.getConfig().then(t=>{const o=(Array.isArray(t)?t:[]).find(s=>s.cle==="tva");o&&St(parseFloat(o.valeur)||0)}).catch(()=>{}),x.getCaisseConfig().then(t=>Ge(t.CAISSE_ENABLED==="1")).catch(()=>Ge(!1))},[]),r.useEffect(()=>{if(i!=null&&i.utilisateur)try{const t=localStorage.getItem(`kp_layout_${i.utilisateur}`);if(t){const n=JSON.parse(t).filter(l=>_s.has(l.id)),o=new Set(n.map(l=>l.id)),s=Fe.filter(l=>!o.has(l.id));n.length>0&&re([...n,...s])}}catch{}},[i==null?void 0:i.utilisateur]);const $t=()=>{i!=null&&i.utilisateur&&(localStorage.setItem(`kp_layout_${i.utilisateur}`,JSON.stringify(_e)),c.success("Layout sauvegardÃ©"),Ue(!1))},Mt=()=>{i!=null&&i.utilisateur&&(localStorage.removeItem(`kp_layout_${i.utilisateur}`),re(Fe),c.success("Layout rÃ©initialisÃ©"))},Dt=t=>{!pe||pe===t||(re(n=>{const o=n.map(M=>({...M})),s=o.find(M=>M.id===pe),l=o.find(M=>M.id===t);if(!s||!l)return n;const d=s.col,v=s.order;return s.col=l.col,s.order=l.order,l.col=d,l.order=v,o}),Be(null))},Rt=t=>{re(n=>n.map(o=>o.id===t?{...o,size:o.size==="compact"?"normal":o.size==="normal"?"large":"compact"}:o))},Ft=(t,n)=>{re(o=>{const s=o.map(d=>({...d})),l=s.find(d=>d.id===t);return l?(l.col=n,l.order=s.filter(d=>d.col===n&&d.id!==t).length,s):o})},Lt=async()=>{P(!0);try{await x.updateTicket(u,m),A(!1),await _(),c.success("Appareil mis Ã  jour")}catch{c.error("Erreur sauvegarde appareil")}finally{P(!1)}},zt=async()=>{P(!0);try{await x.updateClient(p.client_id,g),$(!1),await _(),c.success("Client mis Ã  jour")}catch{c.error("Erreur sauvegarde client")}finally{P(!1)}},It=async()=>{P(!0);try{const t=h.reduce((v,M)=>v+(parseFloat(M.prix)||0),0),n=JSON.stringify(h.filter(v=>v.label));let o=parseFloat(f.reduction_montant)||0;const s=parseFloat(f.reduction_pourcentage)||0;s>0&&(o=t*(s/100));const l=parseFloat(f.tarif_final)||t-o||null,d={...f,devis_estime:parseFloat(f.devis_estime)||null,tarif_final:l,acompte:parseFloat(f.acompte)||null,reduction_montant:o||null,reduction_pourcentage:s||null,reparation_supp:n,prix_supp:t};await x.updateTicket(u,d),O(!1),await _(),c.success("Tarification mise Ã  jour")}catch{c.error("Erreur sauvegarde tarification")}finally{P(!1)}},Ot=async t=>{if(t==="Rendu au client"){if(p.telephone_pret&&!p.telephone_pret_rendu){xe(!0);return}ee(!0);return}try{await x.changeStatus(u,t),await _(),c.success(`Statut changÃ© : ${t}`)}catch{c.error("Erreur changement de statut")}},qt=async()=>{try{await x.updateTicket(u,{telephone_pret_rendu:1}),xe(!1),ee(!0)}catch{c.error("Erreur")}},Bt=async()=>{try{await x.updateTicket(u,{paye:1}),await x.changeStatus(u,"Rendu au client"),await x.changeStatus(u,"ClÃ´turÃ©"),ee(!1),await _(),c.success("Ticket clÃ´turÃ©")}catch{c.error("Erreur")}},Ut=async()=>{try{await x.changeStatus(u,"Rendu au client"),ee(!1),await _(),c.success("Attention : ticket non payÃ©")}catch{c.error("Erreur")}},Xe=async()=>{if(ke!=="caramail"){Se("Code incorrect");return}Je(!0);try{await x.deleteTicket(u),c.success("Ticket supprimÃ©"),D(y)}catch{c.error("Erreur lors de la suppression"),Je(!1)}},Ze=async()=>{if(j.trim())try{const t=C?"[INTERNE]":"[CLIENT]";await x.addNote(u,`${t} ${j}`),H(""),await _(),c.success("Note ajoutÃ©e")}catch{c.error("Erreur ajout de note")}},Kt=async()=>{const t=prompt("Message de la note importante :");if(!(!t||!t.trim()))try{await x.addPrivateNote(u,(i==null?void 0:i.utilisateur)||"Accueil",t.trim(),!0),await x.updateTicket(u,{attention:t.trim()}),await _(),c.success("Note importante ajoutÃ©e")}catch{c.error("Erreur ajout attention")}},Wt=async()=>{try{const t=await x.togglePaye(u);await _(),c.success(t.paye?"MarquÃ© payÃ©":"MarquÃ© non payÃ©")}catch{c.error("Erreur toggle payÃ©")}},te=(t,n)=>{w(o=>({...o,[t]:Math.max(0,(parseFloat(o[t])||0)+n).toString()}))},Vt=()=>{navigator.clipboard.writeText(p.ticket_code),F(!0),setTimeout(()=>F(!1),2e3)},Yt=async()=>{const t=p;if(!t)return;const n=h.filter(s=>s.label),o=`RÃ©paration ${t.marque||""} ${t.modele||t.modele_autre||""} - ${n.map(s=>s.label).join(" + ")}`.trim();try{const s=await x.envoyerCaisse({ticket_id:t.id,ticket_code:t.ticket_code,nom:t.client_nom||"",prenom:t.client_prenom||"",telephone:t.client_tel||"",email:t.client_email||"",description:o,montant:be});s.result==="OK"?(c.success(s.message||"Vente envoyÃ©e en caisse"),_()):c.error(s.message||"Erreur caisse")}catch(s){c.error(s.message||"Erreur envoi en caisse")}},Ht=()=>{if(!p)return"";const t=p,n=t.modele_autre||`${t.marque||""} ${t.modele||""}`.trim()||"appareil",o=h.filter(d=>d.label),s=o.reduce((d,v)=>d+(parseFloat(v.prix)||0),0),l=o.map(d=>`- ${d.label} : ${parseFloat(d.prix||0).toFixed(2)} EUR`).join(`
`);return`Bonjour ${t.client_prenom||""}, suite au diagnostic de votre ${n}, voici le dÃ©tail des rÃ©parations nÃ©cessaires :

${l}

Total : ${s.toFixed(2)} EUR

Merci de nous confirmer votre accord pour lancer la rÃ©paration.
Klikphone 04 79 60 89 22`},Jt=()=>{Ie(Ht()),oe(!0)},Te=async t=>{if(!G.trim()){c.error("Message vide");return}Z(!0);try{const n=p.client_tel,o=p.client_email;if(t==="whatsapp"){if(!n){c.error("Pas de tÃ©lÃ©phone"),Z(!1);return}window.open(bt(n,G),"_blank")}else if(t==="sms"){if(!n){c.error("Pas de tÃ©lÃ©phone"),Z(!1);return}window.open(gt(n,G),"_blank")}else if(t==="email"){if(!o){c.error("Ce client n'a pas d'adresse email"),Z(!1);return}const d=await x.envoyerEmail(o,`Klikphone SAV - Accord ${p.ticket_code}`,G);if(d.status!=="ok"){c.error(d.message||"Erreur d'envoi email"),Z(!1);return}}await x.changeStatus(u,"En attente d'accord client");const s=(i==null?void 0:i.utilisateur)||"Accueil",l=`[Demande accord] ${G.substring(0,120)}${G.length>120?"...":""}`;await x.logMessage(u,s,l,t),oe(!1),await _(),c.success("Demande d'accord envoyÃ©e")}catch{c.error("Erreur envoi de la demande")}finally{Z(!1)}},et=async t=>{try{if(t){await x.changeStatus(u,"En cours de rÃ©paration");const n=(i==null?void 0:i.utilisateur)||"Accueil";await x.addPrivateNote(u,n,"Accord client reÃ§u â€” rÃ©paration lancÃ©e"),c.success("Ticket en cours de rÃ©paration")}else{await x.changeStatus(u,"RÃ©paration terminÃ©e");const n=(i==null?void 0:i.utilisateur)||"Accueil";await x.addPrivateNote(u,n,"Client a refusÃ© la rÃ©paration"),c.success("Ticket marquÃ© non rÃ©parable")}await _()}catch{c.error("Erreur changement de statut")}},Gt=()=>{k(t=>[...t,{label:"",prix:0}])},Qt=t=>{k(n=>n.filter((o,s)=>s!==t))},tt=(t,n,o)=>{k(s=>s.map((l,d)=>d===t?{...l,[n]:o}:l))},st=(t,n)=>{k(o=>o.map((s,l)=>l===t?{...s,prix:Math.max(0,(parseFloat(s.prix)||0)+n)}:s))},ue=h.reduce((t,n)=>t+(parseFloat(n.prix)||0),0),Xt=parseFloat(f.reduction_montant)||0,he=parseFloat(f.reduction_pourcentage)||0,Pe=he>0?ue*(he/100):Xt,Ae=parseFloat(f.tarif_final)||ue-Pe,at=ne>0?Ae*(ne/100):0,be=Ae+at,se=be-(parseFloat(f.acompte)||0);if(U)return e.jsx("div",{className:"flex items-center justify-center py-20",children:e.jsxs("div",{className:"flex flex-col items-center gap-3",children:[e.jsx("div",{className:"w-8 h-8 border-2 border-brand-600 border-t-transparent rounded-full animate-spin"}),e.jsx("p",{className:"text-sm text-slate-400",children:"Chargement..."})]})});if(!p)return e.jsxs("div",{className:"flex flex-col items-center justify-center py-20",children:[e.jsx("div",{className:"w-14 h-14 rounded-2xl bg-slate-100 flex items-center justify-center mb-4",children:e.jsx(Me,{className:"w-7 h-7 text-slate-300"})}),e.jsx("p",{className:"text-slate-500 font-medium",children:"Ticket non trouvÃ©"}),e.jsxs("button",{onClick:()=>D(y),className:"btn-secondary mt-4",children:[e.jsx(De,{className:"w-4 h-4"})," Retour au dashboard"]})]});const a=p,Zt=a.modele_autre||`${a.marque||""} ${a.modele||""}`.trim(),V=[];a.notes_internes&&a.notes_internes.split(`
`).filter(Boolean).forEach(t=>{t.includes("[INTERNE]");const n=t.includes("[CLIENT]"),o=t.includes("[ATTENTION]"),s=t.replace(/\[(INTERNE|CLIENT|ATTENTION)\]\s*/g,""),l=s.match(/^\[(\d{2}\/\d{2}\/?\d{0,4}\s?\d{2}:\d{2})\]\s*/),d=l?l[1]:"",v=l?s.replace(l[0],""):s;V.push({type:o?"attention":n?"client":"internal",text:v,timestamp:d,raw:t})}),a.historique&&a.historique.split(`
`).filter(Boolean).forEach(t=>{const n=t.match(/^\[(\d{2}\/\d{2}\s?\d{2}:\d{2})\]\s*/),o=n?n[1]:"",s=n?t.replace(n[0],""):t;V.push({type:"history",text:s,timestamp:o,raw:t})}),V.reverse();const es=t=>{var n,o;switch(t){case"client":return e.jsx(ht,{title:"Client",icon:it,iconBg:"bg-blue-50",iconColor:"text-blue-600",editing:I,onEdit:()=>$(!0),onSave:zt,onCancel:()=>{$(!1),L({nom:a.client_nom||"",prenom:a.client_prenom||"",telephone:a.client_tel||"",email:a.client_email||"",societe:a.client_societe||""})},viewContent:e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("div",{className:"w-11 h-11 rounded-full bg-brand-100 flex items-center justify-center shrink-0",children:e.jsxs("span",{className:"text-brand-700 font-bold text-sm",children:[(((n=a.client_prenom)==null?void 0:n[0])||"").toUpperCase(),(((o=a.client_nom)==null?void 0:o[0])||"").toUpperCase()]})}),e.jsxs("div",{className:"min-w-0",children:[e.jsxs("p",{className:"text-base font-bold text-slate-900 truncate",children:[a.client_prenom||""," ",a.client_nom||""]}),a.client_societe&&e.jsx("p",{className:"text-xs text-slate-500",children:a.client_societe})]})]}),e.jsxs("div",{className:"space-y-2",children:[a.client_tel&&e.jsxs("a",{href:`tel:${a.client_tel}`,className:"flex items-center gap-2.5 text-sm text-slate-600 hover:text-brand-600 transition-colors",children:[e.jsx("div",{className:"w-8 h-8 rounded-lg bg-slate-100 flex items-center justify-center shrink-0",children:e.jsx(js,{className:"w-4 h-4 text-slate-500"})}),e.jsx("span",{className:"font-mono text-xs",children:a.client_tel})]}),a.client_email&&e.jsxs("a",{href:`mailto:${a.client_email}`,className:"flex items-center gap-2.5 text-sm text-slate-600 hover:text-brand-600 transition-colors",children:[e.jsx("div",{className:"w-8 h-8 rounded-lg bg-slate-100 flex items-center justify-center shrink-0",children:e.jsx(we,{className:"w-4 h-4 text-slate-500"})}),e.jsx("span",{className:"text-xs truncate",children:a.client_email})]})]}),e.jsx("div",{className:"mt-4 pt-4 border-t border-slate-100",children:e.jsx("p",{className:"text-[10px] text-slate-400 text-center",children:"Messages dans le bloc Messages ci-dessous"})})]}),children:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"input-label",children:"PrÃ©nom"}),e.jsx("input",{value:g.prenom,onChange:s=>L(l=>({...l,prenom:s.target.value})),className:"input"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"input-label",children:"Nom"}),e.jsx("input",{value:g.nom,onChange:s=>L(l=>({...l,nom:s.target.value})),className:"input"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"input-label",children:"TÃ©lÃ©phone"}),e.jsx("input",{value:g.telephone,onChange:s=>L(l=>({...l,telephone:s.target.value})),className:"input font-mono"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"input-label",children:"Email"}),e.jsx("input",{value:g.email,onChange:s=>L(l=>({...l,email:s.target.value})),className:"input"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"input-label",children:"SociÃ©tÃ©"}),e.jsx("input",{value:g.societe,onChange:s=>L(l=>({...l,societe:s.target.value})),className:"input"})]})]})});case"device":return e.jsx(ht,{title:"Appareil",icon:Me,iconBg:"bg-brand-50",iconColor:"text-brand-600",editing:z,onEdit:()=>A(!0),onSave:Lt,onCancel:()=>{A(!1),b({categorie:a.categorie||"",marque:a.marque||"",modele:a.modele||"",modele_autre:a.modele_autre||"",imei:a.imei||"",panne:a.panne||"",panne_detail:a.panne_detail||"",pin:a.pin||"",pattern:a.pattern||"",notes_client:a.notes_client||""})},viewContent:e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 gap-x-6 gap-y-4 text-sm",children:[{label:"CatÃ©gorie",value:a.categorie},{label:"Marque",value:a.marque},{label:"ModÃ¨le",value:(a.modele&&a.modele!=="Autre"?a.modele:a.modele_autre)||a.modele||"â€”"},{label:"Panne",value:a.panne},{label:"IMEI / NÂ° sÃ©rie",value:a.imei,mono:!0},{label:"DÃ©tail panne",value:a.panne_detail}].map(({label:s,value:l,mono:d})=>e.jsxs("div",{children:[e.jsx("p",{className:"text-slate-400 text-xs mb-0.5",children:s}),e.jsx("p",{className:`font-medium text-slate-800 ${d?"font-mono text-xs":""}`,children:l||"â€”"})]},s))}),(a.pin||a.pattern)&&e.jsxs("div",{className:"mt-4 pt-4 border-t border-slate-100 flex flex-wrap gap-6",children:[a.pin&&e.jsxs("div",{children:[e.jsxs("p",{className:"text-slate-400 text-xs mb-1 flex items-center gap-1",children:[e.jsx(xt,{className:"w-3 h-3"})," Code PIN"]}),e.jsx("p",{className:"text-lg font-bold font-mono text-slate-800 tracking-widest",children:a.pin})]}),a.pattern&&e.jsxs("div",{children:[e.jsxs("p",{className:"text-slate-400 text-xs mb-1 flex items-center gap-1",children:[e.jsx(fs,{className:"w-3 h-3"})," Pattern"]}),e.jsx(is,{value:a.pattern,readOnly:!0,size:120})]})]}),a.notes_client&&e.jsxs("div",{className:"mt-4 p-3 bg-amber-50 border border-amber-100 rounded-lg text-sm text-amber-800",children:[e.jsx("span",{className:"font-semibold",children:"Note client :"})," ",a.notes_client]})]}),children:e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-3 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"input-label",children:"CatÃ©gorie"}),e.jsx("input",{value:m.categorie,onChange:s=>b(l=>({...l,categorie:s.target.value})),className:"input"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"input-label",children:"Marque"}),e.jsx("input",{value:m.marque,onChange:s=>b(l=>({...l,marque:s.target.value})),className:"input"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"input-label",children:"ModÃ¨le"}),e.jsx("input",{value:m.modele,onChange:s=>b(l=>({...l,modele:s.target.value})),className:"input"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"input-label",children:"Panne"}),e.jsx("input",{value:m.panne,onChange:s=>b(l=>({...l,panne:s.target.value})),className:"input"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"input-label",children:"IMEI"}),e.jsx("input",{value:m.imei,onChange:s=>b(l=>({...l,imei:s.target.value})),className:"input font-mono"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"input-label",children:"DÃ©tail panne"}),e.jsx("input",{value:m.panne_detail,onChange:s=>b(l=>({...l,panne_detail:s.target.value})),className:"input"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"input-label",children:"Code PIN"}),e.jsx("input",{value:m.pin,onChange:s=>b(l=>({...l,pin:s.target.value})),className:"input font-mono tracking-widest",maxLength:10})]}),e.jsxs("div",{children:[e.jsx("label",{className:"input-label",children:"Pattern"}),e.jsx("input",{value:m.pattern,onChange:s=>b(l=>({...l,pattern:s.target.value})),className:"input font-mono",placeholder:"1-5-9-6-3"})]}),e.jsxs("div",{className:"col-span-2 sm:col-span-3",children:[e.jsx("label",{className:"input-label",children:"Note client"}),e.jsx("textarea",{value:m.notes_client,onChange:s=>b(l=>({...l,notes_client:s.target.value})),className:"input resize-none",rows:2})]})]})});case"dates":return e.jsxs("div",{className:"card p-5",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx("div",{className:"w-8 h-8 rounded-lg bg-slate-100 flex items-center justify-center",children:e.jsx(gs,{className:"w-4 h-4 text-slate-500"})}),e.jsx("h2",{className:"text-sm font-semibold text-slate-800",children:"Dates"})]}),e.jsxs("div",{className:"space-y-3 text-sm",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-slate-500",children:"DÃ©pÃ´t"}),e.jsx("span",{className:"font-medium text-slate-800",children:$e(a.date_depot)})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-slate-500",children:"Mise Ã  jour"}),e.jsx("span",{className:"font-medium text-slate-800",children:$e(a.date_maj)})]}),a.date_cloture&&e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-slate-500",children:"ClÃ´ture"}),e.jsx("span",{className:"font-medium text-slate-800",children:$e(a.date_cloture)})]}),a.date_recuperation&&(()=>{const s=new Date(a.date_recuperation),l=!isNaN(s.getTime()),d=new Date;let v="";if(l&&s>d){const M=s-d,ie=Math.floor(M/864e5),nt=Math.floor(M%864e5/36e5);v=ie>0?`dans ${ie}j ${nt}h`:`dans ${nt}h`}else l&&s<=d&&(v="dÃ©passÃ©e");return e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-slate-500",children:"RÃ©cupÃ©ration"}),e.jsxs("div",{className:"text-right",children:[e.jsx("span",{className:"font-medium text-slate-800",children:l?s.toLocaleString("fr-FR",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"}):a.date_recuperation}),v&&e.jsx("span",{className:`ml-2 text-xs font-semibold ${s<=d?"text-red-500":"text-emerald-600"}`,children:v})]})]})})()]})]});case"messages":return e.jsx(ys,{ticket:a,onMessageSent:()=>Ee()});case"notes":return e.jsxs("div",{className:"card p-5",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-8 h-8 rounded-lg bg-amber-50 flex items-center justify-center",children:e.jsx(vt,{className:"w-4 h-4 text-amber-600"})}),e.jsx("h2",{className:"text-sm font-semibold text-slate-800",children:"Notes internes"}),e.jsx("span",{className:"text-[10px] text-slate-400",children:`${[...me,...V.filter(l=>l.type==="internal"||l.type==="client"||l.type==="attention")].length} note(s)`})]}),e.jsxs("button",{onClick:Kt,className:"btn-ghost text-xs gap-1 text-red-500 hover:bg-red-50",title:"Ajouter flag attention",children:[e.jsx(hs,{className:"w-3.5 h-3.5"})," Attention"]})]}),e.jsxs("div",{className:"flex gap-2 mb-4",children:[e.jsxs("div",{className:"flex-1 flex gap-2",children:[e.jsx("button",{onClick:()=>J(!C),className:`shrink-0 p-2.5 rounded-lg border transition-colors ${C?"bg-slate-50 border-slate-200 text-slate-500":"bg-blue-50 border-blue-200 text-blue-500"}`,title:C?"Note interne":"Note visible client",children:C?e.jsx(xt,{className:"w-4 h-4"}):e.jsx(bs,{className:"w-4 h-4"})}),e.jsx("input",{type:"text",value:j,onChange:s=>H(s.target.value),onKeyDown:s=>s.key==="Enter"&&Ze(),placeholder:C?"Note interne...":"Note visible par le client...",className:"input flex-1"})]}),e.jsx("button",{onClick:Ze,className:"btn-primary px-3",children:e.jsx(le,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"max-h-80 overflow-y-auto divide-y divide-slate-100",children:[me.map(s=>{var ie;const l=s.type_note||"note",d=l==="whatsapp"?{bg:"bg-green-100 text-green-700",label:"WhatsApp"}:l==="sms"?{bg:"bg-blue-100 text-blue-700",label:"SMS"}:l==="email"?{bg:"bg-amber-100 text-amber-700",label:"Email"}:null,v=(ie=s.auteur)==null?void 0:ie.toLowerCase().includes("tech"),M=s.important?"text-red-600 font-semibold":d?"text-slate-600":v?"text-blue-600":"text-emerald-600";return e.jsxs("div",{className:"flex items-start gap-2 py-1.5",children:[d&&e.jsx("span",{className:`text-[9px] font-bold px-1.5 py-0.5 rounded uppercase tracking-wider shrink-0 mt-0.5 ${d.bg}`,children:d.label}),!d&&l==="note"&&e.jsx("span",{className:"text-[9px] font-bold px-1.5 py-0.5 rounded bg-blue-50 text-blue-600 uppercase tracking-wider shrink-0 mt-0.5",children:s.auteur||"Note"}),e.jsx("span",{className:`text-sm flex-1 min-w-0 ${M}`,children:s.contenu}),e.jsx("span",{className:"text-[10px] text-slate-400 whitespace-nowrap shrink-0 mt-0.5",children:s.date_creation?new Date(s.date_creation).toLocaleString("fr-FR",{day:"2-digit",month:"2-digit",hour:"2-digit",minute:"2-digit"}):""})]},`db-${s.id}`)}),V.filter(s=>s.type!=="history").map((s,l)=>{const d=s.type==="attention"?"text-red-600 font-semibold":s.type==="internal"?"text-blue-600":"text-emerald-600";return e.jsxs("div",{className:"flex items-start gap-2 py-1.5",children:[e.jsx("span",{className:`text-sm flex-1 min-w-0 ${d}`,children:s.text}),s.timestamp&&e.jsx("span",{className:"text-[10px] text-slate-400 whitespace-nowrap shrink-0 mt-0.5",children:s.timestamp})]},`tl-${l}`)}),me.length===0&&V.filter(s=>s.type!=="history").length===0&&e.jsx("p",{className:"text-xs text-slate-400 text-center py-3",children:"Aucune note"})]}),V.filter(s=>s.type==="history").length>0&&e.jsxs("div",{className:"mt-4 pt-3 border-t border-slate-100",children:[e.jsx("p",{className:"text-[10px] text-slate-400 uppercase tracking-wider mb-2",children:"Historique"}),e.jsxs("div",{className:"relative max-h-48 overflow-y-auto pl-4",children:[e.jsx("div",{className:"absolute left-[9px] top-2 bottom-2 w-0.5 bg-slate-200"}),e.jsx("div",{className:"space-y-0.5",children:V.filter(s=>s.type==="history").map((s,l)=>e.jsxs("div",{className:"relative flex items-start gap-3 py-1.5 px-2 rounded-lg hover:bg-slate-50 transition-colors",children:[e.jsx("div",{className:"absolute -left-4 top-3 w-2 h-2 rounded-full bg-brand-400 z-10"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-xs text-slate-500",children:s.text}),s.timestamp&&e.jsx("span",{className:"text-[10px] text-slate-400",children:s.timestamp})]})]},l))})]})]})]});case"reparation":return e.jsxs("div",{className:"card p-5",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-8 h-8 rounded-lg bg-emerald-50 flex items-center justify-center",children:e.jsx(ct,{className:"w-4 h-4 text-emerald-600"})}),e.jsx("h2",{className:"text-sm font-semibold text-slate-800",children:"RÃ©paration & Tarifs"})]}),!N&&e.jsx("button",{onClick:()=>O(!0),className:"btn-ghost p-1.5",title:"Modifier",children:e.jsx(je,{className:"w-3.5 h-3.5"})}),N&&e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsxs("button",{onClick:()=>{O(!1),w({devis_estime:a.devis_estime||"",tarif_final:a.tarif_final||"",acompte:a.acompte||"",technicien_assigne:a.technicien_assigne||"",type_ecran:a.type_ecran||"",date_recuperation:a.date_recuperation||"",reduction_montant:a.reduction_montant||"",reduction_pourcentage:a.reduction_pourcentage||"",commande_piece:a.commande_piece||0}),k(Qe(a))},className:"btn-ghost text-xs px-2.5 py-1.5",children:[e.jsx(Y,{className:"w-3.5 h-3.5"})," Annuler"]}),e.jsxs("button",{onClick:It,className:"btn-primary text-xs px-2.5 py-1.5",children:[e.jsx(Le,{className:"w-3.5 h-3.5"})," Sauver"]})]})]}),e.jsxs("div",{className:"mb-4 p-3 bg-slate-50 rounded-xl border border-slate-100",children:[e.jsx("div",{className:"text-[11px] text-slate-400 uppercase tracking-wider mb-2",children:"Technicien assignÃ©"}),R&&!T?e.jsxs("div",{className:"flex items-center gap-2",children:[(()=>{var l,d;const s=de.find(v=>a.technicien_assigne===v.nom||(a.technicien_assigne||"").startsWith(v.nom+" "));return s?e.jsx("div",{className:"w-7 h-7 rounded-lg flex items-center justify-center text-white text-xs font-bold",style:{backgroundColor:s.couleur||"#94a3b8"},children:((l=a.technicien_assigne)==null?void 0:l.charAt(0))||"?"}):e.jsx("div",{className:"w-7 h-7 rounded-lg bg-slate-300 flex items-center justify-center text-white text-xs font-bold",children:((d=a.technicien_assigne)==null?void 0:d.charAt(0))||"?"})})(),e.jsx("span",{className:"text-sm font-semibold text-slate-800",children:a.technicien_assigne||"Non assignÃ©"}),e.jsx("button",{onClick:()=>W(!0),className:"text-slate-400 hover:text-brand-600 ml-auto",children:e.jsx(je,{className:"w-3.5 h-3.5"})})]}):e.jsxs("div",{className:"flex items-center gap-2",children:[(()=>{const s=de.find(l=>(a.technicien_assigne||"")===l.nom);return e.jsx("div",{className:"w-7 h-7 rounded-lg flex items-center justify-center text-white text-xs font-bold",style:{backgroundColor:(s==null?void 0:s.couleur)||"#94a3b8"},children:(a.technicien_assigne||T||"?").charAt(0)})})(),de.length>0?e.jsxs("select",{value:a.technicien_assigne||"",onChange:async s=>{const l=s.target.value;if(l)try{await x.updateTicket(u,{technicien_assigne:l}),await _(),c.success(`AssignÃ© Ã  ${l}`),W(!1)}catch{c.error("Erreur assignation")}},className:"flex-1 px-3 py-1.5 rounded-lg border border-slate-200 text-sm font-semibold bg-white",children:[e.jsx("option",{value:"",children:"â€” Non assignÃ© â€”"}),de.map(s=>e.jsxs("option",{value:s.nom,children:[s.nom,s.role?` (${s.role})`:""]},s.id))]}):e.jsx("input",{type:"text",value:f.technicien_assigne,onChange:s=>w(l=>({...l,technicien_assigne:s.target.value})),className:"flex-1 input text-sm",placeholder:"Nom du technicien"})]}),a.personne_charge&&e.jsxs("p",{className:"text-[10px] text-slate-400 mt-2",children:["Prise en charge : ",e.jsx("span",{className:"font-medium text-slate-600",children:a.personne_charge})]})]}),N?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("label",{className:"input-label mb-0",children:"Lignes de rÃ©paration"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("label",{className:"flex items-center gap-1.5 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:!!f.commande_piece,onChange:s=>w(l=>({...l,commande_piece:s.target.checked?1:0})),className:"w-3.5 h-3.5 rounded border-slate-300 text-amber-600 focus:ring-amber-500"}),e.jsxs("span",{className:"text-xs font-medium text-amber-700",children:[e.jsx(dt,{className:"w-3 h-3 inline mr-0.5"}),"PiÃ¨ce Ã  commander"]})]}),e.jsxs("button",{onClick:Gt,className:"btn-ghost text-xs px-2 py-1",children:[e.jsx(le,{className:"w-3 h-3"})," Ajouter"]})]})]}),e.jsx("div",{className:"space-y-2",children:h.map((s,l)=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{value:s.label,onChange:d=>tt(l,"label",d.target.value),className:"input flex-1",placeholder:"Description rÃ©paration"}),e.jsxs("div",{className:"relative w-28 shrink-0",children:[e.jsx("input",{type:"number",step:"0.01",value:s.prix,onChange:d=>tt(l,"prix",d.target.value),className:"input text-right pr-7",placeholder:"0"}),e.jsx("span",{className:"absolute right-2.5 top-1/2 -translate-y-1/2 text-xs text-slate-400",children:"â‚¬"})]}),e.jsx("button",{onClick:()=>st(l,-5),className:"btn-ghost p-1.5 shrink-0",children:e.jsx(fe,{className:"w-3 h-3"})}),e.jsx("button",{onClick:()=>st(l,5),className:"btn-ghost p-1.5 shrink-0",children:e.jsx(le,{className:"w-3 h-3"})}),h.length>1&&e.jsx("button",{onClick:()=>Qt(l),className:"btn-ghost p-1.5 shrink-0 text-red-400 hover:text-red-600",children:e.jsx(ot,{className:"w-3 h-3"})})]},l))}),e.jsxs("div",{className:"text-right mt-2",children:[e.jsx("span",{className:"text-xs text-slate-400",children:"Total :"}),e.jsx("span",{className:"text-sm font-bold text-slate-800 ml-2",children:S(ue)})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"input-label",children:"Devis estimÃ©"}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:()=>te("devis_estime",-5),className:"btn-ghost p-1.5 shrink-0",children:e.jsx(fe,{className:"w-3 h-3"})}),e.jsxs("div",{className:"relative flex-1",children:[e.jsx("input",{type:"number",step:"0.01",value:f.devis_estime,onChange:s=>w(l=>({...l,devis_estime:s.target.value})),className:"input text-center pr-7"}),e.jsx("span",{className:"absolute right-2.5 top-1/2 -translate-y-1/2 text-xs text-slate-400",children:"â‚¬"})]}),e.jsx("button",{onClick:()=>te("devis_estime",5),className:"btn-ghost p-1.5 shrink-0",children:e.jsx(le,{className:"w-3 h-3"})})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"input-label",children:"Tarif final"}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:()=>te("tarif_final",-5),className:"btn-ghost p-1.5 shrink-0",children:e.jsx(fe,{className:"w-3 h-3"})}),e.jsxs("div",{className:"relative flex-1",children:[e.jsx("input",{type:"number",step:"0.01",value:f.tarif_final,onChange:s=>w(l=>({...l,tarif_final:s.target.value})),className:"input text-center pr-7",placeholder:ue||""}),e.jsx("span",{className:"absolute right-2.5 top-1/2 -translate-y-1/2 text-xs text-slate-400",children:"â‚¬"})]}),e.jsx("button",{onClick:()=>te("tarif_final",5),className:"btn-ghost p-1.5 shrink-0",children:e.jsx(le,{className:"w-3 h-3"})})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"input-label",children:"Acompte"}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:()=>te("acompte",-5),className:"btn-ghost p-1.5 shrink-0",children:e.jsx(fe,{className:"w-3 h-3"})}),e.jsxs("div",{className:"relative flex-1",children:[e.jsx("input",{type:"number",step:"0.01",value:f.acompte,onChange:s=>w(l=>({...l,acompte:s.target.value})),className:"input text-center pr-7"}),e.jsx("span",{className:"absolute right-2.5 top-1/2 -translate-y-1/2 text-xs text-slate-400",children:"â‚¬"})]}),e.jsx("button",{onClick:()=>te("acompte",5),className:"btn-ghost p-1.5 shrink-0",children:e.jsx(le,{className:"w-3 h-3"})})]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"input-label flex items-center gap-1",children:[e.jsx(mt,{className:"w-3 h-3"})," RÃ©duction (%)"]}),e.jsx("input",{type:"number",step:"1",min:"0",max:"100",value:f.reduction_pourcentage,onChange:s=>w(l=>({...l,reduction_pourcentage:s.target.value,reduction_montant:""})),className:"input",placeholder:"0"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"input-label",children:"RÃ©duction (â‚¬)"}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"number",step:"0.01",value:f.reduction_montant,onChange:s=>w(l=>({...l,reduction_montant:s.target.value,reduction_pourcentage:""})),className:"input pr-7",placeholder:"0"}),e.jsx("span",{className:"absolute right-2.5 top-1/2 -translate-y-1/2 text-xs text-slate-400",children:"â‚¬"})]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"input-label",children:"QualitÃ© Ã©cran"}),e.jsxs("select",{value:f.type_ecran,onChange:s=>w(l=>({...l,type_ecran:s.target.value})),className:"input",children:[e.jsx("option",{value:"",children:"â€”"}),e.jsx("option",{value:"Original",children:"Original (OEM)"}),e.jsx("option",{value:"Original reconditionnÃ©",children:"Original reconditionnÃ©"}),e.jsx("option",{value:"Compatible Premium",children:"Compatible Premium"}),e.jsx("option",{value:"Compatible",children:"Compatible"}),e.jsx("option",{value:"OLED",children:"OLED"}),e.jsx("option",{value:"OLED Premium",children:"OLED Premium"}),e.jsx("option",{value:"Incell",children:"Incell"}),e.jsx("option",{value:"LCD",children:"LCD"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"input-label",children:"Date rÃ©cupÃ©ration"}),e.jsx("input",{type:"datetime-local",value:f.date_recuperation,onChange:s=>w(l=>({...l,date_recuperation:s.target.value})),className:"input"})]})]})]}):e.jsxs(e.Fragment,{children:[Ke.length>0&&e.jsxs("div",{className:"mb-3 p-3 bg-amber-50 border border-amber-200 rounded-xl",children:[e.jsxs("div",{className:"text-[11px] font-bold text-amber-800 uppercase tracking-wider mb-2 flex items-center gap-1",children:[e.jsx(dt,{className:"w-3 h-3"})," PiÃ¨ce(s) commandÃ©e(s)"]}),Ke.map(s=>e.jsxs("div",{className:"flex items-center justify-between py-1.5 border-b border-amber-100 last:border-0",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold text-slate-700",children:s.description}),s.notes&&e.jsx("div",{className:"text-xs text-slate-500",children:s.notes}),s.fournisseur&&e.jsxs("div",{className:"text-xs text-slate-400",children:["Fournisseur : ",s.fournisseur]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[s.prix>0&&e.jsx("span",{className:"text-sm font-bold",children:S(s.prix)}),e.jsx("span",{className:`text-[10px] font-bold px-2 py-0.5 rounded-full ${s.statut==="En attente"?"bg-amber-100 text-amber-700":s.statut==="CommandÃ©e"?"bg-blue-100 text-blue-700":s.statut==="ExpÃ©diÃ©e"?"bg-purple-100 text-purple-700":s.statut==="ReÃ§ue"?"bg-green-100 text-green-700":"bg-red-100 text-red-700"}`,children:s.statut})]})]},s.id))]}),e.jsxs("div",{className:"mb-3",children:[h.filter(s=>s.label).map((s,l)=>e.jsxs("div",{className:"flex items-center justify-between py-2 border-b border-slate-50 last:border-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-sm font-medium text-slate-700",children:s.label}),a.type_ecran&&l===0&&e.jsx("span",{className:"text-[10px] font-semibold text-violet-600 bg-violet-50 px-2 py-0.5 rounded",children:a.type_ecran})]}),e.jsx("span",{className:"text-sm font-bold text-slate-800",children:S(s.prix)})]},l)),h.filter(s=>s.label).length===0&&e.jsx("p",{className:"text-sm text-slate-400 italic py-2",children:"Aucune rÃ©paration enregistrÃ©e"})]}),Pe>0&&e.jsxs("div",{className:"flex justify-between py-1 text-sm text-emerald-600",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(mt,{className:"w-3 h-3"})," RÃ©duction",he>0?` (${he}%)`:""]}),e.jsxs("span",{className:"font-medium",children:["- ",S(Pe)]})]}),e.jsxs("div",{className:"border-t border-slate-200 mt-2 pt-2 space-y-1",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-slate-500",children:ne>0?"Sous-total HT":"Tarif final"}),e.jsx("span",{className:"font-semibold text-slate-800",children:S(Ae)})]}),ne>0&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"text-slate-500",children:["TVA (",ne,"%)"]}),e.jsx("span",{className:"font-medium text-slate-600",children:S(at)})]}),e.jsxs("div",{className:"flex justify-between text-sm font-bold border-t border-slate-200 pt-2",children:[e.jsx("span",{className:"text-slate-800",children:"Total TTC"}),e.jsx("span",{className:"text-slate-900",children:S(be)})]})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-slate-500",children:"Acompte versÃ©"}),e.jsxs("span",{className:"font-medium text-slate-800",children:["- ",a.acompte?S(a.acompte):"0,00 â‚¬"]})]})]}),se>0&&e.jsxs("div",{className:"flex justify-between mt-3 px-4 py-3 rounded-xl bg-gradient-to-r from-emerald-50 to-green-50 border border-emerald-200",children:[e.jsx("span",{className:"font-extrabold text-emerald-700 text-[15px]",children:"RESTE Ã€ PAYER"}),e.jsx("span",{className:"font-extrabold text-emerald-700 text-[15px]",children:S(se)})]}),e.jsxs("div",{className:"flex gap-2 mt-3 flex-wrap",children:[e.jsxs("button",{onClick:Wt,className:`px-3 py-2 rounded-lg text-xs font-semibold transition-colors ${a.paye?"bg-emerald-500 text-white":"bg-emerald-50 text-emerald-700 border border-emerald-200 hover:bg-emerald-100"}`,children:[e.jsx(ge,{className:"w-3.5 h-3.5 inline mr-1"}),a.paye?"PayÃ© âœ“":"Marquer payÃ©"]}),At&&e.jsxs("button",{onClick:Yt,className:"px-3 py-2 rounded-lg bg-amber-500 text-white text-xs font-semibold hover:bg-amber-600",children:[e.jsx(us,{className:"w-3.5 h-3.5 inline mr-1"}),"Envoyer en caisse"]}),e.jsxs("button",{onClick:Jt,className:"px-3 py-2 rounded-lg bg-orange-50 text-orange-600 text-xs font-semibold border border-orange-200 hover:bg-orange-100",children:[e.jsx(Re,{className:"w-3.5 h-3.5 inline mr-1"}),"Accord client"]})]})]})]});case"status":return e.jsxs("div",{className:"card p-5",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx("div",{className:"w-8 h-8 rounded-lg flex items-center justify-center",style:{backgroundColor:ae(a.statut).color+"20"},children:e.jsx(yt,{className:"w-4 h-4",style:{color:ae(a.statut).color}})}),e.jsx("h2",{className:"text-sm font-semibold text-slate-800",children:"Changer le statut"})]}),e.jsx("select",{value:a.statut,onChange:s=>Ot(s.target.value),className:"w-full py-3 px-4 text-base font-semibold rounded-xl border-2 transition-colors cursor-pointer appearance-none bg-no-repeat",style:{borderColor:ae(a.statut).color,color:ae(a.statut).color,backgroundColor:ae(a.statut).color+"10",backgroundImage:`url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='${encodeURIComponent(ae(a.statut).color)}' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E")`,backgroundPosition:"right 12px center",backgroundSize:"20px"},children:ls.map(s=>e.jsx("option",{value:s,children:s},s))}),a.statut==="En attente d'accord client"&&e.jsxs("div",{className:"mt-3 p-3 bg-orange-50 border border-orange-200 rounded-xl space-y-2",children:[e.jsx("p",{className:"text-[11px] font-semibold text-orange-700 uppercase tracking-wider",children:"RÃ©ponse du client"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:()=>et(!0),className:"flex-1 py-2 px-3 rounded-lg bg-emerald-50 text-emerald-700 text-xs font-bold border border-emerald-200 hover:bg-emerald-100 transition-colors",children:[e.jsx(ce,{className:"w-3.5 h-3.5 inline mr-1"}),"Client a validÃ©"]}),e.jsxs("button",{onClick:()=>et(!1),className:"flex-1 py-2 px-3 rounded-lg bg-red-50 text-red-600 text-xs font-bold border border-red-200 hover:bg-red-100 transition-colors",children:[e.jsx(Y,{className:"w-3.5 h-3.5 inline mr-1"}),"Client a refusÃ©"]})]})]})]});case"fidelite":return a.client_id&&!R?e.jsx(as,{clientId:a.client_id}):null;default:return null}},lt=t=>{const n=es(t.id);if(!n)return null;if(!Q)return e.jsx("div",{children:n},t.id);const o=t.size==="compact"?"S":t.size==="large"?"L":"M";return e.jsxs("div",{draggable:!0,onDragStart:()=>Be(t.id),onDragOver:s=>s.preventDefault(),onDrop:s=>{s.preventDefault(),Dt(t.id)},className:`relative group rounded-xl transition-all ${pe===t.id?"opacity-40 scale-[0.98]":""} ${Q?"ring-2 ring-dashed ring-slate-200 hover:ring-brand-400":""}`,children:[e.jsxs("div",{className:"absolute -top-3 left-3 flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity z-10",children:[e.jsxs("span",{className:"px-2 py-0.5 bg-brand-600 text-white text-[10px] rounded-full font-medium cursor-grab active:cursor-grabbing shadow-sm",children:["â ¿ ",t.title]}),e.jsx("button",{onClick:()=>Rt(t.id),className:"px-1.5 py-0.5 bg-slate-700 text-white text-[10px] rounded-full hover:bg-slate-600 shadow-sm",children:o}),e.jsx("button",{onClick:()=>Ft(t.id,t.col==="left"?"right":"left"),className:"px-1.5 py-0.5 bg-slate-700 text-white text-[10px] rounded-full hover:bg-slate-600 shadow-sm",children:t.col==="left"?"â†’":"â†"})]}),e.jsx("div",{className:t.size==="compact"?"max-h-52 overflow-hidden":"",children:n})]},t.id)};return e.jsxs("div",{className:"max-w-7xl mx-auto",children:[e.jsx("div",{className:"bg-gradient-to-br from-slate-800 to-slate-900 text-white px-4 sm:px-6 lg:px-8 py-8 sm:py-10 -mx-4 sm:-mx-6 lg:-mx-8 -mt-4 sm:-mt-6 lg:-mt-8 mb-6",children:e.jsxs("div",{className:"max-w-7xl mx-auto",children:[e.jsxs("button",{onClick:()=>D(-1),className:"flex items-center gap-1.5 text-slate-400 hover:text-white transition-colors mb-5 -ml-1",children:[e.jsx(De,{className:"w-4 h-4"}),e.jsx("span",{className:"text-xs font-medium",children:"Retour"})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-start gap-5",children:[e.jsxs("div",{className:"flex-1 min-w-0 space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("h1",{className:"text-2xl sm:text-3xl font-display font-bold text-white font-mono tracking-tight",children:a.ticket_code}),e.jsx("button",{onClick:Vt,className:"p-1.5 rounded-lg hover:bg-white/10 transition-colors",title:"Copier le code",children:X?e.jsx(ce,{className:"w-4 h-4 text-emerald-400"}):e.jsx(Nt,{className:"w-4 h-4 text-slate-400"})}),a.paye&&e.jsxs("span",{className:"px-2.5 py-1 rounded-full bg-emerald-500/20 text-emerald-300 text-xs font-bold flex items-center gap-1",children:[e.jsx(ge,{className:"w-3.5 h-3.5"})," PayÃ©"]})]}),e.jsxs("div",{className:"text-sm text-slate-300 flex flex-wrap items-center gap-x-2 gap-y-1",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(it,{className:"w-3.5 h-3.5 text-slate-500"})," ",a.client_prenom||""," ",a.client_nom||""]}),e.jsx("span",{className:"text-slate-600",children:"â€¢"}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(Me,{className:"w-3.5 h-3.5 text-slate-500"})," ",Zt||"â€”"]}),e.jsx("span",{className:"text-slate-600",children:"â€¢"}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(ct,{className:"w-3.5 h-3.5 text-slate-500"}),h.filter(t=>t.label).length>0?h.filter(t=>t.label).map(t=>t.label).join(" + "):a.panne||"â€”"]}),e.jsx("span",{className:"text-slate-600",children:"â€¢"}),e.jsx("span",{className:"font-semibold text-emerald-400",children:S(be||0)}),a.paye&&e.jsx("span",{className:"text-xs bg-emerald-500/20 text-emerald-300 px-2 py-0.5 rounded-full",children:"PayÃ©"}),!a.paye&&se>0&&e.jsxs("span",{className:"text-xs bg-amber-500/20 text-amber-300 px-2 py-0.5 rounded-full",children:["Reste ",S(se)]})]}),a.client_tel&&e.jsx("a",{href:`tel:${a.client_tel}`,className:"text-sm text-slate-400 hover:text-white font-mono transition-colors",children:a.client_tel})]}),e.jsxs("div",{className:"flex sm:flex-col items-center sm:items-end gap-3 shrink-0",children:[e.jsx(ts,{statut:a.statut,size:"lg"}),e.jsxs("button",{onClick:()=>ze(!0),className:"flex items-center gap-2 px-4 py-2 rounded-lg bg-white/10 hover:bg-white/20 text-slate-300 hover:text-white text-sm font-medium transition-colors",children:[e.jsx(wt,{className:"w-4 h-4"})," Imprimer"]})]})]})]})}),_t&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 bg-black/60 backdrop-blur-sm z-50",onClick:()=>oe(!1)}),e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-lg p-6 animate-in max-h-[90vh] overflow-y-auto",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-5",children:[e.jsx("div",{className:"w-10 h-10 rounded-xl bg-orange-100 flex items-center justify-center",children:e.jsx(Re,{className:"w-5 h-5 text-orange-600"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-display font-bold text-slate-900",children:"Demande d'accord client"}),e.jsxs("p",{className:"text-sm text-slate-500",children:[a.ticket_code," â€” ",a.client_prenom," ",a.client_nom]})]}),e.jsx("button",{onClick:()=>oe(!1),className:"ml-auto btn-ghost p-1.5",children:e.jsx(Y,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"p-4 bg-slate-50 border border-slate-200 rounded-xl mb-4",children:[e.jsx("div",{className:"text-[11px] font-bold text-slate-500 uppercase tracking-wider mb-2",children:"RÃ©capitulatif des rÃ©parations"}),h.filter(t=>t.label).map((t,n)=>e.jsxs("div",{className:"flex justify-between py-1.5 border-b border-slate-100 last:border-0",children:[e.jsxs("span",{className:"text-sm text-slate-700",children:[t.label,a.type_ecran&&n===0&&e.jsx("span",{className:"text-[10px] font-semibold text-violet-600 bg-violet-50 px-1.5 py-0.5 rounded ml-2",children:a.type_ecran})]}),e.jsx("span",{className:"text-sm font-bold text-slate-800",children:S(t.prix)})]},n)),e.jsxs("div",{className:"flex justify-between pt-2 mt-1 border-t border-slate-300",children:[e.jsx("span",{className:"text-sm font-bold text-slate-900",children:"Total"}),e.jsx("span",{className:"text-sm font-bold text-emerald-700",children:S(h.filter(t=>t.label).reduce((t,n)=>t+(parseFloat(n.prix)||0),0))})]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"text-xs font-semibold text-slate-600 mb-1 block",children:"Message au client"}),e.jsx("textarea",{value:G,onChange:t=>Ie(t.target.value),rows:7,className:"w-full px-3 py-2.5 rounded-xl border border-slate-200 text-sm resize-none focus:outline-none focus:ring-2 focus:ring-orange-500/20 focus:border-orange-500"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:()=>Te("whatsapp"),disabled:ye,className:"flex-1 flex items-center justify-center gap-1.5 py-2.5 rounded-lg bg-green-500 hover:bg-green-600 text-white text-xs font-bold transition-colors disabled:opacity-50",children:[e.jsx(ve,{className:"w-3.5 h-3.5"})," WhatsApp"]}),e.jsxs("button",{onClick:()=>Te("sms"),disabled:ye,className:"flex-1 flex items-center justify-center gap-1.5 py-2.5 rounded-lg bg-white hover:bg-slate-50 text-slate-600 text-xs font-bold border border-slate-200 transition-colors disabled:opacity-50",children:[e.jsx(Ne,{className:"w-3.5 h-3.5"})," SMS"]}),e.jsxs("button",{onClick:()=>Te("email"),disabled:ye,className:"flex-1 flex items-center justify-center gap-1.5 py-2.5 rounded-lg bg-white hover:bg-slate-50 text-slate-600 text-xs font-bold border border-slate-200 transition-colors disabled:opacity-50",children:[e.jsx(we,{className:"w-3.5 h-3.5"})," Email"]})]})]})})]}),Et&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 bg-black/60 backdrop-blur-sm z-50",onClick:()=>xe(!1)}),e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 animate-in",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("div",{className:"w-10 h-10 rounded-xl bg-amber-100 flex items-center justify-center",children:e.jsx(ps,{className:"w-5 h-5 text-amber-600"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-display font-bold text-slate-900",children:"TÃ©lÃ©phone de prÃªt"}),e.jsx("p",{className:"text-sm text-slate-500",children:"Ce client a un tÃ©lÃ©phone de prÃªt !"})]})]}),e.jsxs("div",{className:"p-4 bg-amber-50 border border-amber-200 rounded-xl mb-4",children:[e.jsxs("p",{className:"text-sm font-semibold text-amber-800",children:["TÃ©lÃ©phone prÃªtÃ© : ",p.telephone_pret]}),p.telephone_pret_imei&&e.jsxs("p",{className:"text-xs text-amber-600 font-mono mt-1",children:["IMEI : ",p.telephone_pret_imei]}),e.jsx("p",{className:"text-xs text-amber-700 mt-2 font-medium",children:"Pensez Ã  rÃ©cupÃ©rer le tÃ©lÃ©phone de prÃªt avant de rendre l'appareil au client !"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>xe(!1),className:"btn-ghost flex-1",children:"Annuler"}),e.jsx("button",{onClick:qt,className:"btn-primary flex-1",children:"TÃ©lÃ©phone rÃ©cupÃ©rÃ©, rendre au client"})]})]})})]}),Tt&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 bg-black/60 backdrop-blur-sm z-50",onClick:()=>ee(!1)}),e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 animate-in",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-5",children:[e.jsx("div",{className:"w-10 h-10 rounded-xl bg-emerald-100 flex items-center justify-center",children:e.jsx(ge,{className:"w-5 h-5 text-emerald-600"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-display font-bold text-slate-900",children:"Rendu au client"}),e.jsx("p",{className:"text-sm text-slate-500",children:"Le client a-t-il rÃ©glÃ© ?"})]})]}),se>0&&e.jsxs("div",{className:"p-4 bg-gradient-to-br from-emerald-50 to-green-50 border border-emerald-200 rounded-xl mb-5 text-center",children:[e.jsx("p",{className:"text-xs text-emerald-600 font-medium mb-1",children:"Reste Ã  payer"}),e.jsx("p",{className:"text-2xl font-extrabold text-emerald-700",children:S(se)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("button",{onClick:Bt,className:"w-full py-3 px-4 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white text-sm font-bold transition-colors flex items-center justify-center gap-2",children:[e.jsx(ge,{className:"w-4 h-4"})," Oui, payÃ©"]}),e.jsxs("button",{onClick:Ut,className:"w-full py-3 px-4 rounded-xl bg-red-50 hover:bg-red-100 text-red-600 text-sm font-bold border border-red-200 transition-colors flex items-center justify-center gap-2",children:[e.jsx(Y,{className:"w-4 h-4"})," Non, pas payÃ©"]}),e.jsxs("button",{onClick:()=>ee(!1),className:"w-full py-2.5 px-4 rounded-xl text-slate-400 hover:text-slate-600 text-sm font-medium transition-colors flex items-center justify-center gap-1",children:[e.jsx(De,{className:"w-3.5 h-3.5"})," Annuler"]})]})]})})]}),Pt&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 bg-black/60 backdrop-blur-sm z-50",onClick:()=>Ce(!1)}),e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 animate-in",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("div",{className:"w-10 h-10 rounded-xl bg-red-100 flex items-center justify-center",children:e.jsx(ot,{className:"w-5 h-5 text-red-600"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-display font-bold text-slate-900",children:"Supprimer le ticket"}),e.jsx("p",{className:"text-sm text-slate-500",children:a.ticket_code})]})]}),e.jsx("p",{className:"text-sm text-slate-600 mb-4",children:"Cette action est irrÃ©versible. Toutes les donnÃ©es liÃ©es (notes, commandes, historique) seront supprimÃ©es."}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"input-label",children:"Code administrateur"}),e.jsx("input",{type:"password",value:ke,onChange:t=>{Ve(t.target.value),Se("")},onKeyDown:t=>t.key==="Enter"&&Xe(),className:"input",placeholder:"Entrez le code admin",autoFocus:!0}),Ye&&e.jsx("p",{className:"text-xs text-red-500 mt-1 font-medium",children:Ye})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>Ce(!1),className:"btn-ghost flex-1",children:"Annuler"}),e.jsx("button",{onClick:Xe,disabled:He||!ke,className:"flex-1 py-2.5 px-4 rounded-xl bg-red-600 hover:bg-red-700 text-white text-sm font-semibold transition-colors disabled:opacity-50 flex items-center justify-center gap-2",children:He?"Suppression...":"Supprimer"})]})]})})]}),e.jsxs("div",{className:"px-4 sm:px-6 lg:px-8",children:[(()=>{const t=me.filter(n=>n.important);return!kt&&t.length===0?null:(t.length>0&&t[0],e.jsxs("div",{className:"flex items-start gap-3 p-4 mb-5 rounded-xl bg-red-50 border border-red-200 shadow-sm animate-in",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-red-500 flex items-center justify-center shrink-0",children:e.jsx(Re,{className:"w-5 h-5 text-white"})}),e.jsxs("div",{className:"flex-1 min-w-0 space-y-1",children:[e.jsx("p",{className:"text-sm font-bold text-red-800",children:"Note importante"}),t.map(n=>e.jsx("p",{className:"text-sm text-red-700",children:n.contenu.replace(/^\[ATTENTION\]\s*âš ?\s*/i,"")},n.id)),t.length===0&&a.attention&&e.jsx("p",{className:"text-sm text-red-700",children:a.attention})]}),e.jsx("button",{onClick:()=>Oe(!1),className:"shrink-0 p-1 rounded-lg text-red-300 hover:text-red-600 hover:bg-red-100 transition-colors",children:e.jsx(Y,{className:"w-4 h-4"})})]}))})(),e.jsx("div",{className:"card p-5 mb-6",children:e.jsx(ss,{statut:a.statut,hasPiece:a.commande_piece===1})}),e.jsxs("div",{className:"flex items-center gap-2 mb-5",children:[e.jsxs("button",{onClick:()=>Ue(!Q),className:`flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-medium transition-colors ${Q?"bg-brand-600 text-white":"bg-slate-100 text-slate-600 hover:bg-slate-200"}`,children:[e.jsx(je,{className:"w-3.5 h-3.5"}),Q?"Mode Ã©dition":"Personnaliser"]}),Q&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:$t,className:"btn-primary text-xs px-3 py-1.5",children:[e.jsx(Le,{className:"w-3.5 h-3.5"})," Sauver"]}),e.jsx("button",{onClick:Mt,className:"btn-ghost text-xs px-3 py-1.5",children:"RÃ©initialiser"})]})]}),Q&&e.jsx("div",{className:"p-3 mb-5 rounded-lg bg-brand-50 border border-brand-200 text-xs text-brand-700",children:"Glissez-dÃ©posez les blocs pour rÃ©organiser. Cliquez S/M/L pour changer la taille, les flÃ¨ches pour dÃ©placer entre colonnes."}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-[55fr_45fr] gap-5",children:[e.jsx("div",{className:"space-y-5",children:_e.filter(t=>t.col==="left").sort((t,n)=>t.order-n.order).map(lt)}),e.jsx("div",{className:"space-y-5",children:_e.filter(t=>t.col==="right").sort((t,n)=>t.order-n.order).map(lt)})]})]}),e.jsx("div",{className:"mt-10 mb-4 text-center",children:e.jsx("button",{onClick:()=>{Ce(!0),Ve(""),Se("")},className:"text-xs text-slate-400 hover:text-red-500 transition-colors",children:"Supprimer ce ticket"})}),e.jsx(Ns,{open:q,onClose:()=>ze(!1),ticketId:u,ticketCode:a.ticket_code,clientTel:a.client_tel,clientEmail:a.client_email})]})}export{Ms as default};
