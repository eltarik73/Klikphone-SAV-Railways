import{u as q,a as k,j as e,b as H,f as N,c as i,i as v}from"./index-C8sCjayU.js";import{u as J,r as n}from"./vendor-react-DWtYaMjq.js";import{P as S,G as O,S as Q,a9 as V,an as W,X as Y,ag as Z,a3 as ee,z as se,af as te,q as ae}from"./vendor-icons-DOkFSV4b.js";const P=["En attente","Commandée","Expédiée","Reçue","Annulée","Récupérée par client","Utilisée en réparation"],E=["Reçue","Annulée","Récupérée par client","Utilisée en réparation"];function ce(){const T=J(),{user:h}=q(),R=(h==null?void 0:h.target)==="tech"?"/tech":"/accueil",[p,A]=n.useState(""),[o,$]=n.useState(""),[r,g]=n.useState("en_cours"),m=n.useRef(null),[F,b]=n.useState(!1),[u,w]=n.useState(null),[d,c]=n.useState(null),[a,l]=n.useState({description:"",fournisseur:"",reference:"",prix:"",ticket_code:"",statut:"En attente",notes:""});n.useEffect(()=>(m.current&&clearTimeout(m.current),m.current=setTimeout(()=>$(p),300),()=>clearTimeout(m.current)),[p]),n.useEffect(()=>{if(!d)return;const s=setTimeout(()=>c(null),3e3);return()=>clearTimeout(s)},[d]);const D=n.useMemo(()=>{const s=["commandes"];return o&&s.push(`s:${o}`),s.push(`tab:${r}`),s.join(":")},[o,r]),{data:U,loading:M}=k(D,async()=>{const s={};return o&&(s.search=o),r==="en_cours"?s.statut="en_cours":r==="cloturees"&&(s.statut="cloturees"),i.getParts(s)},{tags:["commandes"],ttl:6e4}),C=U??[],{data:z}=k("commandes:all:counts",()=>i.getParts({}),{tags:["commandes"],ttl:6e4}),j=z??[],y=j.filter(s=>!E.includes(s.statut)).length,_=j.filter(s=>E.includes(s.statut)).length,f=()=>{l({description:"",fournisseur:"",reference:"",prix:"",ticket_code:"",statut:"En attente",notes:""}),w(null),b(!1)},I=async()=>{try{const s={...a,prix:a.prix?parseFloat(a.prix):null};u?(await i.updatePart(u.id,s),c({type:"success",msg:"Commande mise à jour"})):(await i.createPart(s),c({type:"success",msg:"Commande créée"})),f(),v("commandes")}catch(s){console.error(s),c({type:"error",msg:"Erreur lors de la sauvegarde"})}},B=s=>{w(s),l({description:s.description||"",fournisseur:s.fournisseur||"",reference:s.reference||"",prix:s.prix||"",ticket_code:s.ticket_code||"",statut:s.statut||"En attente",notes:s.notes||""}),b(!0)},G=async s=>{if(confirm("Supprimer cette commande ?"))try{await i.deletePart(s),v("commandes"),c({type:"success",msg:"Commande supprimée"})}catch(t){console.error(t)}},K=async(s,t)=>{try{await i.updatePart(s.id,{statut:t}),v("commandes"),c({type:"success",msg:`Statut → ${t}`})}catch(X){console.error(X),c({type:"error",msg:"Erreur changement statut"})}},L=async s=>{try{const t=await i.getTicketByCode(s);t!=null&&t.id&&T(`${R}/ticket/${t.id}`)}catch{}},x=s=>{switch(s){case"En attente":return"#d97706";case"Commandée":return"#2563eb";case"Expédiée":return"#7c3aed";case"Reçue":return"#059669";case"Annulée":return"#dc2626";case"Récupérée par client":return"#0891b2";case"Utilisée en réparation":return"#4f46e5";default:return"#64748b"}};return e.jsxs("div",{className:"p-4 sm:p-6 lg:p-8",children:[d&&e.jsx("div",{className:`fixed top-4 right-4 z-[100] px-4 py-2.5 rounded-xl shadow-lg text-sm font-medium animate-in
          ${d.type==="success"?"bg-emerald-600 text-white":"bg-red-600 text-white"}`,children:d.msg}),e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-6",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-2xl font-display font-bold text-slate-900 tracking-tight flex items-center gap-2",children:[e.jsx(S,{className:"w-6 h-6 text-brand-600"})," Commandes de pièces"]}),e.jsxs("p",{className:"text-sm text-slate-500 mt-0.5",children:[y," en cours — ",_," clôturée(s)"]})]}),e.jsxs("button",{onClick:()=>{f(),b(!0)},className:"btn-primary",children:[e.jsx(O,{className:"w-4 h-4"})," Nouvelle commande"]})]}),e.jsxs("div",{className:"card overflow-hidden mb-6",children:[e.jsx("div",{className:"p-3 sm:p-4 border-b border-slate-100",children:e.jsxs("div",{className:"relative",children:[e.jsx(Q,{className:"absolute left-3.5 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"}),e.jsx("input",{type:"text",placeholder:"Rechercher par désignation, fournisseur, référence, ticket...",value:p,onChange:s=>A(s.target.value),className:"w-full pl-10 pr-4 py-2.5 rounded-lg border border-slate-200 bg-slate-50/50 text-sm placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-brand-500/20 focus:border-brand-500 focus:bg-white transition-all"})]})}),e.jsxs("div",{className:"px-3 sm:px-4 py-2 flex gap-1 overflow-x-auto scrollbar-none bg-slate-50/50",children:[e.jsxs("button",{onClick:()=>g("en_cours"),className:`px-4 py-1.5 rounded-md text-xs font-medium whitespace-nowrap transition-all flex items-center gap-1.5
              ${r==="en_cours"?"bg-brand-600 text-white shadow-sm":"text-slate-500 hover:bg-white hover:shadow-sm"}`,children:[e.jsx(V,{className:"w-3.5 h-3.5"})," En cours (",y,")"]}),e.jsxs("button",{onClick:()=>g("cloturees"),className:`px-4 py-1.5 rounded-md text-xs font-medium whitespace-nowrap transition-all flex items-center gap-1.5
              ${r==="cloturees"?"bg-brand-600 text-white shadow-sm":"text-slate-500 hover:bg-white hover:shadow-sm"}`,children:[e.jsx(W,{className:"w-3.5 h-3.5"})," Clôturées (",_,")"]}),e.jsxs("button",{onClick:()=>g("toutes"),className:`px-4 py-1.5 rounded-md text-xs font-medium whitespace-nowrap transition-all flex items-center gap-1.5
              ${r==="toutes"?"bg-brand-600 text-white shadow-sm":"text-slate-500 hover:bg-white hover:shadow-sm"}`,children:["Toutes (",j.length,")"]})]})]}),F&&e.jsxs("div",{className:"card p-5 mb-6 border-brand-200 animate-in",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-sm font-semibold text-slate-800",children:u?"Modifier la commande":"Nouvelle commande"}),e.jsx("button",{onClick:f,className:"btn-ghost p-1.5",children:e.jsx(Y,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"col-span-2 sm:col-span-1",children:[e.jsx("label",{className:"input-label",children:"Désignation *"}),e.jsx("input",{value:a.description,onChange:s=>l(t=>({...t,description:s.target.value})),className:"input",placeholder:"Écran iPhone 15..."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"input-label",children:"Fournisseur"}),e.jsx("input",{value:a.fournisseur,onChange:s=>l(t=>({...t,fournisseur:s.target.value})),className:"input",placeholder:"Nom fournisseur"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"input-label",children:"Référence"}),e.jsx("input",{value:a.reference,onChange:s=>l(t=>({...t,reference:s.target.value})),className:"input font-mono",placeholder:"REF-001"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"input-label",children:"Prix (€)"}),e.jsx("input",{type:"number",step:"0.01",value:a.prix,onChange:s=>l(t=>({...t,prix:s.target.value})),className:"input"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"input-label",children:"Ticket associé"}),e.jsx("input",{value:a.ticket_code,onChange:s=>l(t=>({...t,ticket_code:s.target.value})),className:"input font-mono",placeholder:"KP-000001"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"input-label",children:"Statut"}),e.jsx("select",{value:a.statut,onChange:s=>l(t=>({...t,statut:s.target.value})),className:"input",children:P.map(s=>e.jsx("option",{value:s,children:s},s))})]}),e.jsxs("div",{className:"col-span-2 sm:col-span-3",children:[e.jsx("label",{className:"input-label",children:"Notes"}),e.jsx("input",{value:a.notes,onChange:s=>l(t=>({...t,notes:s.target.value})),className:"input",placeholder:"Notes..."})]})]}),e.jsx("div",{className:"flex justify-end mt-4 pt-3 border-t border-slate-100",children:e.jsxs("button",{onClick:I,disabled:!a.description,className:"btn-primary",children:[e.jsx(Z,{className:"w-4 h-4"})," ",u?"Mettre à jour":"Créer"]})})]}),e.jsxs("div",{className:"card overflow-hidden",children:[e.jsxs("div",{className:"hidden lg:grid grid-cols-[1fr_130px_140px_120px_90px_120px_160px_80px] gap-3 items-center px-5 py-3 bg-slate-50/80 border-b border-slate-100",children:[e.jsx("span",{className:"table-header",children:"Désignation"}),e.jsx("span",{className:"table-header",children:"Client"}),e.jsx("span",{className:"table-header",children:"Fournisseur"}),e.jsx("span",{className:"table-header",children:"Référence"}),e.jsx("span",{className:"table-header",children:"Prix"}),e.jsx("span",{className:"table-header",children:"Dates"}),e.jsx("span",{className:"table-header",children:"Statut"}),e.jsx("span",{className:"table-header text-right",children:"Actions"})]}),M?e.jsxs("div",{className:"py-16 text-center",children:[e.jsx("div",{className:"w-8 h-8 border-2 border-brand-600 border-t-transparent rounded-full animate-spin mx-auto mb-3"}),e.jsx("p",{className:"text-sm text-slate-400",children:"Chargement..."})]}):C.length===0?e.jsxs("div",{className:"py-16 text-center",children:[e.jsx("div",{className:"w-14 h-14 rounded-2xl bg-slate-100 flex items-center justify-center mx-auto mb-4",children:e.jsx(S,{className:"w-7 h-7 text-slate-300"})}),e.jsx("p",{className:"text-slate-500 font-medium",children:"Aucune commande"}),e.jsx("p",{className:"text-sm text-slate-400 mt-1",children:r==="en_cours"?"Aucune commande en cours":r==="cloturees"?"Aucune commande clôturée":"Créez votre première commande de pièce"})]}):e.jsx("div",{className:"divide-y divide-slate-100/80",children:C.map(s=>e.jsxs("div",{className:"lg:grid lg:grid-cols-[1fr_130px_140px_120px_90px_120px_160px_80px] gap-3 items-center px-4 sm:px-5 py-3.5 hover:bg-slate-50 transition-colors",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-semibold text-slate-800",children:s.description}),s.ticket_code&&e.jsxs("button",{onClick:()=>L(s.ticket_code),className:"text-xs text-brand-600 font-mono hover:text-brand-800 hover:underline flex items-center gap-1",children:[s.ticket_code," ",e.jsx(ee,{className:"w-2.5 h-2.5"})]}),s.notes&&e.jsx("p",{className:"text-xs text-slate-400 mt-0.5 truncate",children:s.notes})]}),e.jsxs("div",{className:"hidden lg:block",children:[e.jsxs("p",{className:"text-sm text-slate-700 truncate",children:[s.client_prenom||""," ",s.client_nom||""]}),s.client_tel&&e.jsx("p",{className:"text-[11px] text-slate-400 font-mono",children:s.client_tel})]}),e.jsx("div",{className:"hidden lg:block",children:e.jsx("p",{className:"text-sm text-slate-600",children:s.fournisseur||"—"})}),e.jsx("div",{className:"hidden lg:block",children:e.jsx("p",{className:"text-xs text-slate-500 font-mono",children:s.reference||"—"})}),e.jsx("div",{className:"hidden lg:block",children:e.jsx("p",{className:"text-sm font-medium text-slate-800",children:s.prix?H(s.prix):"—"})}),e.jsxs("div",{className:"hidden lg:block",children:[e.jsxs("p",{className:"text-[11px] text-slate-500",children:[e.jsx(se,{className:"w-3 h-3 inline mr-0.5"}),s.date_creation?N(s.date_creation):"—"]}),s.date_commande&&e.jsxs("p",{className:"text-[10px] text-blue-500",children:["Cmd: ",N(s.date_commande)]}),s.date_reception&&e.jsxs("p",{className:"text-[10px] text-emerald-500",children:["Reçue: ",N(s.date_reception)]})]}),e.jsx("div",{className:"mt-2 lg:mt-0",onClick:t=>t.stopPropagation(),children:e.jsx("select",{value:s.statut,onChange:t=>K(s,t.target.value),className:"w-full py-1.5 px-2 text-[11px] font-semibold rounded-lg border-2 cursor-pointer appearance-none bg-no-repeat truncate",style:{borderColor:x(s.statut),color:x(s.statut),backgroundColor:x(s.statut)+"10",backgroundImage:`url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 24 24' fill='none' stroke='${encodeURIComponent(x(s.statut))}' stroke-width='2'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E")`,backgroundPosition:"right 4px center",backgroundSize:"14px",paddingRight:"22px"},children:P.map(t=>e.jsx("option",{value:t,children:t},t))})}),e.jsxs("div",{className:"hidden lg:flex justify-end gap-1",children:[e.jsx("button",{onClick:()=>B(s),className:"btn-ghost p-1.5",title:"Modifier",children:e.jsx(te,{className:"w-3.5 h-3.5"})}),e.jsx("button",{onClick:()=>G(s.id),className:"btn-ghost p-1.5",title:"Supprimer",children:e.jsx(ae,{className:"w-3.5 h-3.5 text-red-400"})})]})]},s.id))})]})]})}export{ce as default};
